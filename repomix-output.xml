This file is a merged representation of a subset of the codebase, containing files not matching ignore patterns, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching these patterns are excluded: **/.env**, **/node_modules/**, **/dist/**, **/coverage/**, **/.git/**, **/test/**, **/*.spec.ts, **/*.test.ts, **/*.lock, **/README.md, **/.gitignore
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.prettierrc
.syncignore
docker-compose.yml
eslint.config.mjs
nest-cli.json
package.json
reset-db.sh
src/address/address-draft.controller.ts
src/address/address-draft.service.ts
src/address/address.controller.ts
src/address/address.module.ts
src/address/address.service.ts
src/address/dto/create-address.dto.ts
src/address/dto/update-address.dto.ts
src/address/entities/address.entity.ts
src/address/enums/addressStatus.enum.ts
src/address/enums/addressType.enum.ts
src/address/enums/index.ts
src/address/enums/residenceType.enum.ts
src/app.module.ts
src/app/core/api/api.types.ts
src/auth/auth.controller.ts
src/auth/auth.module.ts
src/auth/auth.service.ts
src/auth/decorators/auth.decorator.ts
src/auth/decorators/get-user.decorator.ts
src/auth/decorators/roles.decorator.ts
src/auth/decorators/user.decorator.ts
src/auth/dto/index.ts
src/auth/dto/login.dto.ts
src/auth/dto/refresh-token.dto.ts
src/auth/dto/tokens.dto.ts
src/auth/enums/user-global-role.enum.ts
src/auth/guards/jwt-auth.guard.ts
src/auth/guards/local-auth.guard.ts
src/auth/guards/roles.guard.ts
src/auth/strategies/jwt-refresh.strategy.ts
src/auth/strategies/jwt.strategy.ts
src/auth/strategies/local.strategy.ts
src/billing-concept/billing-concept.controller.ts
src/billing-concept/billing-concept.module.ts
src/billing-concept/billing-concept.service.ts
src/billing-concept/dto/create-billing-concept.dto.ts
src/billing-concept/dto/update-billing-concept.dto.ts
src/billing-concept/entities/billing-concept.entity.ts
src/client-profile/client-profile.controller.ts
src/client-profile/client-profile.module.ts
src/client-profile/client-profile.service.ts
src/client-profile/dto/create-client-profile.dto.ts
src/client-profile/dto/update-client-profile.dto.ts
src/client-profile/entities/client-profile.entity.ts
src/client/client.controller.ts
src/client/client.module.ts
src/client/client.service.ts
src/client/dto/create-client.dto.ts
src/client/dto/update-client.dto.ts
src/client/entities/client.entity.ts
src/common/base/base.entity.ts
src/common/base/tenant-scoped.entity.ts
src/common/catalogs/taxes/base/fiscal-rate.entity.ts
src/common/catalogs/taxes/taxes.module.ts
src/common/catalogs/taxes/vat-rate/dto/create-vat-rate.dto.ts
src/common/catalogs/taxes/vat-rate/dto/insex.ts
src/common/catalogs/taxes/vat-rate/dto/update-vat-rate.dto.ts
src/common/catalogs/taxes/vat-rate/vat-rate.controller.ts
src/common/catalogs/taxes/vat-rate/vat-rate.entity.ts
src/common/catalogs/taxes/vat-rate/vat-rate.module.ts
src/common/catalogs/taxes/vat-rate/vat-rate.service.ts
src/common/catalogs/taxes/withholding-rate/dto/create-withholding-rate.dto.ts
src/common/catalogs/taxes/withholding-rate/dto/index.ts
src/common/catalogs/taxes/withholding-rate/dto/update-withholding-rate.dto.ts
src/common/catalogs/taxes/withholding-rate/withholding-rate.controller.ts
src/common/catalogs/taxes/withholding-rate/withholding-rate.entity.ts
src/common/catalogs/taxes/withholding-rate/withholding-rate.module.ts
src/common/catalogs/taxes/withholding-rate/withholding-rate.service.ts
src/common/common.module.ts
src/company-context/company-context.controller.ts
src/company-context/company-context.module.ts
src/company-context/company-context.service.ts
src/company-context/dto/select-company.dto.ts
src/company/company.controller.ts
src/company/company.module.ts
src/company/company.service.ts
src/company/dto/company-me.dto.ts
src/company/dto/createCompany.dto.ts
src/company/dto/createCompanyLegal.dto.ts
src/company/dto/index.ts
src/company/dto/updateCompany.dto.ts
src/company/entities/company.entity.ts
src/config/config.module.ts
src/config/configuration.ts
src/config/seeder.module.ts
src/config/seeder.service.ts
src/config/validation.ts
src/contact/contact.controller.ts
src/contact/contact.module.ts
src/contact/contact.service.ts
src/contact/dto/create-contact.dto.ts
src/contact/dto/update-contact.dto.ts
src/contact/entities/contact.entity.ts
src/contract/contract.controller.ts
src/contract/contract.module.ts
src/contract/contract.service.ts
src/contract/dto/create-contract.dto.ts
src/contract/dto/index.ts
src/contract/dto/update-contract.dto.ts
src/contract/entities/contract.entity.ts
src/contract/enums/billing-period.enum.ts
src/contract/enums/contract-status.enum.ts
src/contract/enums/contract-type.enum.ts
src/contract/enums/index.ts
src/contract/enums/payment-method.enum.ts
src/facturae/dto/create-fiscalIdentity.dto.ts
src/facturae/entities/fiscalIdentity.entity.ts
src/facturae/enums/index.ts
src/facturae/enums/personType.enum.ts
src/facturae/enums/residenceType.enum.ts
src/facturae/enums/subjectType.enum.ts
src/facturae/enums/taxIdTtype.enum.ts
src/facturae/enums/taxRegimeType.enum.ts
src/facturae/fiscalIdentity.controller.ts
src/facturae/fiscalIdentity.module.ts
src/facturae/fiscalIdentity.service.ts
src/health/health.controller.ts
src/health/health.module.ts
src/health/health.service.ts
src/i18n/i18n.module.ts
src/i18n/translations/es/errors.json
src/i18n/translations/es/validation.json
src/main.ts
src/property/dto/create-property.dto.ts
src/property/dto/index.ts
src/property/dto/update-property.dto.ts
src/property/entities/property.entity.ts
src/property/enums/index.ts
src/property/enums/property-status.enum.ts
src/property/enums/property-type.enum.ts
src/property/property.controller.ts
src/property/property.module.ts
src/property/property.service.ts
src/tax/dto/create-tax.dto.ts
src/tax/dto/update-tax.dto.ts
src/tax/entities/tax.entity.ts
src/tax/tax.controller.ts
src/tax/tax.module.ts
src/tax/tax.service.ts
src/user-company-role/companyRole.controller.ts
src/user-company-role/companyRole.module.ts
src/user-company-role/companyRole.service.ts
src/user-company-role/dto/createUuserCompanyRole.dto.ts
src/user-company-role/dto/index.ts
src/user-company-role/dto/updateUserCompanyRole.dto.ts
src/user-company-role/entities/userCompanyRole.entity.ts
src/user-company-role/enums/companyRole.enum.ts
src/user/dto/create-user.dto.ts
src/user/dto/me.dto.ts
src/user/dto/update-user.dto.ts
src/user/dto/user.dto.ts
src/user/entities/user.entity.ts
src/user/user.controller.ts
src/user/user.module.ts
src/user/user.service.ts
tsconfig.build.json
tsconfig.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="src/billing-concept/billing-concept.controller.ts">
import { Controller, Get, Post, Body, Patch, Param, Delete, ParseUUIDPipe, UseGuards } from '@nestjs/common';
import { ApiTags, ApiOperation, ApiBearerAuth, ApiResponse } from '@nestjs/swagger';
import { BillingConceptService } from './billing-concept.service';
import { CreateBillingConceptDto } from './dto/create-billing-concept.dto';
import { UpdateBillingConceptDto } from './dto/update-billing-concept.dto';
import { BillingConcept } from './entities/billing-concept.entity';
// Importaci贸n de tus Enums reales
import { AppRole } from '../auth/enums/user-global-role.enum';
import { CompanyRole } from '../user-company-role/enums/companyRole.enum';
import { Roles } from 'src/auth/decorators/roles.decorator';

@ApiTags('Billing Concepts')
@ApiBearerAuth()
@Controller('billing-concept')
export class BillingConceptController {
  constructor(private readonly service: BillingConceptService) {}

  @Post()
  @Roles(AppRole.SUPERADMIN, AppRole.ADMIN, 
    
    
    
    
    CompanyRole.ADMIN)
  @ApiOperation({ summary: 'Crear concepto en el cat谩logo maestro' })
  @ApiResponse({ status: 201, type: BillingConcept })
  create(@Body() createDto: CreateBillingConceptDto) {
    return this.service.create(createDto);
  }

  @Get()
  @Roles(AppRole.SUPERADMIN, AppRole.ADMIN, AppRole.USER, CompanyRole.OWNER, CompanyRole.ADMIN, CompanyRole.MANAGER, CompanyRole.VIEWER)
  @ApiOperation({ summary: 'Listar cat谩logo (Accesible para todos los roles de lectura)' })
  @ApiResponse({ status: 200, type: [BillingConcept] })
  findAll() {
    return this.service.findAll();


    
  }

  @Patch(':id')
  @Roles(AppRole.SUPERADMIN, AppRole.ADMIN, CompanyRole.OWNER, CompanyRole.ADMIN)
  @ApiOperation({ summary: 'Actualizar plantilla de concepto' })
  @ApiResponse({ status: 200, type: BillingConcept })
  update(@Param('id', ParseUUIDPipe) id: string, @Body() updateDto: UpdateBillingConceptDto) {
    return this.service.update(id, updateDto);
  }

  @Delete(':id')
  @Roles(AppRole.SUPERADMIN, CompanyRole.OWNER)
  @ApiOperation({ summary: 'Soft Delete de un concepto (Solo SuperAdmin u Owner)' })
  @ApiResponse({ status: 204 })
  remove(@Param('id', ParseUUIDPipe) id: string) {
    return this.service.remove(id);
  }
}
</file>

<file path="src/billing-concept/billing-concept.module.ts">
import { Module } from '@nestjs/common';
import { BillingConceptService } from './billing-concept.service';
import { BillingConceptController } from './billing-concept.controller';
import { BillingConcept } from './entities/billing-concept.entity';
import { TypeOrmModule } from '@nestjs/typeorm';
import { TaxModule } from 'src/tax/tax.module';

@Module({
  imports: [
  TypeOrmModule.forFeature([BillingConcept]),
  TaxModule, 
  ],
  controllers: [BillingConceptController],
  providers: [BillingConceptService],
  exports: [BillingConceptService],
})
export class BillingConceptModule {}
</file>

<file path="src/billing-concept/billing-concept.service.ts">
import { Injectable, NotFoundException } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository, DeepPartial } from 'typeorm';
import { CreateBillingConceptDto } from './dto/create-billing-concept.dto';
import { UpdateBillingConceptDto } from './dto/update-billing-concept.dto';
import { BillingConcept } from './entities/billing-concept.entity';
import { Tax } from '../tax/entities/tax.entity';

@Injectable()
export class BillingConceptService {
  constructor(
    @InjectRepository(BillingConcept)
    private readonly conceptRepository: Repository<BillingConcept>,
  ) {}

  async create(dto: CreateBillingConceptDto): Promise<BillingConcept> {
    // Construimos el objeto de forma que TypeORM lo entienda perfectamente
    const conceptData: DeepPartial<BillingConcept> = {
      name: dto.name,
      label: dto.label,
      defaultPrice: dto.defaultPrice,
      requiresPeriod: dto.requiresPeriod,
      isUniquePerPeriod: dto.isUniquePerPeriod,
      itemType: dto.itemType,
      // Asignamos el objeto con el ID, no solo el string
      defaultTax: { id: dto.defaultTaxId } as Tax,
      // Manejamos el opcional evitando el null si no viene
      ...(dto.defaultRetentionId && { defaultRetention: { id: dto.defaultRetentionId } as Tax })
    };

    const concept = this.conceptRepository.create(conceptData);
    return await this.conceptRepository.save(concept);
  }

  async findAll(): Promise<BillingConcept[]> {
    return await this.conceptRepository.find({
      order: { name: 'ASC' }
    });
  }

  async findOne(id: string): Promise<BillingConcept> {
    const concept = await this.conceptRepository.findOne({
      where: { id }
    });
    if (!concept) throw new NotFoundException(`Concepto ${id} no encontrado`);
    return concept;
  }

  async update(id: string, dto: UpdateBillingConceptDto): Promise<BillingConcept> {
    const concept = await this.findOne(id);
    
    // Preparamos los datos de actualizaci贸n
    const updateData: DeepPartial<BillingConcept> = { ...dto };
    
    if (dto.defaultTaxId) {
      updateData.defaultTax = { id: dto.defaultTaxId } as Tax;
    }
    
    if (dto.defaultRetentionId) {
      updateData.defaultRetention = { id: dto.defaultRetentionId } as Tax;
    }

    const merged = this.conceptRepository.merge(concept, updateData);
    return await this.conceptRepository.save(merged);
  }

  async remove(id: string): Promise<void> {
    const concept = await this.findOne(id);
    await this.conceptRepository.softRemove(concept);
  }

  async getCatalogList(): Promise<Partial<BillingConcept>[]> {
    return await this.conceptRepository.find({
      select: {
        id: true,
        name: true,
        label: true,
        defaultPrice: true
      }
    });
  }
}
</file>

<file path="src/billing-concept/dto/create-billing-concept.dto.ts">
import { ApiProperty, ApiPropertyOptional } from '@nestjs/swagger';
import { IsString, IsNumber, IsBoolean, IsEnum, IsOptional, IsUUID } from 'class-validator';

export class CreateBillingConceptDto {
  @ApiProperty({ example: 'RENTA' })
  @IsString()
  name: string;

  @ApiProperty({ example: 'Alquiler mensual' })
  @IsString()
  label: string;

  @ApiPropertyOptional({ example: 1200.00 })
  @IsNumber()
  @IsOptional()
  defaultPrice?: number;

  @ApiPropertyOptional({ example: true })
  @IsBoolean()
  @IsOptional()
  requiresPeriod?: boolean;

  @ApiPropertyOptional({ example: true })
  @IsBoolean()
  @IsOptional()
  isUniquePerPeriod?: boolean;

  @ApiProperty({ example: 'S', enum: ['P', 'S'] })
  @IsEnum(['P', 'S'])
  itemType: string;

  @ApiProperty({ example: 'uuid-del-iva' })
  @IsUUID()
  defaultTaxId: string;

  @ApiPropertyOptional({ example: 'uuid-del-irpf' })
  @IsUUID()
  @IsOptional()
  defaultRetentionId?: string;
}
</file>

<file path="src/billing-concept/dto/update-billing-concept.dto.ts">
import { PartialType } from '@nestjs/swagger';
import { CreateBillingConceptDto } from './create-billing-concept.dto';

export class UpdateBillingConceptDto extends PartialType(CreateBillingConceptDto) {}
</file>

<file path="src/billing-concept/entities/billing-concept.entity.ts">
import { Entity, Column, PrimaryGeneratedColumn, ManyToOne, JoinColumn, CreateDateColumn, UpdateDateColumn, DeleteDateColumn } from 'typeorm';
import { ApiProperty } from '@nestjs/swagger';
import { Tax } from '../../tax/entities/tax.entity';

@Entity('billing_concepts')
export class BillingConcept {
  @ApiProperty({ example: 'uuid-concept' })
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @ApiProperty({ example: 'RENTA' })
  @Column({ unique: true })
  name: string;

  @ApiProperty({ example: 'Arrendamiento mensual local' })
  @Column()
  label: string;

  @ApiProperty({ example: 1000.00 })
  @Column({ type: 'decimal', precision: 12, scale: 2, default: 0 })
  defaultPrice: number;

  @ApiProperty({ example: true })
  @Column({ default: true })
  isPriceEditable: boolean;

  @ApiProperty({ example: true })
  @Column({ default: false })
  requiresPeriod: boolean;

  @ApiProperty({ example: true })
  @Column({ default: false })
  isUniquePerPeriod: boolean;

  @ApiProperty({ example: 'S', enum: ['P', 'S'] })
  @Column({ type: 'varchar', length: 1, default: 'S' })
  itemType: string;

  // Relaciones con Eager Loading para que el Front reciba el objeto Tax completo
  @ManyToOne(() => Tax, { eager: true, nullable: false })
  @JoinColumn({ name: 'default_tax_id' })
  defaultTax: Tax;

  @ManyToOne(() => Tax, { eager: true, nullable: true })
  @JoinColumn({ name: 'default_retention_id' })
  defaultRetention: Tax;

  @CreateDateColumn()
  createdAt: Date;

  @UpdateDateColumn()
  updatedAt: Date;

  @ApiProperty({ description: 'Fecha de borrado l贸gico' })
  @DeleteDateColumn()
  deletedAt: Date;
}
</file>

<file path="src/contract/enums/payment-method.enum.ts">
export enum PaymentMethod {
  EFECTIVO = '01',
  TRANSFERENCIA = '02',
  DOMICILIACION = '03', // El m谩s com煤n para alquileres (Adeudo SEPA)
  TARJETA = '04',
  CHEQUE = '08',
  COMPENSACION = '09',  // Por si se compensan deudas
  OTRO = '99',
}
</file>

<file path="src/tax/dto/create-tax.dto.ts">
import { ApiProperty, ApiPropertyOptional } from '@nestjs/swagger';
import { IsString, IsNumber, IsBoolean, IsEnum, IsOptional, Min, Max, Length } from 'class-validator';

export class CreateTaxDto {
  @ApiProperty({ example: 'IVA 21%', minLength: 3, maxLength: 50 })
  @IsString()
  @Length(3, 50)
  name: string;

  @ApiProperty({ example: 21.00, minimum: 0, maximum: 100 })
  @IsNumber()
  @Min(0)
  @Max(100)
  rate: number;

  @ApiProperty({ example: '01', enum: ['01', '02', '03', '04', '05'] })
  @IsEnum(['01', '02', '03', '04', '05'])
  taxType: string;

  @ApiPropertyOptional({ example: false, default: false })
  @IsBoolean()
  @IsOptional()
  isRetention?: boolean;

  @ApiPropertyOptional({ example: 'Art. 20.1.23' })
  @IsString()
  @IsOptional()
  facturaeCode?: string;
}
</file>

<file path="src/tax/dto/update-tax.dto.ts">
import { PartialType } from '@nestjs/swagger';
import { CreateTaxDto } from './create-tax.dto';

export class UpdateTaxDto extends PartialType(CreateTaxDto) {}
</file>

<file path="src/tax/entities/tax.entity.ts">
import { Entity, Column, PrimaryGeneratedColumn, CreateDateColumn } from 'typeorm';
import { ApiProperty } from '@nestjs/swagger';

@Entity('taxes')
export class Tax {
  @ApiProperty({ example: '550e8400-e29b-41d4-a716-446655440000', description: 'ID 煤nico UUID' })
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @ApiProperty({ example: 'IVA 21%', description: 'Nombre descriptivo del impuesto' })
  @Column({ unique: true, length: 50 })
  name: string;

  @ApiProperty({ example: 21.00, description: 'Porcentaje del impuesto' })
  @Column({ type: 'decimal', precision: 5, scale: 2, transformer: {
    to: (value: number) => value,
    from: (value: string) => parseFloat(value),
  }})
  rate: number;

  @ApiProperty({ example: '01', enum: ['01', '02', '03', '04', '05'], description: 'C贸digo oficial Facturae (01=IVA, 04=IRPF)' })
  @Column({ type: 'varchar', length: 2, default: '01' })
  taxType: string;

  @ApiProperty({ example: false, description: 'Si es true, el valor resta del total (Retenci贸n)' })
  @Column({ default: false })
  isRetention: boolean;

  @ApiProperty({ example: 'Exento por Art. 20', required: false, description: 'C贸digo o motivo de exenci贸n legal' })
  @Column({ nullable: true })
  facturaeCode: string;

  @ApiProperty({ example: true })
  @Column({ default: true })
  isActive: boolean;

  @ApiProperty()
  @CreateDateColumn()
  createdAt: Date;
}
</file>

<file path="src/tax/tax.controller.ts">
import { Controller, Get, Post, Body, Patch, Param, Delete } from '@nestjs/common';
import { ApiTags, ApiOperation, ApiResponse } from '@nestjs/swagger';
import { TaxService } from './tax.service';
import { CreateTaxDto } from './dto/create-tax.dto';
import { UpdateTaxDto } from './dto/update-tax.dto';
import { Tax } from './entities/tax.entity';

@ApiTags('Taxes') // Agrupa en Swagger
@Controller('tax')
export class TaxController {
  constructor(private readonly taxService: TaxService) {}

  @Post()
  @ApiOperation({ summary: 'Crear un nuevo impuesto' })
  @ApiResponse({ status: 201, type: Tax })
  create(@Body() createTaxDto: CreateTaxDto) {
    return this.taxService.create(createTaxDto);
  }

  @Get()
  @ApiOperation({ summary: 'Listar todos los impuestos activos' })
  @ApiResponse({ status: 200, type: [Tax] })
  findAll() {
    return this.taxService.findAll();
  }

  @Get(':id')
  @ApiOperation({ summary: 'Obtener un impuesto por ID' })
  @ApiResponse({ status: 200, type: Tax })
  findOne(@Param('id') id: string) {
    return this.taxService.findOne(id);
  }
}
</file>

<file path="src/tax/tax.module.ts">
import { Module } from '@nestjs/common';
import { TaxService } from './tax.service';
import { TaxController } from './tax.controller';
import { TypeOrmModule } from '@nestjs/typeorm';
import { Tax } from './entities/tax.entity';

@Module({
  imports: [TypeOrmModule.forFeature([Tax])],
  controllers: [TaxController],
  providers: [TaxService],
  exports: [TaxService, TypeOrmModule],
})
export class TaxModule {}
</file>

<file path="src/tax/tax.service.ts">
import { Injectable, NotFoundException } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { CreateTaxDto } from './dto/create-tax.dto';
import { UpdateTaxDto } from './dto/update-tax.dto';
import { Tax } from './entities/tax.entity';

@Injectable()
export class TaxService {
  constructor(
    @InjectRepository(Tax)
    private readonly taxRepository: Repository<Tax>,
  ) {}

  async create(createTaxDto: CreateTaxDto): Promise<Tax> {
    const tax = this.taxRepository.create(createTaxDto);
    return await this.taxRepository.save(tax);
  }

  async findAll(): Promise<Tax[]> {
    return await this.taxRepository.find({
      where: { isActive: true },
      order: { name: 'ASC' },
    });
  }

  async findOne(id: string): Promise<Tax> {
    const tax = await this.taxRepository.findOneBy({ id });
    if (!tax) {
      throw new NotFoundException(`Impuesto con ID ${id} no encontrado`);
    }
    return tax;
  }

  async update(id: string, updateTaxDto: UpdateTaxDto): Promise<Tax> {
    const tax = await this.findOne(id);
    const updatedTax = this.taxRepository.merge(tax, updateTaxDto);
    return await this.taxRepository.save(updatedTax);
  }

  async remove(id: string): Promise<void> {
    const tax = await this.findOne(id);
    // Realizamos borrado l贸gico para mantener integridad en facturas hist贸ricas
    await this.taxRepository.save({ ...tax, isActive: false });
  }

  /**
   * M茅todo de utilidad para validar la existencia de impuestos
   * til cuando estemos creando conceptos o contratos
   */
  async validateTaxExists(id: string): Promise<boolean> {
    const count = await this.taxRepository.count({ where: { id, isActive: true } });
    return count > 0;
  }
}
</file>

<file path=".prettierrc">
{
  "singleQuote": true,
  "trailingComma": "all"
}
</file>

<file path=".syncignore">
node_modules/
dist/
.tmp/
.cache/
.idea/
.vscode/
coverage/
</file>

<file path="docker-compose.yml">
# api/docker-compose.yml
services:
  postgres:
    image: postgres:16
    container_name: postgres
    environment:
      POSTGRES_USER: sa
      POSTGRES_PASSWORD: Vicent@1973
      POSTGRES_DB: rentixdb
    ports: ["5432:5432"]
    volumes: [ "postgres_data:/var/lib/postgresql/data" ]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U rentix -d rentix"]
      interval: 5s
      timeout: 5s
      retries: 10
volumes: { postgres_data: {} }
</file>

<file path="eslint.config.mjs">
// @ts-check
import eslint from '@eslint/js';
import eslintPluginPrettierRecommended from 'eslint-plugin-prettier/recommended';
import globals from 'globals';
import tseslint from 'typescript-eslint';

export default tseslint.config(
  {
    ignores: ['eslint.config.mjs'],
  },
  eslint.configs.recommended,
  ...tseslint.configs.recommendedTypeChecked,
  eslintPluginPrettierRecommended,
  {
    languageOptions: {
      globals: {
        ...globals.node,
        ...globals.jest,
      },
      sourceType: 'commonjs',
      parserOptions: {
        projectService: true,
        tsconfigRootDir: import.meta.dirname,
      },
    },
  },
  {
    rules: {
      '@typescript-eslint/no-explicit-any': 'off',
      '@typescript-eslint/no-floating-promises': 'warn',
      '@typescript-eslint/no-unsafe-argument': 'warn'
    },
  },
);
</file>

<file path="nest-cli.json">
{
  "$schema": "https://json.schemastore.org/nest-cli",
  "collection": "@nestjs/schematics",
  "sourceRoot": "src",
  "compilerOptions": {
    "deleteOutDir": true,
    "assets": [
      {
        "include": "i18n/translations/**/*",
        "outDir": "dist/src"
      }
    ],
    "watchAssets": true
  }
}
</file>

<file path="reset-db.sh">
#!/bin/bash

# EJECUTAR COMANDO ==> ./reset-db.sh

set -e

echo "Ж Parando contenedores y eliminando vol煤menes..."
docker compose down -v

echo "Ч Limpiando vol煤menes Docker hu茅rfanos..."
docker volume prune -f

echo " Levantando contenedores..."
docker compose up -d

echo " Arrancando backend en modo desarrollo..."
npm run start:dev
</file>

<file path="src/address/dto/update-address.dto.ts">
import { PartialType } from '@nestjs/swagger';
import { CreateAddressDto } from './create-address.dto';

export class UpdateAddressDto extends PartialType(CreateAddressDto) {}
</file>

<file path="src/address/enums/addressStatus.enum.ts">
/**
 * Estado de la direcci贸n dentro del sistema
 *
 * - DRAFT: creada durante un wizard, a煤n no asociada a una empresa
 * - ACTIVE: direcci贸n v谩lida y operativa
 * - ARCHIVED: hist贸rica / no utilizable
 */
export enum AddressStatus {
  DRAFT = 'DRAFT',
  ACTIVE = 'ACTIVE',
  ARCHIVED = 'ARCHIVED',
}
</file>

<file path="src/address/enums/addressType.enum.ts">
/**
 * Tipos de direcci贸n soportados por el sistema.
 * Usado en DTOs y contratos OpenAPI.
 */
export enum AddressType {
  FISCAL = 'FISCAL',
  COMMERCIAL = 'COMMERCIAL',
  PROPERTY = 'PROPERTY',
  OTHER = 'OTHER',
}
</file>

<file path="src/address/enums/index.ts">
export * from './addressType.enum';
export * from './residenceType.enum';
</file>

<file path="src/address/enums/residenceType.enum.ts">
/**
 * Tipo de residencia fiscal seg煤n Facturae.
 * Utilizado en contratos OpenAPI mediante DTOs.
 */
export enum ResidenceType {
  IN_SPAIN = 'IN_SPAIN',
  OUTSIDE_SPAIN = 'OUTSIDE_SPAIN',
}
</file>

<file path="src/app/core/api/api.types.ts">
/**
 * This file was auto-generated by openapi-typescript.
 * Do not make direct changes to the file.
 */

export interface paths {
    "/health": {
        parameters: {
            query?: never;
            header?: never;
            path?: never;
            cookie?: never;
        };
        get: operations["HealthController_check"];
        put?: never;
        post?: never;
        delete?: never;
        options?: never;
        head?: never;
        patch?: never;
        trace?: never;
    };
    "/health/db": {
        parameters: {
            query?: never;
            header?: never;
            path?: never;
            cookie?: never;
        };
        get: operations["HealthController_db"];
        put?: never;
        post?: never;
        delete?: never;
        options?: never;
        head?: never;
        patch?: never;
        trace?: never;
    };
    "/health/ready": {
        parameters: {
            query?: never;
            header?: never;
            path?: never;
            cookie?: never;
        };
        get: operations["HealthController_ready"];
        put?: never;
        post?: never;
        delete?: never;
        options?: never;
        head?: never;
        patch?: never;
        trace?: never;
    };
    "/user": {
        parameters: {
            query?: never;
            header?: never;
            path?: never;
            cookie?: never;
        };
        /** Listar todos los usuarios activos */
        get: operations["UserController_findAll"];
        put?: never;
        /** Crear un nuevo usuario */
        post: operations["UserController_create"];
        delete?: never;
        options?: never;
        head?: never;
        patch?: never;
        trace?: never;
    };
    "/user/me": {
        parameters: {
            query?: never;
            header?: never;
            path?: never;
            cookie?: never;
        };
        get: operations["UserController_getMe"];
        put?: never;
        post?: never;
        delete?: never;
        options?: never;
        head?: never;
        patch?: never;
        trace?: never;
    };
    "/user/{id}": {
        parameters: {
            query?: never;
            header?: never;
            path?: never;
            cookie?: never;
        };
        /** Obtener un usuario por ID */
        get: operations["UserController_findOne"];
        put?: never;
        post?: never;
        /** Desactivar un usuario (soft delete) */
        delete: operations["UserController_remove"];
        options?: never;
        head?: never;
        /** Actualizar un usuario */
        patch: operations["UserController_update"];
        trace?: never;
    };
    "/user-company-role": {
        parameters: {
            query?: never;
            header?: never;
            path?: never;
            cookie?: never;
        };
        /** Listar todos los v铆nculos usuario-empresa */
        get: operations["UserCompanyRoleController_findAll"];
        put?: never;
        /** Crear v铆nculo de usuario-empresa con rol */
        post: operations["UserCompanyRoleController_create"];
        delete?: never;
        options?: never;
        head?: never;
        patch?: never;
        trace?: never;
    };
    "/user-company-role/{id}": {
        parameters: {
            query?: never;
            header?: never;
            path?: never;
            cookie?: never;
        };
        /** Obtener v铆nculo usuario-empresa por ID */
        get: operations["UserCompanyRoleController_findOne"];
        put?: never;
        post?: never;
        /** Eliminar v铆nculo usuario-empresa por ID */
        delete: operations["UserCompanyRoleController_remove"];
        options?: never;
        head?: never;
        /** Actualizar v铆nculo usuario-empresa por ID */
        patch: operations["UserCompanyRoleController_update"];
        trace?: never;
    };
    "/companies/legal": {
        parameters: {
            query?: never;
            header?: never;
            path?: never;
            cookie?: never;
        };
        get?: never;
        put?: never;
        /**
         * Crear empresa (flujo legal completo)
         * @description Crea empresa + identidad fiscal + direcci贸n fiscal y asigna OWNER al creador
         */
        post: operations["CompanyController_createLegalCompany"];
        delete?: never;
        options?: never;
        head?: never;
        patch?: never;
        trace?: never;
    };
    "/companies/me": {
        parameters: {
            query?: never;
            header?: never;
            path?: never;
            cookie?: never;
        };
        /**
         * Empresas del usuario autenticado
         * @description Devuelve las empresas a las que pertenece el usuario con su rol
         */
        get: operations["CompanyController_getMyCompanies"];
        put?: never;
        post?: never;
        delete?: never;
        options?: never;
        head?: never;
        patch?: never;
        trace?: never;
    };
    "/companies": {
        parameters: {
            query?: never;
            header?: never;
            path?: never;
            cookie?: never;
        };
        get: operations["CompanyController_findAll"];
        put?: never;
        post?: never;
        delete?: never;
        options?: never;
        head?: never;
        patch?: never;
        trace?: never;
    };
    "/client-profiles/company/{companyId}": {
        parameters: {
            query?: never;
            header?: never;
            path?: never;
            cookie?: never;
        };
        /** Listar clientes de una empresa */
        get: operations["ClientProfileController_findAll"];
        put?: never;
        /** Crear cliente para una empresa */
        post: operations["ClientProfileController_create"];
        delete?: never;
        options?: never;
        head?: never;
        patch?: never;
        trace?: never;
    };
    "/client-profiles/{id}": {
        parameters: {
            query?: never;
            header?: never;
            path?: never;
            cookie?: never;
        };
        /** Obtener cliente por ID */
        get: operations["ClientProfileController_findOne"];
        put?: never;
        post?: never;
        /** Desactivar cliente (soft delete) */
        delete: operations["ClientProfileController_remove"];
        options?: never;
        head?: never;
        /** Actualizar cliente */
        patch: operations["ClientProfileController_update"];
        trace?: never;
    };
    "/auth/login": {
        parameters: {
            query?: never;
            header?: never;
            path?: never;
            cookie?: never;
        };
        get?: never;
        put?: never;
        /** Login con email y password */
        post: operations["AuthController_login"];
        delete?: never;
        options?: never;
        head?: never;
        patch?: never;
        trace?: never;
    };
    "/auth/refresh": {
        parameters: {
            query?: never;
            header?: never;
            path?: never;
            cookie?: never;
        };
        get?: never;
        put?: never;
        /** Generar un nuevo access token usando refresh */
        post: operations["AuthController_refresh"];
        delete?: never;
        options?: never;
        head?: never;
        patch?: never;
        trace?: never;
    };
    "/auth/logout": {
        parameters: {
            query?: never;
            header?: never;
            path?: never;
            cookie?: never;
        };
        get?: never;
        put?: never;
        /** Cerrar sesi贸n e invalidar refresh token */
        post: operations["AuthController_logout"];
        delete?: never;
        options?: never;
        head?: never;
        patch?: never;
        trace?: never;
    };
    "/context/select-company": {
        parameters: {
            query?: never;
            header?: never;
            path?: never;
            cookie?: never;
        };
        get?: never;
        put?: never;
        post: operations["CompanyContextController_selectCompany"];
        delete?: never;
        options?: never;
        head?: never;
        patch?: never;
        trace?: never;
    };
    "/companies/{companyId}/addresses": {
        parameters: {
            query?: never;
            header?: never;
            path?: never;
            cookie?: never;
        };
        /**
         * Listar direcciones de una empresa
         * @description Por defecto solo muestra direcciones activas. Usa showInactive=true para incluir las inactivas.
         */
        get: operations["AddressController_findAllForCompany"];
        put?: never;
        /**
         * Crear direcci贸n para una empresa
         * @description Crea una direcci贸n asociada a una empresa. Solo puede existir una direcci贸n FISCAL activa por empresa.
         */
        post: operations["AddressController_createForCompany"];
        delete?: never;
        options?: never;
        head?: never;
        patch?: never;
        trace?: never;
    };
    "/companies/{companyId}/addresses/{addressId}": {
        parameters: {
            query?: never;
            header?: never;
            path?: never;
            cookie?: never;
        };
        /** Obtener una direcci贸n concreta de una empresa */
        get: operations["AddressController_findOneForCompany"];
        put?: never;
        post?: never;
        /**
         * Desactivar direcci贸n (soft delete)
         * @description Marca la direcci贸n como inactiva (isActive=false)
         */
        delete: operations["AddressController_removeForCompany"];
        options?: never;
        head?: never;
        /** Actualizar direcci贸n de una empresa */
        patch: operations["AddressController_updateForCompany"];
        trace?: never;
    };
    "/contact": {
        parameters: {
            query?: never;
            header?: never;
            path?: never;
            cookie?: never;
        };
        /** Listar contactos activos */
        get: operations["ContactController_findAll"];
        put?: never;
        /** Crear nuevo contacto */
        post: operations["ContactController_create"];
        delete?: never;
        options?: never;
        head?: never;
        patch?: never;
        trace?: never;
    };
    "/contact/inactive": {
        parameters: {
            query?: never;
            header?: never;
            path?: never;
            cookie?: never;
        };
        /** Listar contactos inactivos */
        get: operations["ContactController_findInactive"];
        put?: never;
        post?: never;
        delete?: never;
        options?: never;
        head?: never;
        patch?: never;
        trace?: never;
    };
    "/contact/{id}": {
        parameters: {
            query?: never;
            header?: never;
            path?: never;
            cookie?: never;
        };
        /** Buscar contacto por id */
        get: operations["ContactController_findOne"];
        put?: never;
        post?: never;
        /** Eliminar contacto (soft delete) */
        delete: operations["ContactController_remove"];
        options?: never;
        head?: never;
        /** Actualizar contacto por id */
        patch: operations["ContactController_update"];
        trace?: never;
    };
    "/client": {
        parameters: {
            query?: never;
            header?: never;
            path?: never;
            cookie?: never;
        };
        get: operations["ClientController_findAll"];
        put?: never;
        post: operations["ClientController_create"];
        delete?: never;
        options?: never;
        head?: never;
        patch?: never;
        trace?: never;
    };
    "/client/{id}": {
        parameters: {
            query?: never;
            header?: never;
            path?: never;
            cookie?: never;
        };
        get: operations["ClientController_findOne"];
        put?: never;
        post?: never;
        delete: operations["ClientController_remove"];
        options?: never;
        head?: never;
        patch: operations["ClientController_update"];
        trace?: never;
    };
    "/companies/{companyId}/properties": {
        parameters: {
            query?: never;
            header?: never;
            path?: never;
            cookie?: never;
        };
        /** Listar inmuebles de una empresa */
        get: operations["PropertyController_findAll"];
        put?: never;
        /** Crear inmueble para una empresa */
        post: operations["PropertyController_create"];
        delete?: never;
        options?: never;
        head?: never;
        patch?: never;
        trace?: never;
    };
    "/companies/{companyId}/properties/{propertyId}": {
        parameters: {
            query?: never;
            header?: never;
            path?: never;
            cookie?: never;
        };
        /** Obtener inmueble concreto */
        get: operations["PropertyController_findOne"];
        put?: never;
        post?: never;
        /** Desactivar inmueble (soft delete) */
        delete: operations["PropertyController_remove"];
        options?: never;
        head?: never;
        /** Actualizar inmueble */
        patch: operations["PropertyController_update"];
        trace?: never;
    };
    "/companies/{companyId}/contracts": {
        parameters: {
            query?: never;
            header?: never;
            path?: never;
            cookie?: never;
        };
        /**
         * Listar contratos de una empresa
         * @description Por defecto solo devuelve contratos activos. Usa showInactive=true para incluir contratos inactivos.
         */
        get: operations["ContractController_findAllForCompany"];
        put?: never;
        /**
         * Crear contrato para una empresa
         * @description Crea un contrato asociado a una empresa, un cliente y un inmueble. El contrato define las condiciones econ贸micas y temporales, pero no genera facturas.
         */
        post: operations["ContractController_createForCompany"];
        delete?: never;
        options?: never;
        head?: never;
        patch?: never;
        trace?: never;
    };
    "/companies/{companyId}/contracts/{contractId}": {
        parameters: {
            query?: never;
            header?: never;
            path?: never;
            cookie?: never;
        };
        /** Obtener un contrato concreto */
        get: operations["ContractController_findOneForCompany"];
        put?: never;
        post?: never;
        /**
         * Desactivar contrato (soft delete)
         * @description Marca el contrato como inactivo (isActive=false) y cambia su estado a INACTIVO.
         */
        delete: operations["ContractController_removeForCompany"];
        options?: never;
        head?: never;
        /** Actualizar contrato */
        patch: operations["ContractController_updateForCompany"];
        trace?: never;
    };
}
export type webhooks = Record<string, never>;
export interface components {
    schemas: {
        CreateUserDto: {
            /**
             * @description Correo electr贸nico 煤nico del usuario
             * @example user@example.com
             */
            email: string;
            /**
             * @description Contrase帽a del usuario (m铆nimo 6 caracteres)
             * @example StrongPassword123!
             */
            password: string;
            /**
             * @description Rol global del usuario (ej. superadmin)
             * @example superadmin, admin, user
             */
            appRole?: string;
        };
        UserDto: {
            /** @example user@example.com */
            email: string;
            /** @example superadmin, admin, user */
            appRole: string;
        };
        CompanyRoleDto: {
            companyId: string;
            companyName: string;
            /** @enum {string} */
            role: "OWNER" | "ADMIN" | "MANAGER" | "VIEWER";
        };
        MeDto: {
            id: string;
            email: string;
            /** @enum {string} */
            appRole: "SUPERADMIN" | "ADMIN" | "USER";
            companyRoles?: components["schemas"]["CompanyRoleDto"][];
            clientProfiles?: string[];
            isActive: boolean;
            /** Format: date-time */
            created_at: string;
            /** Format: date-time */
            updated_at: string;
        };
        UpdateUserDto: {
            /**
             * @description Correo electr贸nico 煤nico del usuario
             * @example user@example.com
             */
            email?: string;
            /**
             * @description Contrase帽a del usuario (m铆nimo 6 caracteres)
             * @example StrongPassword123!
             */
            password?: string;
            /**
             * @description Rol global del usuario (ej. superadmin)
             * @example superadmin, admin, user
             */
            appRole?: string;
        };
        CreateUserCompanyRoleDto: {
            /**
             * @description UUID del usuario que tendr谩 el rol asignado
             * @example aa04f32e-6dba-43af-9363-579e00a53c8b
             */
            userId: string;
            /**
             * @description UUID de la empresa donde se asigna el rol
             * @example f54e632a-91be-4bcd-8f40-3ae5cdc3b9e2
             */
            companyId: string;
            /**
             * @description Tipo de rol dentro de la empresa: owner, manager, client, etc.
             * @example OWNER
             * @enum {string}
             */
            role: "OWNER" | "ADMIN" | "MANAGER" | "VIEWER";
        };
        UserCompanyRole: Record<string, never>;
        UpdateUserCompanyRoleDto: {
            /**
             * @description UUID del usuario que tendr谩 el rol asignado
             * @example aa04f32e-6dba-43af-9363-579e00a53c8b
             */
            userId?: string;
            /**
             * @description UUID de la empresa donde se asigna el rol
             * @example f54e632a-91be-4bcd-8f40-3ae5cdc3b9e2
             */
            companyId?: string;
            /**
             * @description Tipo de rol dentro de la empresa: owner, manager, client, etc.
             * @example OWNER
             * @enum {string}
             */
            role?: "OWNER" | "ADMIN" | "MANAGER" | "VIEWER";
        };
        CreateFacturaePartyDto: {
            /**
             * @description Tipo de persona fiscal
             * @example LEGAL_ENTITY
             * @enum {string}
             */
            personType: "PERSON" | "LEGAL_ENTITY";
            /**
             * @description Tipo de identificaci贸n fiscal
             * @example CIF
             * @enum {string}
             */
            taxIdType: "NIF" | "CIF" | "NIE" | "PASSPORT" | "VAT";
            /**
             * @description Identificador fiscal (NIF, CIF, NIE, etc.)
             * @example B12345678
             */
            taxId: string;
            /**
             * @description Nombre legal o raz贸n social
             * @example Industria Soluciones SL
             */
            legalName: string;
            /**
             * @description Nombre comercial
             * @example InduSol
             */
            tradeName?: string;
            /**
             * @description R茅gimen fiscal
             * @default GENERAL
             * @enum {string}
             */
            taxRegime: "GENERAL" | "SIMPLIFIED" | "EXEMPT" | "OTHER";
            /**
             * @description Sujeto o exento de impuestos
             * @default SUBJECT
             * @enum {string}
             */
            subjectType: "SUBJECT" | "EXEMPT";
            /**
             * @description Residencia fiscal seg煤n Facturae
             * @example R
             * @enum {string}
             */
            residenceType?: "R" | "U" | "E" | "O";
        };
        CreateAddressDto: {
            /**
             * @description Tipo de direcci贸n dentro del sistema
             * @example FISCAL
             * @enum {string}
             */
            type: "FISCAL" | "COMMERCIAL" | "PROPERTY" | "OTHER";
            /**
             * @description Residencia fiscal seg煤n Facturae
             * @example IN_SPAIN
             * @enum {string}
             */
            residenceType: "IN_SPAIN" | "OUTSIDE_SPAIN";
            /**
             * @description Direcci贸n principal
             * @example Calle Mayor 12
             */
            addressLine1: string;
            /**
             * @description Informaci贸n adicional de la direcci贸n
             * @example 2潞 B
             */
            addressLine2?: string;
            /**
             * @description C贸digo postal
             * @example 46060
             */
            postalCode: string;
            /**
             * @description Ciudad / municipio
             * @example Valencia
             */
            city: string;
            /**
             * @description Provincia (obligatoria si residenceType = IN_SPAIN)
             * @example Valencia
             */
            province: string;
            /**
             * @description C贸digo de pa铆s ISO-3166-1 alpha-2
             * @default ES
             * @example ES
             */
            countryCode: string;
            /**
             * @description Indica si es la direcci贸n principal para su tipo
             * @example true
             */
            isDefault?: boolean;
        };
        CreateCompanyLegalDto: {
            /**
             * @description Usuario que ser谩 OWNER de la empresa
             * @example uuid
             */
            ownerUserId: string;
            /** @description Identidad fiscal (Facturae) */
            facturaeParty: components["schemas"]["CreateFacturaePartyDto"];
            /** @description Direcci贸n fiscal */
            fiscalAddress: components["schemas"]["CreateAddressDto"];
            /** @description Email de contacto */
            email?: string;
            /** @description Tel茅fono de contacto */
            phone?: string;
        };
        CreateClientProfileDto: {
            /**
             * @description Nombre completo o raz贸n social del cliente
             * @example Pepe Gonz谩lez SL
             */
            name: string;
            /**
             * @description NIF/CIF del cliente
             * @example B12345678
             */
            nif: string;
            /**
             * @description Correo electr贸nico del cliente (opcional)
             * @example pepe@email.com
             */
            email?: string;
            /**
             * @description Tel茅fono del cliente (opcional)
             * @example 612345678
             */
            phone?: string;
            /**
             * @description UUID de la empresa asociada
             * @example 60eb3add-8fb2-4f82-8233-4ff2b12a156d
             */
            companyId: string;
            /**
             * @description UUID del usuario asociado (opcional)
             * @example 70ab3cde-1be2-4f18-b233-5ae2c67b34ef
             */
            userId?: string;
        };
        UpdateClientProfileDto: {
            /**
             * @description Nombre completo o raz贸n social del cliente
             * @example Pepe Gonz谩lez SL
             */
            name?: string;
            /**
             * @description NIF/CIF del cliente
             * @example B12345678
             */
            nif?: string;
            /**
             * @description Correo electr贸nico del cliente (opcional)
             * @example pepe@email.com
             */
            email?: string;
            /**
             * @description Tel茅fono del cliente (opcional)
             * @example 612345678
             */
            phone?: string;
            /**
             * @description UUID de la empresa asociada
             * @example 60eb3add-8fb2-4f82-8233-4ff2b12a156d
             */
            companyId?: string;
            /**
             * @description UUID del usuario asociado (opcional)
             * @example 70ab3cde-1be2-4f18-b233-5ae2c67b34ef
             */
            userId?: string;
        };
        LoginDto: {
            /**
             * @description Correo electr贸nico del usuario. Debe ser 煤nico y registrado previamente.
             * @example user@example.com
             */
            email: string;
            /**
             * @description Contrase帽a del usuario (m铆nimo 6 caracteres)
             * @example password123
             */
            password: string;
        };
        TokensDto: {
            /**
             * @description Access token JWT
             * @example eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
             */
            accessToken: string;
            /**
             * @description Refresh token JWT
             * @example eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
             */
            refreshToken: string;
        };
        SelectCompanyDto: {
            /**
             * @description UUID de la empresa que el usuario quiere activar como compa帽铆a actual en sesi贸n
             * @example 8e2c4cae-5a4f-4264-befe-2a406fa4adcb
             */
            companyId: string;
        };
        Address: {
            /**
             * Format: uuid
             * @description Empresa propietaria de la direcci贸n
             */
            companyId: string;
            /**
             * Format: uuid
             * @description Cliente asociado a la direcci贸n (opcional)
             */
            clientProfileId?: string;
            /**
             * @description Tipo de direcci贸n seg煤n su uso funcional
             * @example FISCAL
             * @enum {string}
             */
            type: "FISCAL" | "COMMERCIAL" | "PROPERTY" | "OTHER";
            /** @example Calle Mayor 12 */
            addressLine1: string;
            /** @example 3潞 izquierda */
            addressLine2?: string;
            /** @example 28001 */
            postalCode: string;
            /** @example Madrid */
            city: string;
            /** @example Madrid */
            province: string;
            /**
             * @description C贸digo de pa铆s ISO-3166-1 alpha-2
             * @example ES
             */
            countryCode: string;
            /**
             * @description Indica si es la direcci贸n principal para su tipo
             * @example true
             */
            isDefault: boolean;
        };
        UpdateAddressDto: {
            /**
             * @description Tipo de direcci贸n dentro del sistema
             * @example FISCAL
             * @enum {string}
             */
            type?: "FISCAL" | "COMMERCIAL" | "PROPERTY" | "OTHER";
            /**
             * @description Residencia fiscal seg煤n Facturae
             * @example IN_SPAIN
             * @enum {string}
             */
            residenceType?: "IN_SPAIN" | "OUTSIDE_SPAIN";
            /**
             * @description Direcci贸n principal
             * @example Calle Mayor 12
             */
            addressLine1?: string;
            /**
             * @description Informaci贸n adicional de la direcci贸n
             * @example 2潞 B
             */
            addressLine2?: string;
            /**
             * @description C贸digo postal
             * @example 46060
             */
            postalCode?: string;
            /**
             * @description Ciudad / municipio
             * @example Valencia
             */
            city?: string;
            /**
             * @description Provincia (obligatoria si residenceType = IN_SPAIN)
             * @example Valencia
             */
            province?: string;
            /**
             * @description C贸digo de pa铆s ISO-3166-1 alpha-2
             * @default ES
             * @example ES
             */
            countryCode: string;
            /**
             * @description Indica si es la direcci贸n principal para su tipo
             * @example true
             */
            isDefault?: boolean;
        };
        CreateContactDto: {
            /**
             * @description Nombre completo del contacto interno
             * @example Ana L贸pez
             */
            nombre: string;
            /**
             * @description Tipo de contacto interno
             * @example DIRECCION
             * @enum {string}
             */
            tipoContacto: "DIRECCION" | "EMERGENCIAS" | "GESTORIA" | "ADMINISTRACION" | "PERSONAL" | "OTRO" | "General" | "Emergencias" | "Otro";
            /**
             * @description Correo electr贸nico del contacto (opcional)
             * @example ana.lopez@ejemplo.com
             */
            email?: string;
            /**
             * @description Tel茅fono del contacto (opcional)
             * @example 612345678
             */
            telefono?: string;
            /**
             * @description Cargo en la empresa (opcional)
             * @example Directora t茅cnica
             */
            cargo?: string;
            /**
             * @description Direcci贸n postal del contacto (opcional)
             * @example Calle Falsa 123
             */
            direccion?: string;
            /**
             * @description Activo/inactivo (opcional, por defecto activo)
             * @example true
             */
            isActive?: boolean;
        };
        Contact: {
            /**
             * @description Nombre completo del contacto interno
             * @example Ana L贸pez
             */
            nombre: string;
            /**
             * @description Tipo de contacto interno
             * @example General
             * @enum {string}
             */
            tipoContacto: "DIRECCION" | "EMERGENCIAS" | "GESTORIA" | "ADMINISTRACION" | "PERSONAL" | "OTRO" | "General" | "Emergencias" | "Otro";
            /**
             * @description Correo electr贸nico (opcional)
             * @example ana.lopez@ejemplo.com
             */
            email?: string;
            /**
             * @description Tel茅fono de contacto (opcional)
             * @example 612345678
             */
            telefono?: string;
            /**
             * @description Cargo en la empresa (opcional)
             * @example Directora t茅cnica
             */
            cargo?: string;
            /**
             * @description Direcci贸n puntual del contacto (opcional)
             * @example Calle Falsa 123
             */
            direccion?: string;
        };
        UpdateContactDto: {
            /**
             * @description Nombre completo del contacto interno
             * @example Ana L贸pez
             */
            nombre?: string;
            /**
             * @description Tipo de contacto interno
             * @example DIRECCION
             * @enum {string}
             */
            tipoContacto?: "DIRECCION" | "EMERGENCIAS" | "GESTORIA" | "ADMINISTRACION" | "PERSONAL" | "OTRO" | "General" | "Emergencias" | "Otro";
            /**
             * @description Correo electr贸nico del contacto (opcional)
             * @example ana.lopez@ejemplo.com
             */
            email?: string;
            /**
             * @description Tel茅fono del contacto (opcional)
             * @example 612345678
             */
            telefono?: string;
            /**
             * @description Cargo en la empresa (opcional)
             * @example Directora t茅cnica
             */
            cargo?: string;
            /**
             * @description Direcci贸n postal del contacto (opcional)
             * @example Calle Falsa 123
             */
            direccion?: string;
            /**
             * @description Activo/inactivo (opcional, por defecto activo)
             * @example true
             */
            isActive?: boolean;
        };
        CreateClientDto: {
            /**
             * @description Empresa propietaria del cliente
             * @example f2a1e0d9-4c6a-4d1e-9b3a-1c2d3e4f5678
             */
            companyId: string;
            /**
             * @description Identidad fiscal del cliente (FacturaeParty)
             * @example c1b2a3d4-1111-4aaa-9bbb-ccccdddd0000
             */
            facturaePartyId: string;
            /**
             * @description Direcci贸n fiscal del cliente
             * @example d4e5f6a7-2222-4bbb-8ccc-ddddeeeeffff
             */
            fiscalAddressId: string;
        };
        UpdateClientDto: {
            /**
             * @description Empresa propietaria del cliente
             * @example f2a1e0d9-4c6a-4d1e-9b3a-1c2d3e4f5678
             */
            companyId?: string;
            /**
             * @description Identidad fiscal del cliente (FacturaeParty)
             * @example c1b2a3d4-1111-4aaa-9bbb-ccccdddd0000
             */
            facturaePartyId?: string;
            /**
             * @description Direcci贸n fiscal del cliente
             * @example d4e5f6a7-2222-4bbb-8ccc-ddddeeeeffff
             */
            fiscalAddressId?: string;
        };
        CreatePropertyDto: {
            /**
             * Format: uuid
             * @description ID de la direcci贸n (Address type PROPERTY)
             */
            addressId: string;
            /** @example P-VAL-001 */
            reference?: string;
            /** @enum {string} */
            type: "VIVIENDA" | "LOCAL_COMERCIAL" | "GARAJE" | "TRASTERO" | "TERRENO" | "OTRO";
            /** @enum {string} */
            status: "DISPONIBLE" | "ALQUILADO" | "BLOQUEADO" | "INACTIVO";
            /** @example 1234567AB1234C0001DE */
            cadastralReference?: string;
            /** @example 85 */
            surfaceM2?: number;
            /** @example 3 */
            rooms?: number;
            /** @example 2 */
            bathrooms?: number;
            /** @example 3潞 */
            floor?: string;
            /** @example 39.4699 */
            latitude?: number;
            /** @example -0.3763 */
            longitude?: number;
        };
        Property: {
            /**
             * Format: uuid
             * @description Empresa propietaria del inmueble
             */
            companyId: string;
            /**
             * Format: uuid
             * @description Direcci贸n asociada al inmueble
             */
            addressId: string;
            /**
             * @description Referencia interna del inmueble
             * @example P-VAL-001
             */
            reference: string;
            /**
             * @description Referencia catastral
             * @example 1234567AB1234C0001DE
             */
            cadastralReference?: string;
            /**
             * @description Tipo de inmueble
             * @enum {string}
             */
            type: "VIVIENDA" | "LOCAL_COMERCIAL" | "GARAJE" | "TRASTERO" | "TERRENO" | "OTRO";
            /**
             * @description Estado actual del inmueble
             * @enum {string}
             */
            status: "DISPONIBLE" | "ALQUILADO" | "BLOQUEADO" | "INACTIVO";
            /** @example 85 */
            surfaceM2?: number;
            /** @example 3 */
            rooms?: number;
            /** @example 2 */
            bathrooms?: number;
            /** @example 3潞 */
            floor?: string;
            /** @example 39.4699 */
            latitude?: number;
            /** @example -0.3763 */
            longitude?: number;
        };
        UpdatePropertyDto: {
            /**
             * Format: uuid
             * @description ID de la direcci贸n (Address type PROPERTY)
             */
            addressId?: string;
            /** @example P-VAL-001 */
            reference?: string;
            /** @enum {string} */
            type?: "VIVIENDA" | "LOCAL_COMERCIAL" | "GARAJE" | "TRASTERO" | "TERRENO" | "OTRO";
            /** @enum {string} */
            status?: "DISPONIBLE" | "ALQUILADO" | "BLOQUEADO" | "INACTIVO";
            /** @example 1234567AB1234C0001DE */
            cadastralReference?: string;
            /** @example 85 */
            surfaceM2?: number;
            /** @example 3 */
            rooms?: number;
            /** @example 2 */
            bathrooms?: number;
            /** @example 3潞 */
            floor?: string;
            /** @example 39.4699 */
            latitude?: number;
            /** @example -0.3763 */
            longitude?: number;
        };
        CreateContractDto: {
            /**
             * Format: uuid
             * @description Cliente asociado al contrato
             */
            clientProfileId: string;
            /**
             * Format: uuid
             * @description Inmueble asociado al contrato
             */
            propertyId: string;
            /**
             * @description N煤mero o referencia interna del contrato
             * @example CTR-2024-001
             */
            numeroContrato: string;
            /**
             * @description Tipo de contrato
             * @enum {string}
             */
            tipoContrato: "ALQUILER" | "CESION" | "TEMPORAL" | "OTRO";
            /**
             * @description Estado inicial del contrato
             * @example ACTIVO
             * @enum {string}
             */
            estadoContrato: "BORRADOR" | "ACTIVO" | "FINALIZADO" | "RESCINDIDO" | "INACTIVO";
            /**
             * @description Fecha de firma del contrato
             * @example 2024-01-15
             */
            fechaFirma: string;
            /**
             * @description Fecha de inicio del contrato
             * @example 2024-02-01
             */
            fechaInicio: string;
            /**
             * @description Duraci贸n inicial del contrato en meses
             * @example 12
             */
            duracionMeses: number;
            /**
             * @description Fecha de finalizaci贸n prevista del contrato
             * @example 2025-01-31
             */
            fechaFin: string;
            /**
             * @description Importe base del contrato sin impuestos
             * @example 750
             */
            importeBase: number;
            /**
             * @description Periodicidad de facturaci贸n
             * @enum {string}
             */
            periodicidad: "MENSUAL" | "BIMESTRAL" | "TRIMESTRAL" | "ANUAL";
            /**
             * Format: uuid
             * @description ID del tipo de IVA aplicable (cat谩logo VAT)
             */
            vatRateId: string;
            /**
             * Format: uuid
             * @description ID del tipo de retenci贸n aplicable (cat谩logo Withholding)
             */
            withholdingRateId: string;
            /**
             * @description Importe entregado como fianza
             * @example 1500
             */
            fianzaImporte?: number;
            /**
             * @description Meses de carencia sin facturaci贸n
             * @example 0
             */
            mesesCarencia?: number;
            /**
             * @description Avisar antes de la finalizaci贸n del contrato
             * @example true
             */
            avisarFinContrato?: boolean;
            /**
             * @description Indica si el contrato tiene revisi贸n IPC
             * @example true
             */
            revisionIpcActiva?: boolean;
            /**
             * @description Fecha prevista de revisi贸n IPC
             * @example 2025-02-01
             */
            fechaRevisionIpc?: string;
            /**
             * @description Avisar cuando llegue la revisi贸n IPC
             * @example true
             */
            avisarRevisionIpc?: boolean;
            /** @description Descripci贸n de gastos adicionales */
            gastosDescripcion?: string;
            /** @description Observaciones generales del contrato */
            observaciones?: string;
        };
        Contract: {
            /**
             * Format: uuid
             * @description Empresa propietaria del contrato
             */
            companyId: string;
            /**
             * Format: uuid
             * @description Cliente asociado al contrato
             */
            clientProfileId: string;
            /**
             * Format: uuid
             * @description Inmueble asociado al contrato
             */
            propertyId: string;
            /**
             * @description N煤mero o referencia interna del contrato
             * @example CTR-2024-001
             */
            numeroContrato: string;
            /**
             * @description Tipo de contrato (alquiler, cesi贸n, etc.)
             * @enum {string}
             */
            tipoContrato: "ALQUILER" | "CESION" | "TEMPORAL" | "OTRO";
            /**
             * @description Estado actual del contrato
             * @enum {string}
             */
            estadoContrato: "BORRADOR" | "ACTIVO" | "FINALIZADO" | "RESCINDIDO" | "INACTIVO";
            /**
             * Format: date-time
             * @description Fecha de firma del contrato
             * @example 2024-01-15
             */
            fechaFirma: string;
            /**
             * Format: date-time
             * @description Fecha de inicio del contrato
             * @example 2024-02-01
             */
            fechaInicio: string;
            /**
             * @description Duraci贸n inicial del contrato en meses
             * @example 12
             */
            duracionMeses: number;
            /**
             * Format: date-time
             * @description Fecha de finalizaci贸n prevista del contrato
             * @example 2025-01-31
             */
            fechaFin: string;
            /**
             * Format: date-time
             * @description Fecha de rescisi贸n anticipada, si aplica
             * @example 2024-10-15
             */
            fechaRescision?: string;
            /**
             * @description Indica si el contrato se renueva autom谩ticamente
             * @example true
             */
            renovacionAutomatica: boolean;
            /**
             * @description Meses de preaviso requeridos
             * @example 2
             */
            preavisoMeses?: number;
            /**
             * @description Importe base sin impuestos
             * @example 750
             */
            importeBase: number;
            /**
             * @description Moneda del contrato (ISO-4217)
             * @example EUR
             */
            moneda: string;
            /**
             * @description Periodicidad de facturaci贸n
             * @enum {string}
             */
            periodicidad: "MENSUAL" | "BIMESTRAL" | "TRIMESTRAL" | "ANUAL";
            /**
             * Format: uuid
             * @description Tipo de IVA aplicado al contrato
             */
            vatRateId: string;
            /**
             * Format: uuid
             * @description Tipo de retenci贸n aplicado al contrato
             */
            withholdingRateId: string;
            /**
             * @description Importe entregado como fianza
             * @example 1500
             */
            fianzaImporte?: number;
            /**
             * @description Meses de carencia sin facturaci贸n
             * @example 2
             */
            mesesCarencia: number;
            /**
             * @description Avisar antes de la finalizaci贸n del contrato
             * @example true
             */
            avisarFinContrato: boolean;
            /**
             * @description Indica si el contrato tiene revisi贸n IPC
             * @example true
             */
            revisionIpcActiva: boolean;
            /**
             * Format: date-time
             * @description Fecha prevista de revisi贸n IPC
             * @example 2025-02-01
             */
            fechaRevisionIpc?: string;
            /**
             * @description Avisar cuando llegue la revisi贸n IPC
             * @example true
             */
            avisarRevisionIpc: boolean;
            /** @description Descripci贸n de gastos adicionales */
            gastosDescripcion?: string;
            /** @description Observaciones generales del contrato */
            observaciones?: string;
        };
        UpdateContractDto: {
            /**
             * Format: uuid
             * @description Cliente asociado al contrato
             */
            clientProfileId?: string;
            /**
             * Format: uuid
             * @description Inmueble asociado al contrato
             */
            propertyId?: string;
            /**
             * @description N煤mero o referencia interna del contrato
             * @example CTR-2024-001
             */
            numeroContrato?: string;
            /**
             * @description Tipo de contrato
             * @enum {string}
             */
            tipoContrato?: "ALQUILER" | "CESION" | "TEMPORAL" | "OTRO";
            /**
             * @description Estado inicial del contrato
             * @example ACTIVO
             * @enum {string}
             */
            estadoContrato?: "BORRADOR" | "ACTIVO" | "FINALIZADO" | "RESCINDIDO" | "INACTIVO";
            /**
             * @description Fecha de firma del contrato
             * @example 2024-01-15
             */
            fechaFirma?: string;
            /**
             * @description Fecha de inicio del contrato
             * @example 2024-02-01
             */
            fechaInicio?: string;
            /**
             * @description Duraci贸n inicial del contrato en meses
             * @example 12
             */
            duracionMeses?: number;
            /**
             * @description Fecha de finalizaci贸n prevista del contrato
             * @example 2025-01-31
             */
            fechaFin?: string;
            /**
             * @description Importe base del contrato sin impuestos
             * @example 750
             */
            importeBase?: number;
            /**
             * @description Periodicidad de facturaci贸n
             * @enum {string}
             */
            periodicidad?: "MENSUAL" | "BIMESTRAL" | "TRIMESTRAL" | "ANUAL";
            /**
             * Format: uuid
             * @description ID del tipo de IVA aplicable (cat谩logo VAT)
             */
            vatRateId?: string;
            /**
             * Format: uuid
             * @description ID del tipo de retenci贸n aplicable (cat谩logo Withholding)
             */
            withholdingRateId?: string;
            /**
             * @description Importe entregado como fianza
             * @example 1500
             */
            fianzaImporte?: number;
            /**
             * @description Meses de carencia sin facturaci贸n
             * @example 0
             */
            mesesCarencia?: number;
            /**
             * @description Avisar antes de la finalizaci贸n del contrato
             * @example true
             */
            avisarFinContrato?: boolean;
            /**
             * @description Indica si el contrato tiene revisi贸n IPC
             * @example true
             */
            revisionIpcActiva?: boolean;
            /**
             * @description Fecha prevista de revisi贸n IPC
             * @example 2025-02-01
             */
            fechaRevisionIpc?: string;
            /**
             * @description Avisar cuando llegue la revisi贸n IPC
             * @example true
             */
            avisarRevisionIpc?: boolean;
            /** @description Descripci贸n de gastos adicionales */
            gastosDescripcion?: string;
            /** @description Observaciones generales del contrato */
            observaciones?: string;
        };
    };
    responses: never;
    parameters: never;
    requestBodies: never;
    headers: never;
    pathItems: never;
}
export type $defs = Record<string, never>;
export interface operations {
    HealthController_check: {
        parameters: {
            query?: never;
            header?: never;
            path?: never;
            cookie?: never;
        };
        requestBody?: never;
        responses: {
            /** @description Simple liveness check */
            200: {
                headers: {
                    [name: string]: unknown;
                };
                content?: never;
            };
        };
    };
    HealthController_db: {
        parameters: {
            query?: never;
            header?: never;
            path?: never;
            cookie?: never;
        };
        requestBody?: never;
        responses: {
            /** @description Database connectivity check */
            200: {
                headers: {
                    [name: string]: unknown;
                };
                content?: never;
            };
        };
    };
    HealthController_ready: {
        parameters: {
            query?: never;
            header?: never;
            path?: never;
            cookie?: never;
        };
        requestBody?: never;
        responses: {
            /** @description Readiness check (aggregates required deps) */
            200: {
                headers: {
                    [name: string]: unknown;
                };
                content?: never;
            };
        };
    };
    UserController_findAll: {
        parameters: {
            query?: never;
            header?: never;
            path?: never;
            cookie?: never;
        };
        requestBody?: never;
        responses: {
            200: {
                headers: {
                    [name: string]: unknown;
                };
                content: {
                    "application/json": components["schemas"]["UserDto"][];
                };
            };
        };
    };
    UserController_create: {
        parameters: {
            query?: never;
            header?: never;
            path?: never;
            cookie?: never;
        };
        requestBody: {
            content: {
                "application/json": components["schemas"]["CreateUserDto"];
            };
        };
        responses: {
            201: {
                headers: {
                    [name: string]: unknown;
                };
                content: {
                    "application/json": components["schemas"]["UserDto"];
                };
            };
        };
    };
    UserController_getMe: {
        parameters: {
            query?: never;
            header?: never;
            path?: never;
            cookie?: never;
        };
        requestBody?: never;
        responses: {
            200: {
                headers: {
                    [name: string]: unknown;
                };
                content: {
                    "application/json": components["schemas"]["MeDto"];
                };
            };
        };
    };
    UserController_findOne: {
        parameters: {
            query?: never;
            header?: never;
            path: {
                id: string;
            };
            cookie?: never;
        };
        requestBody?: never;
        responses: {
            200: {
                headers: {
                    [name: string]: unknown;
                };
                content: {
                    "application/json": components["schemas"]["UserDto"];
                };
            };
        };
    };
    UserController_remove: {
        parameters: {
            query?: never;
            header?: never;
            path: {
                id: string;
            };
            cookie?: never;
        };
        requestBody?: never;
        responses: {
            200: {
                headers: {
                    [name: string]: unknown;
                };
                content: {
                    "application/json": unknown;
                };
            };
        };
    };
    UserController_update: {
        parameters: {
            query?: never;
            header?: never;
            path: {
                id: string;
            };
            cookie?: never;
        };
        requestBody: {
            content: {
                "application/json": components["schemas"]["UpdateUserDto"];
            };
        };
        responses: {
            200: {
                headers: {
                    [name: string]: unknown;
                };
                content: {
                    "application/json": components["schemas"]["UserDto"];
                };
            };
        };
    };
    UserCompanyRoleController_findAll: {
        parameters: {
            query?: never;
            header?: never;
            path?: never;
            cookie?: never;
        };
        requestBody?: never;
        responses: {
            /** @description Lista de v铆nculos */
            200: {
                headers: {
                    [name: string]: unknown;
                };
                content: {
                    "application/json": components["schemas"]["UserCompanyRole"][];
                };
            };
        };
    };
    UserCompanyRoleController_create: {
        parameters: {
            query?: never;
            header?: never;
            path?: never;
            cookie?: never;
        };
        requestBody: {
            content: {
                "application/json": components["schemas"]["CreateUserCompanyRoleDto"];
            };
        };
        responses: {
            /** @description V铆nculo creado */
            201: {
                headers: {
                    [name: string]: unknown;
                };
                content: {
                    "application/json": components["schemas"]["UserCompanyRole"];
                };
            };
        };
    };
    UserCompanyRoleController_findOne: {
        parameters: {
            query?: never;
            header?: never;
            path: {
                /** @description UUID del v铆nculo */
                id: string;
            };
            cookie?: never;
        };
        requestBody?: never;
        responses: {
            /** @description V铆nculo encontrado */
            200: {
                headers: {
                    [name: string]: unknown;
                };
                content: {
                    "application/json": components["schemas"]["UserCompanyRole"];
                };
            };
            /** @description No encontrado */
            404: {
                headers: {
                    [name: string]: unknown;
                };
                content?: never;
            };
        };
    };
    UserCompanyRoleController_remove: {
        parameters: {
            query?: never;
            header?: never;
            path: {
                /** @description UUID del v铆nculo */
                id: string;
            };
            cookie?: never;
        };
        requestBody?: never;
        responses: {
            /** @description V铆nculo eliminado */
            200: {
                headers: {
                    [name: string]: unknown;
                };
                content: {
                    "application/json": components["schemas"]["UserCompanyRole"];
                };
            };
            /** @description No encontrado */
            404: {
                headers: {
                    [name: string]: unknown;
                };
                content?: never;
            };
        };
    };
    UserCompanyRoleController_update: {
        parameters: {
            query?: never;
            header?: never;
            path: {
                /** @description UUID del v铆nculo */
                id: string;
            };
            cookie?: never;
        };
        requestBody: {
            content: {
                "application/json": components["schemas"]["UpdateUserCompanyRoleDto"];
            };
        };
        responses: {
            /** @description V铆nculo actualizado */
            200: {
                headers: {
                    [name: string]: unknown;
                };
                content: {
                    "application/json": components["schemas"]["UserCompanyRole"];
                };
            };
            /** @description No encontrado */
            404: {
                headers: {
                    [name: string]: unknown;
                };
                content?: never;
            };
        };
    };
    CompanyController_createLegalCompany: {
        parameters: {
            query?: never;
            header?: never;
            path?: never;
            cookie?: never;
        };
        requestBody: {
            content: {
                "application/json": components["schemas"]["CreateCompanyLegalDto"];
            };
        };
        responses: {
            201: {
                headers: {
                    [name: string]: unknown;
                };
                content?: never;
            };
        };
    };
    CompanyController_getMyCompanies: {
        parameters: {
            query?: never;
            header?: never;
            path?: never;
            cookie?: never;
        };
        requestBody?: never;
        responses: {
            200: {
                headers: {
                    [name: string]: unknown;
                };
                content?: never;
            };
        };
    };
    CompanyController_findAll: {
        parameters: {
            query?: never;
            header?: never;
            path?: never;
            cookie?: never;
        };
        requestBody?: never;
        responses: {
            200: {
                headers: {
                    [name: string]: unknown;
                };
                content?: never;
            };
        };
    };
    ClientProfileController_findAll: {
        parameters: {
            query?: never;
            header?: never;
            path: {
                companyId: string;
            };
            cookie?: never;
        };
        requestBody?: never;
        responses: {
            200: {
                headers: {
                    [name: string]: unknown;
                };
                content?: never;
            };
        };
    };
    ClientProfileController_create: {
        parameters: {
            query?: never;
            header?: never;
            path: {
                /** @description UUID de la empresa */
                companyId: string;
            };
            cookie?: never;
        };
        requestBody: {
            content: {
                "application/json": components["schemas"]["CreateClientProfileDto"];
            };
        };
        responses: {
            201: {
                headers: {
                    [name: string]: unknown;
                };
                content?: never;
            };
        };
    };
    ClientProfileController_findOne: {
        parameters: {
            query?: never;
            header?: never;
            path: {
                id: string;
            };
            cookie?: never;
        };
        requestBody?: never;
        responses: {
            200: {
                headers: {
                    [name: string]: unknown;
                };
                content?: never;
            };
        };
    };
    ClientProfileController_remove: {
        parameters: {
            query?: never;
            header?: never;
            path: {
                id: string;
            };
            cookie?: never;
        };
        requestBody?: never;
        responses: {
            200: {
                headers: {
                    [name: string]: unknown;
                };
                content?: never;
            };
        };
    };
    ClientProfileController_update: {
        parameters: {
            query?: never;
            header?: never;
            path: {
                id: string;
            };
            cookie?: never;
        };
        requestBody: {
            content: {
                "application/json": components["schemas"]["UpdateClientProfileDto"];
            };
        };
        responses: {
            200: {
                headers: {
                    [name: string]: unknown;
                };
                content?: never;
            };
        };
    };
    AuthController_login: {
        parameters: {
            query?: never;
            header?: never;
            path?: never;
            cookie?: never;
        };
        requestBody: {
            content: {
                "application/json": components["schemas"]["LoginDto"];
            };
        };
        responses: {
            /** @description Login correcto */
            201: {
                headers: {
                    [name: string]: unknown;
                };
                content: {
                    "application/json": components["schemas"]["TokensDto"];
                };
            };
        };
    };
    AuthController_refresh: {
        parameters: {
            query?: never;
            header?: never;
            path?: never;
            cookie?: never;
        };
        requestBody?: never;
        responses: {
            /** @description Tokens renovados */
            201: {
                headers: {
                    [name: string]: unknown;
                };
                content: {
                    "application/json": components["schemas"]["TokensDto"];
                };
            };
        };
    };
    AuthController_logout: {
        parameters: {
            query?: never;
            header?: never;
            path?: never;
            cookie?: never;
        };
        requestBody?: never;
        responses: {
            /** @description Logout correcto */
            200: {
                headers: {
                    [name: string]: unknown;
                };
                content?: never;
            };
        };
    };
    CompanyContextController_selectCompany: {
        parameters: {
            query?: never;
            header?: never;
            path?: never;
            cookie?: never;
        };
        requestBody: {
            content: {
                "application/json": components["schemas"]["SelectCompanyDto"];
            };
        };
        responses: {
            /** @description Nuevo accessToken con empresa seleccionada */
            200: {
                headers: {
                    [name: string]: unknown;
                };
                content?: never;
            };
        };
    };
    AddressController_findAllForCompany: {
        parameters: {
            query?: {
                /** @description Incluye direcciones inactivas */
                showInactive?: boolean;
            };
            header?: never;
            path: {
                /** @description UUID de la empresa */
                companyId: string;
            };
            cookie?: never;
        };
        requestBody?: never;
        responses: {
            /** @description Listado de direcciones */
            200: {
                headers: {
                    [name: string]: unknown;
                };
                content: {
                    "application/json": components["schemas"]["Address"][];
                };
            };
        };
    };
    AddressController_createForCompany: {
        parameters: {
            query?: never;
            header?: never;
            path: {
                /** @description UUID de la empresa */
                companyId: string;
            };
            cookie?: never;
        };
        requestBody: {
            content: {
                "application/json": components["schemas"]["CreateAddressDto"];
            };
        };
        responses: {
            /** @description Direcci贸n creada correctamente */
            201: {
                headers: {
                    [name: string]: unknown;
                };
                content: {
                    "application/json": components["schemas"]["Address"];
                };
            };
        };
    };
    AddressController_findOneForCompany: {
        parameters: {
            query?: never;
            header?: never;
            path: {
                /** @description UUID de la empresa */
                companyId: string;
                /** @description UUID de la direcci贸n */
                addressId: string;
            };
            cookie?: never;
        };
        requestBody?: never;
        responses: {
            /** @description Direcci贸n encontrada */
            200: {
                headers: {
                    [name: string]: unknown;
                };
                content: {
                    "application/json": components["schemas"]["Address"];
                };
            };
        };
    };
    AddressController_removeForCompany: {
        parameters: {
            query?: never;
            header?: never;
            path: {
                /** @description UUID de la empresa */
                companyId: string;
                /** @description UUID de la direcci贸n */
                addressId: string;
            };
            cookie?: never;
        };
        requestBody?: never;
        responses: {
            /** @description Direcci贸n desactivada correctamente */
            200: {
                headers: {
                    [name: string]: unknown;
                };
                content?: never;
            };
        };
    };
    AddressController_updateForCompany: {
        parameters: {
            query?: never;
            header?: never;
            path: {
                /** @description UUID de la empresa */
                companyId: string;
                /** @description UUID de la direcci贸n */
                addressId: string;
            };
            cookie?: never;
        };
        requestBody: {
            content: {
                "application/json": components["schemas"]["UpdateAddressDto"];
            };
        };
        responses: {
            /** @description Direcci贸n actualizada */
            200: {
                headers: {
                    [name: string]: unknown;
                };
                content: {
                    "application/json": components["schemas"]["Address"];
                };
            };
        };
    };
    ContactController_findAll: {
        parameters: {
            query?: never;
            header?: never;
            path?: never;
            cookie?: never;
        };
        requestBody?: never;
        responses: {
            /** @description Lista de contactos activos */
            200: {
                headers: {
                    [name: string]: unknown;
                };
                content: {
                    "application/json": components["schemas"]["Contact"][];
                };
            };
        };
    };
    ContactController_create: {
        parameters: {
            query?: never;
            header?: never;
            path?: never;
            cookie?: never;
        };
        requestBody: {
            content: {
                "application/json": components["schemas"]["CreateContactDto"];
            };
        };
        responses: {
            /** @description Contacto creado correctamente */
            201: {
                headers: {
                    [name: string]: unknown;
                };
                content: {
                    "application/json": components["schemas"]["Contact"];
                };
            };
        };
    };
    ContactController_findInactive: {
        parameters: {
            query?: never;
            header?: never;
            path?: never;
            cookie?: never;
        };
        requestBody?: never;
        responses: {
            /** @description Lista de contactos inactivos */
            200: {
                headers: {
                    [name: string]: unknown;
                };
                content: {
                    "application/json": components["schemas"]["Contact"][];
                };
            };
        };
    };
    ContactController_findOne: {
        parameters: {
            query?: never;
            header?: never;
            path: {
                id: string;
            };
            cookie?: never;
        };
        requestBody?: never;
        responses: {
            /** @description Contacto encontrado */
            200: {
                headers: {
                    [name: string]: unknown;
                };
                content: {
                    "application/json": components["schemas"]["Contact"];
                };
            };
            /** @description No encontrado */
            404: {
                headers: {
                    [name: string]: unknown;
                };
                content?: never;
            };
        };
    };
    ContactController_remove: {
        parameters: {
            query?: never;
            header?: never;
            path: {
                id: string;
            };
            cookie?: never;
        };
        requestBody?: never;
        responses: {
            /** @description Contacto eliminado */
            200: {
                headers: {
                    [name: string]: unknown;
                };
                content: {
                    "application/json": components["schemas"]["Contact"];
                };
            };
            /** @description No encontrado */
            404: {
                headers: {
                    [name: string]: unknown;
                };
                content?: never;
            };
        };
    };
    ContactController_update: {
        parameters: {
            query?: never;
            header?: never;
            path: {
                id: string;
            };
            cookie?: never;
        };
        requestBody: {
            content: {
                "application/json": components["schemas"]["UpdateContactDto"];
            };
        };
        responses: {
            /** @description Contacto actualizado */
            200: {
                headers: {
                    [name: string]: unknown;
                };
                content: {
                    "application/json": components["schemas"]["Contact"];
                };
            };
            /** @description No encontrado */
            404: {
                headers: {
                    [name: string]: unknown;
                };
                content?: never;
            };
        };
    };
    ClientController_findAll: {
        parameters: {
            query?: never;
            header?: never;
            path?: never;
            cookie?: never;
        };
        requestBody?: never;
        responses: {
            200: {
                headers: {
                    [name: string]: unknown;
                };
                content?: never;
            };
        };
    };
    ClientController_create: {
        parameters: {
            query?: never;
            header?: never;
            path?: never;
            cookie?: never;
        };
        requestBody: {
            content: {
                "application/json": components["schemas"]["CreateClientDto"];
            };
        };
        responses: {
            201: {
                headers: {
                    [name: string]: unknown;
                };
                content?: never;
            };
        };
    };
    ClientController_findOne: {
        parameters: {
            query?: never;
            header?: never;
            path: {
                id: string;
            };
            cookie?: never;
        };
        requestBody?: never;
        responses: {
            200: {
                headers: {
                    [name: string]: unknown;
                };
                content?: never;
            };
        };
    };
    ClientController_remove: {
        parameters: {
            query?: never;
            header?: never;
            path: {
                id: string;
            };
            cookie?: never;
        };
        requestBody?: never;
        responses: {
            200: {
                headers: {
                    [name: string]: unknown;
                };
                content?: never;
            };
        };
    };
    ClientController_update: {
        parameters: {
            query?: never;
            header?: never;
            path: {
                id: string;
            };
            cookie?: never;
        };
        requestBody: {
            content: {
                "application/json": components["schemas"]["UpdateClientDto"];
            };
        };
        responses: {
            200: {
                headers: {
                    [name: string]: unknown;
                };
                content?: never;
            };
        };
    };
    PropertyController_findAll: {
        parameters: {
            query?: never;
            header?: never;
            path: {
                companyId: string;
            };
            cookie?: never;
        };
        requestBody?: never;
        responses: {
            200: {
                headers: {
                    [name: string]: unknown;
                };
                content?: never;
            };
        };
    };
    PropertyController_create: {
        parameters: {
            query?: never;
            header?: never;
            path: {
                companyId: string;
            };
            cookie?: never;
        };
        requestBody: {
            content: {
                "application/json": components["schemas"]["CreatePropertyDto"];
            };
        };
        responses: {
            201: {
                headers: {
                    [name: string]: unknown;
                };
                content: {
                    "application/json": components["schemas"]["Property"];
                };
            };
        };
    };
    PropertyController_findOne: {
        parameters: {
            query?: never;
            header?: never;
            path: {
                companyId: string;
                propertyId: string;
            };
            cookie?: never;
        };
        requestBody?: never;
        responses: {
            200: {
                headers: {
                    [name: string]: unknown;
                };
                content?: never;
            };
        };
    };
    PropertyController_remove: {
        parameters: {
            query?: never;
            header?: never;
            path: {
                companyId: string;
                propertyId: string;
            };
            cookie?: never;
        };
        requestBody?: never;
        responses: {
            200: {
                headers: {
                    [name: string]: unknown;
                };
                content?: never;
            };
        };
    };
    PropertyController_update: {
        parameters: {
            query?: never;
            header?: never;
            path: {
                companyId: string;
                propertyId: string;
            };
            cookie?: never;
        };
        requestBody: {
            content: {
                "application/json": components["schemas"]["UpdatePropertyDto"];
            };
        };
        responses: {
            200: {
                headers: {
                    [name: string]: unknown;
                };
                content?: never;
            };
        };
    };
    ContractController_findAllForCompany: {
        parameters: {
            query?: {
                /** @description Incluye contratos inactivos */
                showInactive?: boolean;
            };
            header?: never;
            path: {
                /** @description UUID de la empresa */
                companyId: string;
            };
            cookie?: never;
        };
        requestBody?: never;
        responses: {
            /** @description Listado de contratos */
            200: {
                headers: {
                    [name: string]: unknown;
                };
                content: {
                    "application/json": components["schemas"]["Contract"][];
                };
            };
        };
    };
    ContractController_createForCompany: {
        parameters: {
            query?: never;
            header?: never;
            path: {
                /** @description UUID de la empresa */
                companyId: string;
            };
            cookie?: never;
        };
        requestBody: {
            content: {
                "application/json": components["schemas"]["CreateContractDto"];
            };
        };
        responses: {
            /** @description Contrato creado correctamente */
            201: {
                headers: {
                    [name: string]: unknown;
                };
                content: {
                    "application/json": components["schemas"]["Contract"];
                };
            };
        };
    };
    ContractController_findOneForCompany: {
        parameters: {
            query?: never;
            header?: never;
            path: {
                /** @description UUID de la empresa */
                companyId: string;
                /** @description UUID del contrato */
                contractId: string;
            };
            cookie?: never;
        };
        requestBody?: never;
        responses: {
            /** @description Contrato encontrado */
            200: {
                headers: {
                    [name: string]: unknown;
                };
                content: {
                    "application/json": components["schemas"]["Contract"];
                };
            };
        };
    };
    ContractController_removeForCompany: {
        parameters: {
            query?: never;
            header?: never;
            path: {
                /** @description UUID de la empresa */
                companyId: string;
                /** @description UUID del contrato */
                contractId: string;
            };
            cookie?: never;
        };
        requestBody?: never;
        responses: {
            /** @description Contrato desactivado correctamente */
            200: {
                headers: {
                    [name: string]: unknown;
                };
                content?: never;
            };
        };
    };
    ContractController_updateForCompany: {
        parameters: {
            query?: never;
            header?: never;
            path: {
                /** @description UUID de la empresa */
                companyId: string;
                /** @description UUID del contrato */
                contractId: string;
            };
            cookie?: never;
        };
        requestBody: {
            content: {
                "application/json": components["schemas"]["UpdateContractDto"];
            };
        };
        responses: {
            /** @description Contrato actualizado */
            200: {
                headers: {
                    [name: string]: unknown;
                };
                content: {
                    "application/json": components["schemas"]["Contract"];
                };
            };
        };
    };
}
</file>

<file path="src/auth/decorators/auth.decorator.ts">
import { applyDecorators, UseGuards } from '@nestjs/common';
import { AppRole } from '../enums/user-global-role.enum';
import { Roles } from './roles.decorator';
import { JwtAuthGuard } from '../guards/jwt-auth.guard';
import { RolesGuard } from '../guards/roles.guard';
import { ApiBearerAuth, ApiUnauthorizedResponse } from '@nestjs/swagger';

export function Auth(...roles: AppRole[]) {
  return applyDecorators(
    Roles(...roles),           // 1. Define qu茅 roles pueden entrar
    UseGuards(JwtAuthGuard, RolesGuard), // 2. Activa la seguridad JWT y de Roles
    ApiBearerAuth(),                        // 3. Documentaci贸n en Swagger (candadito)
    ApiUnauthorizedResponse({ description: 'Unauthorized' }),
  );
}
</file>

<file path="src/auth/decorators/get-user.decorator.ts">
import { createParamDecorator, ExecutionContext } from '@nestjs/common';

export const GetUser = createParamDecorator(
  (data: string | undefined, ctx: ExecutionContext) => {
    const request = ctx.switchToHttp().getRequest();
    const user = request.user;

    // Si pasamos un campo: @GetUser('sub')  devuelve user.sub
    // Si no pasamos nada: @GetUser()  devuelve el objeto completo
    return data ? user?.[data] : user;
  },
);
</file>

<file path="src/auth/decorators/user.decorator.ts">
import { createParamDecorator, ExecutionContext } from '@nestjs/common';

export const User = createParamDecorator(
  (data: string | undefined, ctx: ExecutionContext) => {
    const request = ctx.switchToHttp().getRequest();
    const user = request.user;
    return data ? user?.[data] : user;
  },
);
</file>

<file path="src/auth/dto/refresh-token.dto.ts">
import { ApiProperty } from '@nestjs/swagger';
import { IsString } from 'class-validator';

/**
 * RefreshTokenDto
 *
 * Usado por:
 * POST /auth/refresh
 *
 * Necesario para que Swagger / OpenAPI
 * genere tipos correctos en el frontend
 */
export class RefreshTokenDto {
  @ApiProperty({
    description: 'Refresh token JWT',
    example: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...',
  })
  @IsString()
  refreshToken: string;
}
</file>

<file path="src/auth/guards/local-auth.guard.ts">
import { Injectable } from "@nestjs/common";
import { AuthGuard } from "@nestjs/passport";

@Injectable()
export class LocalAuthGuard extends AuthGuard('local'){}
</file>

<file path="src/auth/strategies/local.strategy.ts">
import { Injectable, UnauthorizedException } from '@nestjs/common';
import { PassportStrategy } from '@nestjs/passport';
import { Strategy } from 'passport-local';
import { AuthService } from '../auth.service';

@Injectable()
export class LocalStrategy extends PassportStrategy(Strategy, 'local') {
  constructor(private readonly authService: AuthService) {
    super({ usernameField: 'email' } as any); //  casting
  }

  async validate(email: string, password: string) {
    const user = await this.authService.validateUser(email, password); //  corrige typo
    if (!user) throw new UnauthorizedException('Invalid credentials');
    return user;
  }
}
</file>

<file path="src/client-profile/dto/update-client-profile.dto.ts">
import { PartialType } from '@nestjs/swagger';
import { CreateClientProfileDto } from './create-client-profile.dto';

export class UpdateClientProfileDto extends PartialType(CreateClientProfileDto) {}
</file>

<file path="src/client/client.controller.ts">
import { Controller, Get, Post, Body, Patch, Param, Delete } from '@nestjs/common';
import { ClientService } from './client.service';
import { CreateClientDto } from './dto/create-client.dto';
import { UpdateClientDto } from './dto/update-client.dto';
import { ApiTags } from '@nestjs/swagger';

@ApiTags('clients')
@Controller('client')
export class ClientController {
  constructor(private readonly clientService: ClientService) {}

  @Post()
  create(@Body() createClientDto: CreateClientDto) {
    return this.clientService.create(createClientDto);
  }

  @Get()
  findAll() {
    return this.clientService.findAll();
  }

  @Get(':id')
  findOne(@Param('id') id: string) {
    return this.clientService.findOne(+id);
  }

  @Patch(':id')
  update(@Param('id') id: string, @Body() updateClientDto: UpdateClientDto) {
    return this.clientService.update(+id, updateClientDto);
  }

  @Delete(':id')
  remove(@Param('id') id: string) {
    return this.clientService.remove(+id);
  }
}
</file>

<file path="src/client/client.module.ts">
import { Module } from '@nestjs/common';
import { ClientService } from './client.service';
import { ClientController } from './client.controller';

@Module({
  controllers: [ClientController],
  providers: [ClientService],
})
export class ClientModule {}
</file>

<file path="src/client/client.service.ts">
import { Injectable } from '@nestjs/common';
import { CreateClientDto } from './dto/create-client.dto';
import { UpdateClientDto } from './dto/update-client.dto';

@Injectable()
export class ClientService {
  create(createClientDto: CreateClientDto) {
    return 'This action adds a new client';
  }

  findAll() {
    return `This action returns all client`;
  }

  findOne(id: number) {
    return `This action returns a #${id} client`;
  }

  update(id: number, updateClientDto: UpdateClientDto) {
    return `This action updates a #${id} client`;
  }

  remove(id: number) {
    return `This action removes a #${id} client`;
  }
}
</file>

<file path="src/client/dto/create-client.dto.ts">
import { ApiProperty } from '@nestjs/swagger';
import { IsUUID } from 'class-validator';

export class CreateClientDto {

  @ApiProperty({
    description: 'Empresa propietaria del cliente',
    example: 'f2a1e0d9-4c6a-4d1e-9b3a-1c2d3e4f5678',
  })
  @IsUUID()
  companyId: string;

  @ApiProperty({
    description: 'Identidad fiscal del cliente (FacturaeParty)',
    example: 'c1b2a3d4-1111-4aaa-9bbb-ccccdddd0000',
  })
  @IsUUID()
  facturaePartyId: string;

  @ApiProperty({
    description: 'Direcci贸n fiscal del cliente',
    example: 'd4e5f6a7-2222-4bbb-8ccc-ddddeeeeffff',
  })
  @IsUUID()
  fiscalAddressId: string;
}
</file>

<file path="src/client/dto/update-client.dto.ts">
import { PartialType } from '@nestjs/swagger';
import { CreateClientDto } from './create-client.dto';

export class UpdateClientDto extends PartialType(CreateClientDto) {}
</file>

<file path="src/common/base/tenant-scoped.entity.ts">
import { Column } from 'typeorm';
import { BaseEntity } from './base.entity';

export abstract class TenantScopedEntity extends BaseEntity {
  @Column({ name: 'company_id', type: 'uuid' })
  companyId: string;
}
</file>

<file path="src/common/catalogs/taxes/base/fiscal-rate.entity.ts">
import {
  PrimaryGeneratedColumn,
  Column,
  CreateDateColumn,
  UpdateDateColumn,
} from 'typeorm';
import { ApiProperty } from '@nestjs/swagger';

export abstract class FiscalRateEntity {
  @ApiProperty({ format: 'uuid' })
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @ApiProperty({
    description: 'Tipo fiscal (ej: IVA_GENERAL, IRPF)',
    example: 'IVA_GENERAL',
  })
  @Column()
  tipo: string;

  @ApiProperty({
    description: 'Descripci贸n legible',
    example: 'IVA general',
  })
  @Column()
  descripcion: string;

  @ApiProperty({
    description: 'Porcentaje aplicado',
    example: 21,
  })
  @Column({ type: 'decimal', precision: 5, scale: 2 })
  porcentaje: number;

  @ApiProperty({
    description: 'Pa铆s (ISO-3166-1 alpha-2)',
    example: 'ES',
  })
  @Column({ name: 'country_code', length: 2 })
  countryCode: string;

  @ApiProperty({
    description: 'Indica si es el valor por defecto',
  })
  @Column({ name: 'is_default', default: false })
  isDefault: boolean;

  @ApiProperty({
    description: 'Indica si est谩 activo',
  })
  @Column({ name: 'is_active', default: true })
  isActive: boolean;

  @CreateDateColumn({ name: 'created_at' })
  createdAt: Date;

  @UpdateDateColumn({ name: 'updated_at' })
  updatedAt: Date;
}
</file>

<file path="src/common/catalogs/taxes/taxes.module.ts">
import { Module } from '@nestjs/common';

import { VatRateModule } from './vat-rate/vat-rate.module';
import { WithholdingRateModule } from './withholding-rate/withholding-rate.module';

@Module({
  imports: [VatRateModule, WithholdingRateModule],
  exports: [VatRateModule, WithholdingRateModule],
})
export class TaxesModule {}
</file>

<file path="src/common/catalogs/taxes/vat-rate/dto/create-vat-rate.dto.ts">
import { ApiProperty } from '@nestjs/swagger';
import {
  IsString,
  IsNumber,
  IsBoolean,
  IsOptional,
  IsISO31661Alpha2,
  Min,
  Max,
} from 'class-validator';

export class CreateVatRateDto {
  @ApiProperty({
    description: 'Tipo de IVA',
    example: 'IVA_GENERAL',
  })
  @IsString()
  tipo: string;

  @ApiProperty({
    description: 'Descripci贸n legible',
    example: 'IVA general',
  })
  @IsString()
  descripcion: string;

  @ApiProperty({
    description: 'Porcentaje de IVA',
    example: 21,
    minimum: 0,
    maximum: 100,
  })
  @IsNumber()
  @Min(0)
  @Max(100)
  porcentaje: number;

  @ApiProperty({
    description: 'C贸digo de pa铆s ISO-3166-1 alpha-2',
    example: 'ES',
  })
  @IsISO31661Alpha2()
  countryCode: string;

  @ApiProperty({
    description: 'Indica si es el IVA por defecto',
    example: false,
    required: false,
  })
  @IsOptional()
  @IsBoolean()
  isDefault?: boolean;

  @ApiProperty({
    description: 'Indica si el IVA est谩 activo',
    example: true,
    required: false,
  })
  @IsOptional()
  @IsBoolean()
  isActive?: boolean;
}
</file>

<file path="src/common/catalogs/taxes/vat-rate/dto/insex.ts">
export * from './create-vat-rate.dto';
export * from './update-vat-rate.dto';
</file>

<file path="src/common/catalogs/taxes/vat-rate/dto/update-vat-rate.dto.ts">
import { PartialType } from '@nestjs/swagger';
import { CreateVatRateDto } from './create-vat-rate.dto';

export class UpdateVatRateDto extends PartialType(CreateVatRateDto) {}
</file>

<file path="src/common/catalogs/taxes/vat-rate/vat-rate.entity.ts">
import { Entity } from 'typeorm';
import { FiscalRateEntity } from '../base/fiscal-rate.entity';

@Entity('vat_rates')
export class VatRate extends FiscalRateEntity {}
</file>

<file path="src/common/catalogs/taxes/vat-rate/vat-rate.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';

import { VatRate } from './vat-rate.entity';
import { VatRateService } from './vat-rate.service';
import { VatRateController } from './vat-rate.controller';

@Module({
  imports: [TypeOrmModule.forFeature([VatRate])],
  controllers: [VatRateController],
  providers: [VatRateService],
  exports: [VatRateService],
})
export class VatRateModule {}
</file>

<file path="src/common/catalogs/taxes/vat-rate/vat-rate.service.ts">
import { Injectable, ConflictException } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';

import { VatRate } from './vat-rate.entity';
import { CreateVatRateDto } from './dto/create-vat-rate.dto';
import { UpdateVatRateDto } from './dto/update-vat-rate.dto';

@Injectable()
export class VatRateService {
  constructor(
    @InjectRepository(VatRate)
    private readonly vatRateRepo: Repository<VatRate>,
  ) {}

  /* 
   * Crear tipo de IVA
   *  */
  async create(dto: CreateVatRateDto): Promise<VatRate> {
    /**
     * Regla: solo un IVA por defecto por pa铆s
     */
    if (dto.isDefault) {
      const existingDefault = await this.vatRateRepo.findOne({
        where: {
          countryCode: dto.countryCode,
          isDefault: true,
          isActive: true,
        },
      });

      if (existingDefault) {
        throw new ConflictException(
          'Ya existe un IVA por defecto para este pa铆s',
        );
      }
    }

    const vatRate = this.vatRateRepo.create(dto);
    return this.vatRateRepo.save(vatRate);
  }

  /* 
   * Listar IVAs por pa铆s
   *  */
  async findAll(
    countryCode: string,
    options?: { includeInactive?: boolean },
  ): Promise<VatRate[]> {
    return this.vatRateRepo.find({
      where: {
        countryCode,
        ...(options?.includeInactive ? {} : { isActive: true }),
      },
      order: {
        porcentaje: 'DESC',
      },
    });
  }

  /* 
   * Obtener IVA concreto
   *  */
  async findOne(id: string): Promise<VatRate | null> {
    return this.vatRateRepo.findOne({ where: { id } });
  }

  /* 
   * Actualizar IVA
   *  */
  async update(
    id: string,
    dto: UpdateVatRateDto,
  ): Promise<VatRate | null> {
    const vatRate = await this.vatRateRepo.findOne({ where: { id } });
    if (!vatRate) return null;

    /**
     * Si se marca como default, invalidar otros defaults del pa铆s
     */
    if (dto.isDefault === true && !vatRate.isDefault) {
      await this.vatRateRepo.update(
        {
          countryCode: vatRate.countryCode,
          isDefault: true,
        },
        { isDefault: false },
      );
    }

    Object.assign(vatRate, dto);
    return this.vatRateRepo.save(vatRate);
  }

  /* 
   * Soft delete
   *  */
  async deactivate(id: string): Promise<boolean> {
    const vatRate = await this.vatRateRepo.findOne({
      where: { id, isActive: true },
    });

    if (!vatRate) return false;

    vatRate.isActive = false;
    vatRate.isDefault = false;

    await this.vatRateRepo.save(vatRate);
    return true;
  }
}
</file>

<file path="src/common/catalogs/taxes/withholding-rate/dto/create-withholding-rate.dto.ts">
import { ApiProperty } from '@nestjs/swagger';
import {
  IsString,
  IsNumber,
  IsBoolean,
  IsOptional,
  IsISO31661Alpha2,
  Min,
  Max,
} from 'class-validator';

export class CreateWithholdingRateDto {
  @ApiProperty({
    description: 'Tipo de retenci贸n',
    example: 'IRPF',
  })
  @IsString()
  tipo: string;

  @ApiProperty({
    description: 'Descripci贸n legible',
    example: 'Retenci贸n IRPF general',
  })
  @IsString()
  descripcion: string;

  @ApiProperty({
    description: 'Porcentaje de retenci贸n',
    example: 19,
    minimum: 0,
    maximum: 100,
  })
  @IsNumber()
  @Min(0)
  @Max(100)
  porcentaje: number;

  @ApiProperty({
    description: 'C贸digo de pa铆s ISO-3166-1 alpha-2',
    example: 'ES',
  })
  @IsISO31661Alpha2()
  countryCode: string;

  @ApiProperty({
    description: 'Indica si es la retenci贸n por defecto',
    example: false,
    required: false,
  })
  @IsOptional()
  @IsBoolean()
  isDefault?: boolean;

  @ApiProperty({
    description: 'Indica si la retenci贸n est谩 activa',
    example: true,
    required: false,
  })
  @IsOptional()
  @IsBoolean()
  isActive?: boolean;
}
</file>

<file path="src/common/catalogs/taxes/withholding-rate/dto/index.ts">
export * from './create-withholding-rate.dto';
export * from './update-withholding-rate.dto';
</file>

<file path="src/common/catalogs/taxes/withholding-rate/dto/update-withholding-rate.dto.ts">
import { PartialType } from '@nestjs/swagger';
import { CreateWithholdingRateDto } from './create-withholding-rate.dto';

export class UpdateWithholdingRateDto extends PartialType(
  CreateWithholdingRateDto,
) {}
</file>

<file path="src/common/catalogs/taxes/withholding-rate/withholding-rate.entity.ts">
import { Entity } from 'typeorm';
import { FiscalRateEntity } from '../base/fiscal-rate.entity';

@Entity('withholding_rates')
export class WithholdingRate extends FiscalRateEntity {}
</file>

<file path="src/common/catalogs/taxes/withholding-rate/withholding-rate.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';

import { WithholdingRate } from './withholding-rate.entity';
import { WithholdingRateService } from './withholding-rate.service';
import { WithholdingRateController } from './withholding-rate.controller';

@Module({
  imports: [TypeOrmModule.forFeature([WithholdingRate])],
  controllers: [WithholdingRateController],
  providers: [WithholdingRateService],
  exports: [WithholdingRateService],
})
export class WithholdingRateModule {}
</file>

<file path="src/common/catalogs/taxes/withholding-rate/withholding-rate.service.ts">
import { Injectable, ConflictException } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';

import { WithholdingRate } from './withholding-rate.entity';
import { CreateWithholdingRateDto, UpdateWithholdingRateDto } from './dto';

@Injectable()
export class WithholdingRateService {
  constructor(
    @InjectRepository(WithholdingRate)
    private readonly withholdingRepo: Repository<WithholdingRate>,
  ) {}

  /* 
   * Crear retenci贸n
   *  */
  async create(
    dto: CreateWithholdingRateDto,
  ): Promise<WithholdingRate> {
    if (dto.isDefault) {
      const existingDefault = await this.withholdingRepo.findOne({
        where: {
          countryCode: dto.countryCode,
          isDefault: true,
          isActive: true,
        },
      });

      if (existingDefault) {
        throw new ConflictException(
          'Ya existe una retenci贸n por defecto para este pa铆s',
        );
      }
    }

    const rate = this.withholdingRepo.create(dto);
    return this.withholdingRepo.save(rate);
  }

  /* 
   * Listar retenciones por pa铆s
   *  */
  async findAll(
    countryCode: string,
    options?: { includeInactive?: boolean },
  ): Promise<WithholdingRate[]> {
    return this.withholdingRepo.find({
      where: {
        countryCode,
        ...(options?.includeInactive ? {} : { isActive: true }),
      },
      order: {
        porcentaje: 'DESC',
      },
    });
  }

  /* 
   * Obtener retenci贸n concreta
   *  */
  async findOne(id: string): Promise<WithholdingRate | null> {
    return this.withholdingRepo.findOne({ where: { id } });
  }

  /* 
   * Actualizar retenci贸n
   *  */
  async update(
    id: string,
    dto: UpdateWithholdingRateDto,
  ): Promise<WithholdingRate | null> {
    const rate = await this.withholdingRepo.findOne({ where: { id } });
    if (!rate) return null;

    if (dto.isDefault === true && !rate.isDefault) {
      await this.withholdingRepo.update(
        {
          countryCode: rate.countryCode,
          isDefault: true,
        },
        { isDefault: false },
      );
    }

    Object.assign(rate, dto);
    return this.withholdingRepo.save(rate);
  }

  /* 
   * Soft delete
   *  */
  async deactivate(id: string): Promise<boolean> {
    const rate = await this.withholdingRepo.findOne({
      where: { id, isActive: true },
    });

    if (!rate) return false;

    rate.isActive = false;
    rate.isDefault = false;

    await this.withholdingRepo.save(rate);
    return true;
  }
}
</file>

<file path="src/common/common.module.ts">
import { Module } from '@nestjs/common';

@Module({})
export class CommonModule {}
</file>

<file path="src/company/dto/updateCompany.dto.ts">
import { PartialType } from '@nestjs/swagger';
import { CreateCompanyDto } from './createCompany.dto';

export class UpdateCompanyDto extends PartialType(CreateCompanyDto) {}
</file>

<file path="src/config/config.module.ts">
import { Module } from '@nestjs/common';
import { ConfigModule as NestConfigModule } from '@nestjs/config';
import configuration from './configuration';
import { validate } from './validation';

@Module({
  imports: [
    NestConfigModule.forRoot({
      isGlobal: true,
      load: [configuration],
      validate,
    }),
  ],
})
export class ConfigModule {}
</file>

<file path="src/config/configuration.ts">
export default () => ({
  env: process.env.NODE_ENV || 'development',
  port: parseInt(process.env.PORT || '3000', 10),

  database: {
    host: process.env.DATABASE_HOST,
    port: parseInt(process.env.DATABASE_PORT || '5432', 10),
    user: process.env.DATABASE_USER,
    pass: process.env.DATABASE_PASS,
    name: process.env.DATABASE_NAME,
  },

  jwt: {
    accessSecret: process.env.JWT_ACCESS_SECRET,
    refreshSecret: process.env.JWT_REFRESH_SECRET,
    accessTtl: process.env.JWT_ACCESS_TTL || '900s',
    refreshTtl: process.env.JWT_REFRESH_TTL || '7d',
  },

  cors: {
    origins: (process.env.CORS_ORIGINS || '').split(',').filter(Boolean),
  },
});
</file>

<file path="src/config/validation.ts">
import { plainToInstance } from 'class-transformer';
import { IsEnum, IsNumber, IsString, validateSync } from 'class-validator';

enum Environment {
  Development = 'development',
  Production = 'production',
  Test = 'test',
}

class EnvironmentVariables {
  @IsEnum(Environment)
  NODE_ENV: Environment;

  @IsNumber()
  PORT: number;

  @IsString()
  DATABASE_HOST: string;

  @IsNumber()
  DATABASE_PORT: number;

  @IsString()
  DATABASE_USER: string;

  @IsString()
  DATABASE_PASS: string;

  @IsString()
  DATABASE_NAME: string;

  @IsString()
  JWT_ACCESS_SECRET: string;

  @IsString()
  JWT_REFRESH_SECRET: string;
}

export function validate(config: Record<string, unknown>) {
  const validatedConfig = plainToInstance(EnvironmentVariables, config, {
    enableImplicitConversion: true,
  });
  const errors = validateSync(validatedConfig, { skipMissingProperties: false });
  if (errors.length > 0) {
    throw new Error(errors.toString());
  }
  return validatedConfig;
}
</file>

<file path="src/contact/contact.module.ts">
import { Module } from '@nestjs/common';
import { ContactService } from './contact.service';
import { ContactController } from './contact.controller';
import { TypeOrmModule } from '@nestjs/typeorm';
import { Contact } from './entities/contact.entity';

@Module({
  imports: [
    TypeOrmModule.forFeature([Contact]),
  ],
  controllers: [ContactController],
  providers: [ContactService],
  exports: [ContactService],
})
export class ContactModule {}
</file>

<file path="src/contact/dto/update-contact.dto.ts">
import { PartialType } from '@nestjs/swagger';
import { CreateContactDto } from './create-contact.dto';

export class UpdateContactDto extends PartialType(CreateContactDto) {}
</file>

<file path="src/contract/contract.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';

import { ContractService } from './contract.service';
import { ContractController } from './contract.controller';
import { Contract } from './entities/contract.entity';

import { ClientModule } from '../client/client.module';
import { PropertyModule } from '../property/property.module';
import { CompanyModule } from '../company/company.module';
import { TaxModule } from 'src/tax/tax.module';
import { Property } from 'src/property/entities/property.entity';
import { Client } from 'src/client/entities/client.entity';
import { Company } from 'src/company/entities/company.entity';
import { Tax } from 'src/tax/entities/tax.entity';

@Module({
  imports: [
    TypeOrmModule.forFeature([Contract, Property, Client, Company, Tax,]),
  ],
  controllers: [ContractController],
  providers: [ContractService],
  exports: [ContractService],
})
export class ContractModule { }
</file>

<file path="src/contract/contract.service.ts">
import { 
  BadRequestException, 
  Injectable, 
  NotFoundException 
} from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { Contract } from './entities/contract.entity';
import { CreateContractDto } from './dto/create-contract.dto';
import { Property } from 'src/property/entities/property.entity';
import { Client } from 'src/client/entities/client.entity';
import { Tax } from 'src/tax/entities/tax.entity';

@Injectable()
export class ContractService {
  constructor(
    @InjectRepository(Contract)
    private readonly contractRepository: Repository<Contract>,
    @InjectRepository(Property)
    private readonly propertyRepository: Repository<Property>,
    @InjectRepository(Client)
    private readonly clientRepository: Repository<Client>,
    @InjectRepository(Tax)
    private readonly taxRepository: Repository<Tax>,
  ) {}

  async create(createContractDto: CreateContractDto): Promise<Contract> {
    const { 
      companyId, 
      propertyId, 
      clientId, 
      taxId, 
      retentionId 
    } = createContractDto;

    // 1. VALIDAR PROPIEDAD
    const property = await this.propertyRepository.findOneBy({ id: propertyId });
    if (!property) throw new NotFoundException('La propiedad no existe');
    
    // Seguridad: 驴La casa es de esta empresa?
    if (property.companyId !== companyId) {
      throw new BadRequestException('La propiedad no pertenece a la empresa indicada');
    }

    // 2. VALIDAR CLIENTE
    const client = await this.clientRepository.findOneBy({ id: clientId });
    if (!client) throw new NotFoundException('El cliente no existe');
    
    // Seguridad: 驴El cliente es de esta empresa?
    if (client.companyId !== companyId) {
      throw new BadRequestException('El cliente no pertenece a la empresa indicada');
    }

    // 3. VALIDAR IMPUESTOS (IVA)
    const tax = await this.taxRepository.findOneBy({ id: taxId });
    if (!tax) throw new BadRequestException('El impuesto (IVA) indicado no es v谩lido');

    // 4. CREAR CONTRATO
    const newContract = this.contractRepository.create({
      ...createContractDto,
      property, // Asignamos el objeto completo para evitar conflictos de ORM
      client,
      tax,
    });

    // 5. VALIDAR RETENCIN (Opcional)
    if (retentionId) {
      const retention = await this.taxRepository.findOneBy({ id: retentionId });
      if (!retention) throw new BadRequestException('La retenci贸n indicada no es v谩lida');
      newContract.retention = retention;
    }

    return await this.contractRepository.save(newContract);
  }

  async findAll(companyId: string): Promise<Contract[]> {
    return await this.contractRepository.find({
      where: { companyId }, // Filtramos siempre por empresa
      relations: ['property', 'client', 'tax'], // Datos para el listado
      order: { createdAt: 'DESC' },
    });
  }

  async findOne(id: string): Promise<Contract> {
    const contract = await this.contractRepository.findOne({
      where: { id },
      relations: ['property', 'client', 'tax', 'retention'],
    });

    if (!contract) throw new NotFoundException(`Contrato ${id} no encontrado`);
    return contract;
  }

  async remove(id: string): Promise<void> {
    const contract = await this.findOne(id);
    // Soft Delete gracias a tu BaseEntity
    await this.contractRepository.softRemove(contract);
  }
}
</file>

<file path="src/contract/dto/create-contract.dto.ts">
import { ApiProperty } from '@nestjs/swagger';
import { 
  IsBoolean, 
  IsDateString, 
  IsEnum, 
  IsInt, 
  IsNumber, 
  IsOptional, 
  IsString, 
  IsUUID, 
  Max, 
  Min 
} from 'class-validator';
import { 
  ContractStatus, 
  BillingPeriod, 
  ContractType, 
  PaymentMethod 
} from '../enums';

export class CreateContractDto {
  // --- IDENTIFICACIN ---
  @ApiProperty({ description: 'Referencia interna 煤nica', example: 'ALQ-2026/001' })
  @IsString()
  reference: string;

  @ApiProperty({ enum: ContractType, default: ContractType.ALQUILER })
  @IsEnum(ContractType)
  type: ContractType;

  // --- RELACIONES OBLIGATORIAS (Cierre de Seguridad) ---
  @ApiProperty({ description: 'UUID de la Empresa (Owner)' })
  @IsUUID()
  companyId: string;

  @ApiProperty({ description: 'UUID del Cliente (Inquilino)' })
  @IsUUID()
  clientId: string;

  @ApiProperty({ description: 'UUID de la Propiedad' })
  @IsUUID()
  propertyId: string;

  // --- ECONOMA & IMPUESTOS (Tax) ---
  @ApiProperty({ description: 'Renta mensual base', example: 1000.00 })
  @IsNumber({ maxDecimalPlaces: 2 })
  @Min(0)
  monthlyRent: number;

  @ApiProperty({ description: 'Fianza', example: 2000.00 })
  @IsNumber({ maxDecimalPlaces: 2 })
  @Min(0)
  depositAmount: number;

  @ApiProperty({ description: 'UUID del Impuesto IVA (Tax Entity)' })
  @IsUUID()
  taxId: string;

  @ApiProperty({ description: 'UUID de la Retenci贸n IRPF (Tax Entity)', required: false })
  @IsOptional()
  @IsUUID()
  retentionId?: string;

  // --- OPERATIVA DE PAGO (Ajuste "Bak" a UUID) ---
  @ApiProperty({ enum: PaymentMethod })
  @IsEnum(PaymentMethod)
  paymentMethod: PaymentMethod;

  @ApiProperty({ description: 'UUID de la Cuenta del Cliente (Seleccionada de su perfil)', required: false })
  @IsOptional()
  @IsUUID() // <--- CAMBIO: Forzamos UUID para evitar strings basura
  tenantBankAccountId?: string;

  @ApiProperty({ description: 'UUID de la Cuenta de la Empresa (Seleccionada de su perfil)', required: false })
  @IsOptional()
  @IsUUID() // <--- CAMBIO: Forzamos UUID
  companyBankAccountId?: string;

  // --- CICLO DE VIDA ---
  @ApiProperty({ enum: ContractStatus, default: ContractStatus.BORRADOR })
  @IsEnum(ContractStatus)
  status: ContractStatus;

  @ApiProperty({ description: 'Fecha inicio (YYYY-MM-DD)', example: '2026-01-01' })
  @IsDateString()
  startDate: string;

  @ApiProperty({ description: 'Fecha fin (YYYY-MM-DD)', required: false })
  @IsOptional()
  @IsDateString()
  endDate?: string;

  @ApiProperty({ description: 'D铆a de cobro programado (1-28)', example: 1 })
  @IsInt()
  @Min(1)
  @Max(28)
  billingDay: number;

  @ApiProperty({ enum: BillingPeriod })
  @IsEnum(BillingPeriod)
  billingPeriod: BillingPeriod;

  // --- AUTOMATIZACIN ---
  @ApiProperty({ description: 'Activar facturaci贸n autom谩tica', default: false })
  @IsOptional()
  @IsBoolean()
  isAutoBillingEnabled?: boolean;

  @ApiProperty({ description: 'Fecha l铆mite autofacturaci贸n', required: false })
  @IsOptional()
  @IsDateString()
  autoBillingUntil?: string;

  @ApiProperty({ description: 'URL del documento firmado', required: false })
  @IsOptional()
  @IsString()
  documentUrl?: string;
}
</file>

<file path="src/contract/dto/index.ts">
export * from './create-contract.dto';
export * from './update-contract.dto';
</file>

<file path="src/contract/dto/update-contract.dto.ts">
import { PartialType } from '@nestjs/swagger';
import { CreateContractDto } from './create-contract.dto';

export class UpdateContractDto extends PartialType(CreateContractDto) {}
</file>

<file path="src/contract/entities/contract.entity.ts">
import { Entity, Column, ManyToOne, JoinColumn, Index, DeleteDateColumn } from 'typeorm';
import { ApiProperty } from '@nestjs/swagger';
import { BaseEntity } from '../../common/base/base.entity';
import { Company } from '../../company/entities/company.entity';
import { Client } from '../../client/entities/client.entity';
import { Property } from '../../property/entities/property.entity';
import { Tax } from '../../tax/entities/tax.entity';
import { 
  ContractStatus, 
  BillingPeriod, 
  ContractType, 
  PaymentMethod 
} from '../enums';

@Entity('contracts')
export class Contract extends BaseEntity {
  // --------------------------------------------------------------------------
  // 1. IDENTIFICACIN Y TIPO
  // --------------------------------------------------------------------------
  @ApiProperty({ 
    description: 'Referencia 煤nica del contrato (ej. C贸digo interno)', 
    example: 'ALQ-2026/001' 
  })
  @Column({ unique: true })
  reference: string;

  @ApiProperty({ 
    description: 'Clasificaci贸n del contrato', 
    enum: ContractType,
    example: ContractType.ALQUILER
  })
  @Column({ type: 'enum', enum: ContractType, default: ContractType.ALQUILER })
  type: ContractType;

  // --------------------------------------------------------------------------
  // 2. CIERRE DE SEGURIDAD (RELACIONES CLAVE)
  // --------------------------------------------------------------------------
  
  @ApiProperty({ description: 'ID de la Empresa propietaria (Owner del dato)' })
  @Index() // ndice para b煤squedas r谩pidas de seguridad
  @Column()
  companyId: string;

  @ManyToOne(() => Company)
  @JoinColumn({ name: 'companyId' })
  company: Company;

  @ApiProperty({ description: 'ID del Cliente/Inquilino asociado' })
  @Column()
  clientId: string;

  @ManyToOne(() => Client)
  @JoinColumn({ name: 'clientId' })
  client: Client;

  @ApiProperty({ description: 'ID del Inmueble/Propiedad objeto del contrato' })
  @Column()
  propertyId: string;

  @ManyToOne(() => Property)
  @JoinColumn({ name: 'propertyId' })
  property: Property;

  // --------------------------------------------------------------------------
  // 3. DATOS ECONMICOS (LA "LNEA MAESTRA")
  // --------------------------------------------------------------------------

  @ApiProperty({ description: 'Importe de la renta mensual base (sin impuestos)', example: 1000.00 })
  @Column({ type: 'decimal', precision: 12, scale: 2, default: 0 })
  monthlyRent: number;

  @ApiProperty({ description: 'Importe de la fianza legal depositada', example: 2000.00 })
  @Column({ type: 'decimal', precision: 12, scale: 2, default: 0 })
  depositAmount: number;

  // --- IMPUESTOS (Vinculaci贸n con M贸dulo Tax) ---

  @ApiProperty({ 
    description: 'ID del Impuesto principal (IVA) a aplicar sobre la renta. Viene de la entidad Tax.',
    example: 'uuid-del-iva-21'
  })
  @Column({ nullable: true })
  taxId: string;

  @ManyToOne(() => Tax)
  @JoinColumn({ name: 'taxId' })
  tax: Tax;

  @ApiProperty({ 
    description: 'ID de la Retenci贸n (IRPF) a restar de la renta. Viene de la entidad Tax.', 
    required: false,
    example: 'uuid-del-irpf-19'
  })
  @Column({ nullable: true })
  retentionId: string;

  @ManyToOne(() => Tax)
  @JoinColumn({ name: 'retentionId' })
  retention: Tax;

  // --------------------------------------------------------------------------
  // 4. OPERATIVA DE PAGO Y BANCOS (FACTURAE)
  // --------------------------------------------------------------------------

  @ApiProperty({ description: 'M茅todo de pago oficial (01, 03, etc.)', enum: PaymentMethod })
  @Column({ type: 'enum', enum: PaymentMethod, default: PaymentMethod.DOMICILIACION })
  paymentMethod: PaymentMethod;

  @ApiProperty({ 
    description: 'UUID de la Cuenta Bancaria del CLIENTE. Se usar谩 para girar recibos (Domiciliaci贸n).', 
    required: false,
    example: '550e8400-e29b-41d4-a716-446655440000'
  })
  @Column({ nullable: true })
  tenantBankAccountId: string; 

  @ApiProperty({ 
    description: 'UUID de la Cuenta Bancaria de la EMPRESA. Se mostrar谩 en la factura para recibir Transferencias.', 
    required: false,
    example: '550e8400-e29b-41d4-a716-446655440000'
  })
  @Column({ nullable: true })
  companyBankAccountId: string;

  // --------------------------------------------------------------------------
  // 5. CICLO DE VIDA, FECHAS Y AUTOMATIZACIN
  // --------------------------------------------------------------------------

  @ApiProperty({ description: 'Estado del contrato', enum: ContractStatus })
  @Column({ type: 'enum', enum: ContractStatus, default: ContractStatus.BORRADOR })
  status: ContractStatus;

  @ApiProperty({ description: 'Fecha de inicio de vigencia', example: '2026-01-01' })
  @Column({ type: 'date' })
  startDate: Date;

  @ApiProperty({ description: 'Fecha de fin de contrato (null si es indefinido)', required: false })
  @Column({ type: 'date', nullable: true })
  endDate: Date;

  @ApiProperty({ description: 'D铆a programado para emitir la factura mensual (1-28)', example: 1 })
  @Column({ type: 'int', default: 1 })
  billingDay: number;

  @ApiProperty({ description: 'Frecuencia de facturaci贸n', enum: BillingPeriod })
  @Column({ type: 'enum', enum: BillingPeriod, default: BillingPeriod.MENSUAL })
  billingPeriod: BillingPeriod;

  @ApiProperty({ description: 'Fecha de la 煤ltima factura de renta generada con 茅xito', required: false })
  @Column({ type: 'date', nullable: true })
  lastBillingDate: Date;

  // --- AUTOMATIZACIN (Tu "Trigger" seleccionable) ---

  @ApiProperty({ description: 'Si es TRUE, el sistema generar谩 facturas autom谩ticamente seg煤n billingDay' })
  @Column({ default: false })
  isAutoBillingEnabled: boolean;

  @ApiProperty({ description: 'Fecha l铆mite hasta la cual se permite la autofacturaci贸n (ej. Fin de los 12 meses)' })
  @Column({ type: 'date', nullable: true })
  autoBillingUntil: Date;

  // --------------------------------------------------------------------------
  // 6. DOCUMENTACIN Y AUDITORA
  // --------------------------------------------------------------------------

  @ApiProperty({ description: 'URL al PDF del contrato firmado', required: false })
  @Column({ nullable: true })
  documentUrl: string;


}
</file>

<file path="src/contract/enums/billing-period.enum.ts">
export enum BillingPeriod {
  MENSUAL = 'MENSUAL',
  BIMESTRAL = 'BIMESTRAL',
  TRIMESTRAL = 'TRIMESTRAL',
  ANUAL = 'ANUAL',
}
</file>

<file path="src/contract/enums/contract-status.enum.ts">
export enum ContractStatus {
  BORRADOR = 'BORRADOR',
  ACTIVO = 'ACTIVO',
  FINALIZADO = 'FINALIZADO',
  RESCINDIDO = 'RESCINDIDO',
  INACTIVO = 'INACTIVO',
}
</file>

<file path="src/contract/enums/contract-type.enum.ts">
export enum ContractType {
  ALQUILER = 'ALQUILER',
  CESION = 'CESION',
  TEMPORAL = 'TEMPORAL',
  OTRO = 'OTRO',
}
</file>

<file path="src/contract/enums/index.ts">
export * from './billing-period.enum';
export * from './contract-status.enum';
export * from './contract-type.enum';
export * from './payment-method.enum'
</file>

<file path="src/facturae/dto/create-fiscalIdentity.dto.ts">
import { ApiProperty, ApiPropertyOptional } from '@nestjs/swagger';
import {
  IsEnum,
  IsNotEmpty,
  IsOptional,
  IsString,
  Length,
  ValidateIf,
} from 'class-validator';

import {
  PersonType,
  TaxIdType,
  ResidenceType,
  TaxRegimeType,
} from '../enums';

/**
 * CreateFiscalIdentityDto
 *
 * Contrato estricto para la creaci贸n de identidades fiscales.
 * Alineado con la normativa Facturae (Orden HAP/1650/2015) y AEAT.
 *
 * Valida condicionalmente los nombres seg煤n si es Persona F铆sica o Jur铆dica.
 */
export class CreateFiscalIdentityDto {

  /* ------------------------------------------------------------------
   * CLASIFICACIN (Base de la validaci贸n)
   * ------------------------------------------------------------------ */

  @ApiProperty({
    description: 'Clasificaci贸n de la entidad: "Individual" (Aut贸nomo) o "LegalEntity" (Empresa)',
    enum: PersonType,
    example: PersonType.LEGAL_ENTITY,
  })
  @IsEnum(PersonType, { message: 'El tipo debe ser Individual o LegalEntity' })
  @IsNotEmpty()
  personType: PersonType;

  /* ------------------------------------------------------------------
   * IDENTIFICACIN FISCAL (AEAT)
   * ------------------------------------------------------------------ */

  @ApiProperty({
    description: `Tipo de Documento (Claves AEAT):
    - 01: NIF/DNI/NIE (Espa帽a)
    - 02: NIF-IVA (Operador Intracomunitario / VIES)
    - 03: Pasaporte
    - 04: ID Extranjero (Fuera de la UE)
    `,
    enum: TaxIdType,
    example: TaxIdType.NIF, // Se enviar谩 '01'
  })
  @IsEnum(TaxIdType)
  @IsNotEmpty()
  taxIdType: TaxIdType;

  @ApiProperty({
    description: 'N煤mero de identificaci贸n fiscal (Sin guiones ni espacios)',
    example: 'B12345678',
  })
  @IsString()
  @Length(3, 20)
  @IsNotEmpty()
  taxId: string;

  /* ------------------------------------------------------------------
   * DATOS NOMINATIVOS (Validaci贸n Condicional / Polim贸rfica)
   * ------------------------------------------------------------------ */

  @ApiPropertyOptional({
    description: 'Raz贸n Social. **OBLIGATORIO** si personType es LEGAL_ENTITY.',
    example: 'Rentix Solutions S.L.',
  })
  @ValidateIf((o) => o.personType === PersonType.LEGAL_ENTITY)
  @IsNotEmpty({ message: 'La Raz贸n Social es obligatoria para Personas Jur铆dicas' })
  @IsString()
  corporateName?: string;

  @ApiPropertyOptional({
    description: 'Nombre de pila. **OBLIGATORIO** si personType es INDIVIDUAL.',
    example: 'Juan',
  })
  @ValidateIf((o) => o.personType === PersonType.INDIVIDUAL)
  @IsNotEmpty({ message: 'El Nombre es obligatorio para Personas F铆sicas' })
  @IsString()
  firstName?: string;

  @ApiPropertyOptional({
    description: 'Apellidos. **OBLIGATORIO** si personType es INDIVIDUAL.',
    example: 'P茅rez Garc铆a',
  })
  @ValidateIf((o) => o.personType === PersonType.INDIVIDUAL)
  @IsNotEmpty({ message: 'Los Apellidos son obligatorios para Personas F铆sicas' })
  @IsString()
  lastName?: string;

  @ApiPropertyOptional({
    description: 'Nombre comercial (Marca conocida). Opcional.',
    example: 'Rentix App',
  })
  @IsOptional()
  @IsString()
  tradeName?: string;

  /* ------------------------------------------------------------------
   * CONTEXTO FISCAL (Facturae)
   * ------------------------------------------------------------------ */

  @ApiPropertyOptional({
    description: 'C贸digo de residencia: R (Espa帽a), U (UE), E (Extranjero)',
    enum: ResidenceType,
    default: ResidenceType.RESIDENT,
    example: ResidenceType.RESIDENT, // Se enviar谩 'R'
  })
  @IsOptional()
  @IsEnum(ResidenceType)
  residenceType?: ResidenceType;

  @ApiPropertyOptional({
    description: 'C贸digo pa铆s ISO 3166-1 alpha-3. Facturae exige 3 letras (ej: ESP, FRA).',
    example: 'ESP',
    default: 'ESP',
    minLength: 3,
    maxLength: 3,
  })
  @IsOptional()
  @IsString()
  @Length(3, 3, { message: 'El c贸digo de pa铆s debe ser ISO Alpha-3 (3 letras, ej: ESP)' })
  countryCode?: string;

  @ApiPropertyOptional({
    description: 'R茅gimen Fiscal (Clave AEAT): 01 (General), 07 (Criterio de Caja)...',
    enum: TaxRegimeType,
    default: TaxRegimeType.GENERAL,
    example: TaxRegimeType.GENERAL, // Se enviar谩 '01'
  })
  @IsOptional()
  @IsEnum(TaxRegimeType)
  taxRegime?: TaxRegimeType;
}
</file>

<file path="src/facturae/entities/fiscalIdentity.entity.ts">
import { Column, Entity, Index, OneToOne } from 'typeorm';
import { ApiProperty, ApiPropertyOptional } from '@nestjs/swagger';
import { BaseEntity } from '../../common/base/base.entity';
import { Company } from '../../company/entities/company.entity'; // Ajusta la ruta si es necesario
import { PersonType } from '../enums/personType.enum';
import { TaxIdType } from '../enums/taxIdTtype.enum'; // Ojo al typo en tu nombre de archivo original (Ttype)
import { ResidenceType } from '../enums/residenceType.enum';

@Entity('fiscal_identities')
@Index('IDX_FISCAL_IDENTITY_GLOBAL_COMPANY', ['taxId'], { 
  unique: true, 
  where: 'company_id IS NULL' 
})
@Index('IDX_FISCAL_IDENTITY_PER_TENANT', ['taxId', 'companyId'], { 
  unique: true, 
  where: 'company_id IS NOT NULL' 
})
export class FiscalIdentity extends BaseEntity {
  
  //  ESTO ES LO QUE NECESITA EL SERVICIO PARA NO DAR ERROR 
  @ApiPropertyOptional({ description: 'ID de la empresa propietaria (si es un cliente)' })
  @Column({ name: 'company_id', type: 'uuid', nullable: true })
  companyId?: string; 
  //  --------------------------------------------------- 

  @ApiProperty({
    description: 'Tipo de persona: F (F铆sica/Aut贸nomo) o J (Jur铆dica/Empresa)',
    enum: PersonType,
    example: PersonType.LEGAL_ENTITY,
  })
  @Column({
    name: 'person_type',
    type: 'enum',
    enum: PersonType,
    default: PersonType.LEGAL_ENTITY,
  })
  personType: PersonType;

  @ApiProperty({
    description: 'Tipo de documento',
    enum: TaxIdType,
    example: TaxIdType.NIF,
  })
  @Column({
    name: 'tax_id_type',
    type: 'enum',
    enum: TaxIdType,
    default: TaxIdType.NIF,
  })
  taxIdType: TaxIdType;

  @ApiProperty({ example: 'B12345678' })
  @Column({ name: 'tax_id', length: 20 })
  taxId: string;

  @ApiPropertyOptional({ example: 'Rentix Solutions S.L.' })
  @Column({ name: 'corporate_name', nullable: true })
  corporateName?: string;

  @ApiPropertyOptional({ example: 'Juan' })
  @Column({ name: 'first_name', nullable: true })
  firstName?: string;

  @ApiPropertyOptional({ example: 'P茅rez Garc铆a' })
  @Column({ name: 'last_name', nullable: true })
  lastName?: string;

  @ApiPropertyOptional({ example: 'Rentix App' })
  @Column({ name: 'trade_name', nullable: true })
  tradeName?: string;

  @ApiProperty({
    enum: ResidenceType,
    default: ResidenceType.RESIDENT,
  })
  @Column({
    name: 'residence_type',
    type: 'enum',
    enum: ResidenceType,
    default: ResidenceType.RESIDENT,
  })
  residenceType: ResidenceType;

  @ApiProperty({ example: 'ESP', default: 'ESP' })
  @Column({ name: 'country_code', length: 3, default: 'ESP' })
  countryCode: string;

  @OneToOne(() => Company, (company) => company.facturaeParty)
  company: Company;
}
</file>

<file path="src/facturae/fiscalIdentity.controller.ts">
import { Controller, Post, Body } from '@nestjs/common';
import {
  ApiTags,
  ApiOperation,
  ApiCreatedResponse,
  ApiBadRequestResponse,
  ApiConflictResponse,
  ApiBody,
  ApiBearerAuth,
} from '@nestjs/swagger';

import { FiscalIdentityService } from './fiscalIdentity.service';
import { CreateFiscalIdentityDto } from './dto/create-fiscalIdentity.dto';
import { FiscalIdentity } from './entities/fiscalIdentity.entity';

import { Auth } from 'src/auth/decorators/auth.decorator';

/**
 * FiscalIdentityController
 *
 * Gesti贸n de identidades fiscales para Facturae (Espa帽a).
 * * Contexto:
 * Este controlador es el paso intermedio del Wizard de creaci贸n de empresa.
 * Recibe datos fiscales validados y genera una identidad 煤nica (NIF) en el sistema.
 */
@ApiTags('Fiscal Identities') // Nombre m谩s claro y est谩ndar
@ApiBearerAuth()
@Controller('fiscal-identities') // RESTful: recurso en plural y guiones
export class FiscalIdentityController {
  constructor(
    private readonly fiscalIdentityService: FiscalIdentityService,
  ) {}

  /**
   * Crear una identidad fiscal
   * * Paso del Wizard:
   * 1. User (creado) -> 2. Address (creado) -> 3. **FiscalIdentity** -> 4. Company
   */
  @Post()
  @Auth() //  Seguridad: Solo usuarios registrados pueden iniciar este tr谩mite
  @ApiOperation({
    summary: 'Registrar nueva identidad fiscal (Wizard)',
    description: `
      Crea una entidad fiscal validada para Facturae Espa帽a.
      
      - Valida formato NIF/CIF.
      - Asegura coherencia entre Persona F铆sica (Nombre/Apellidos) vs Jur铆dica (Raz贸n Social).
      - Sanitiza la entrada para cumplir est谩ndares XML.
    `,
  })
  @ApiBody({ type: CreateFiscalIdentityDto })
  @ApiCreatedResponse({
    description: 'Identidad fiscal registrada correctamente',
    type: FiscalIdentity,
  })
  @ApiBadRequestResponse({
    description: 'Error de validaci贸n (ej: Falta Raz贸n Social en empresa o NIF inv谩lido)',
  })
  @ApiConflictResponse({
    description: 'El NIF/CIF ya est谩 registrado en el sistema',
  })
  create(
    @Body() dto: CreateFiscalIdentityDto,
  ): Promise<FiscalIdentity> {
    return this.fiscalIdentityService.create(dto);
  }
}
</file>

<file path="src/facturae/fiscalIdentity.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';

import { FiscalIdentityController } from './fiscalIdentity.controller';
import { FiscalIdentityService } from './fiscalIdentity.service';
import { FiscalIdentity } from './entities/fiscalIdentity.entity';

/**
 * FacturaeModule
 *
 * Responsabilidad:
 * - Gesti贸n de identidades fiscales (FacturaeParty)
 * - Base para facturaci贸n electr贸nica (Facturae)
 *
 * Nota de arquitectura:
 * - Exporta TypeOrmModule para permitir
 *   uso del repositorio FacturaeParty
 *   desde otros m贸dulos (Company, seeds, etc.)
 */
@Module({
  imports: [
    TypeOrmModule.forFeature([FiscalIdentity]),
  ],
  controllers: [FiscalIdentityController],
  providers: [FiscalIdentityService],
  exports: [
    TypeOrmModule,
    FiscalIdentityService,
  ],
})
export class FacturaeModule {}
</file>

<file path="src/facturae/fiscalIdentity.service.ts">
import {
  Injectable,
  ConflictException,
  InternalServerErrorException,
  NotFoundException,
} from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository, IsNull } from 'typeorm';
import { FiscalIdentity } from './entities/fiscalIdentity.entity';
import { CreateFiscalIdentityDto } from './dto/create-fiscalIdentity.dto';
import { PersonType } from './enums/personType.enum';

@Injectable()
export class FiscalIdentityService {
  constructor(
    @InjectRepository(FiscalIdentity)
    private readonly fiscalIdentityRepo: Repository<FiscalIdentity>,
  ) {}

  async create(dto: CreateFiscalIdentityDto): Promise<FiscalIdentity> {
    // 1. Validar unicidad GLOBAL (Solo contra otras empresas)
    const existing = await this.fiscalIdentityRepo.findOne({
      where: { 
        taxId: dto.taxId,
        companyId: IsNull() 
      },
    });

    if (existing) {
      throw new ConflictException(
        `Ya existe una EMPRESA registrada en la plataforma con el NIF/CIF ${dto.taxId}`,
      );
    }

    // CORRECCIN: Llamada al m茅todo que ahora s铆 existe
    const cleanDto = this.sanitizePayload(dto);

    try {
      const entity = this.fiscalIdentityRepo.create({
        ...cleanDto,
        countryCode: cleanDto.countryCode?.toUpperCase() || 'ESP',
      });

      // CORRECCIN: .save() devuelve la entidad 煤nica, resolviendo el error de tipos
      return await this.fiscalIdentityRepo.save(entity);
    } catch (error) {
      if (error.code === '23505') {
         throw new ConflictException('Esta identidad fiscal ya existe.');
      }
      throw new InternalServerErrorException('Error al guardar la identidad fiscal');
    }
  }

  async findOne(id: string): Promise<FiscalIdentity> {
    const identity = await this.fiscalIdentityRepo.findOneBy({ id });
    if (!identity) {
      throw new NotFoundException(`Identidad fiscal con ID ${id} no encontrada`);
    }
    return identity;
  }

  private sanitizePayload(dto: CreateFiscalIdentityDto): CreateFiscalIdentityDto {
    const sanitized = { ...dto };
    if (sanitized.personType === PersonType.LEGAL_ENTITY) {
      delete sanitized.firstName;
      delete sanitized.lastName;
    } else {
      delete sanitized.corporateName;
    }
    return sanitized;
  }
}
</file>

<file path="src/health/health.module.ts">
import { Module } from '@nestjs/common';
import { HealthController } from './health.controller';
import { HealthService } from './health.service';

@Module({
  controllers: [HealthController],
  providers: [HealthService],
})
export class HealthModule {}
</file>

<file path="src/health/health.service.ts">
import { Injectable } from '@nestjs/common';
import { DataSource } from 'typeorm';

@Injectable()
export class HealthService {
  constructor(private readonly dataSource: DataSource) {}

  async pingDb() {
    const start = performance.now();
    const qr = this.dataSource.createQueryRunner();
    try {
      await qr.query('SELECT 1');
      const latencyMs = Number((performance.now() - start).toFixed(1));
      return { status: 'ok', latencyMs };
    } catch (err) {
      return { status: 'down', error: (err as Error).message ?? 'unknown' };
    } finally {
      await qr.release();
    }
  }

  async readiness() {
    const db = await this.pingDb();
    const ready = db.status === 'ok';
    return {
      status: ready ? 'ready' : 'not-ready',
      checks: {
        db,
      },
      timestamp: new Date().toISOString(),
    };
  }

  liveness() {
    return {
      status: 'ok',
      timestamp: new Date().toISOString(),
    };
  }
}
</file>

<file path="src/i18n/i18n.module.ts">
import { Module } from '@nestjs/common';

@Module({})
export class I18nModule {}
</file>

<file path="src/i18n/translations/es/errors.json">
{
  "unauthorized": "No autorizado",
  "forbidden": "Acceso denegado",
  "not_found": "Recurso no encontrado"
}
</file>

<file path="src/i18n/translations/es/validation.json">
{
  "email_invalid": "El email no es v谩lido",
  "required": "El campo $property es obligatorio"
}
</file>

<file path="src/property/dto/create-property.dto.ts">
import { ApiProperty, ApiPropertyOptional } from '@nestjs/swagger';
import { Type } from 'class-transformer';
import {
  IsEnum,
  IsNotEmpty,
  IsNumber,
  IsOptional,
  IsString,
  ValidateNested,
  IsInt,
  Min,
  MaxLength,
} from 'class-validator';
import { PropertyType } from '../enums/property-type.enum';
import { PropertyStatus } from '../enums/property-status.enum'; // Aseg煤rate de importar el enum correcto
import { CreateAddressDto } from '../../address/dto/create-address.dto';

export class CreatePropertyDto {

  /* 
   * 1. IDENTIFICACIN Y GESTIN
   *  */

  @ApiProperty({ description: 'Referencia interna (ej: P-VAL-001)', example: 'P-VAL-001' })
  @IsString()
  @IsNotEmpty()
  internalCode: string; // He renombrado 'reference' a 'internalCode' para consistencia con ClientProfile

  @ApiProperty({ description: 'Alias amigable (ej: tico Centro)', example: 'tico Centro' })
  @IsString()
  @IsNotEmpty()
  name: string; // Campo nuevo vital para listados en el front

  @ApiProperty({ enum: PropertyType, example: PropertyType.RESIDENTIAL })
  @IsEnum(PropertyType)
  type: PropertyType;

  @ApiPropertyOptional({ enum: PropertyStatus, default: PropertyStatus.AVAILABLE })
  @IsOptional()
  @IsEnum(PropertyStatus)
  status?: PropertyStatus; // Opcional, por defecto ser谩 AVAILABLE en la entidad

  /* 
   * 2. DIRECCIN (CAMBIO CLAVE: OBJETO, NO ID)
   *  */
  
  @ApiProperty({ type: CreateAddressDto, description: 'Datos de la direcci贸n f铆sica' })
  @ValidateNested()
  @Type(() => CreateAddressDto)
  address: CreateAddressDto; 
  //  ESTO SOLUCIONA TU ERROR.
  // En lugar de pedir un ID, pedimos los datos para crearla al vuelo.

  /* 
   * 3. DATOS LEGALES / ECONMICOS
   *  */

  @ApiPropertyOptional({ example: '1234567AB1234C0001DE', maxLength: 20 })
  @IsOptional()
  @IsString()
  @MaxLength(20)
  cadastralReference?: string;

  @ApiPropertyOptional({ description: 'Precio base alquiler', example: 850.00 })
  @IsOptional()
  @IsNumber()
  @Min(0)
  rentPrice?: number;

  /* 
   * 4. DATOS FSICOS (TUS CAMPOS ORIGINALES)
   *  */

  @ApiPropertyOptional({ example: 85 })
  @IsOptional()
  @IsNumber()
  surfaceM2?: number;

  @ApiPropertyOptional({ example: 3 })
  @IsOptional()
  @IsInt() // Mejor IsInt que IsNumber para cosas que no pueden ser decimales
  @Min(0)
  rooms?: number;

  @ApiPropertyOptional({ example: 2 })
  @IsOptional()
  @IsInt()
  @Min(0)
  bathrooms?: number;

  @ApiPropertyOptional({ example: '3潞' })
  @IsOptional()
  @IsString()
  floor?: string;

  @ApiPropertyOptional({ description: 'Notas internas' })
  @IsOptional()
  @IsString()
  description?: string;

  /* 
   * 5. GEO
   *  */

  @ApiPropertyOptional({ example: 39.4699 })
  @IsOptional()
  @IsNumber()
  latitude?: number;

  @ApiPropertyOptional({ example: -0.3763 })
  @IsOptional()
  @IsNumber()
  longitude?: number;
}
</file>

<file path="src/property/dto/index.ts">
export * from './create-property.dto';
export * from './update-property.dto';
</file>

<file path="src/property/dto/update-property.dto.ts">
import { PartialType } from '@nestjs/swagger';
import { CreatePropertyDto } from './';

export class UpdatePropertyDto extends PartialType(CreatePropertyDto) {}
</file>

<file path="src/property/entities/property.entity.ts">
import {
  Entity,
  Column,
  ManyToOne,
  OneToOne,
  OneToMany, //  Nuevo import
  JoinColumn,
  Index,
} from 'typeorm';
import { ApiProperty, ApiPropertyOptional } from '@nestjs/swagger';
import { BaseEntity } from 'src/common/base/base.entity';
import { Company } from 'src/company/entities/company.entity';
import { Address } from 'src/address/entities/address.entity';
import { PropertyType } from '../enums/property-type.enum';
import { PropertyStatus } from '../enums/property-status.enum';

//  DESCOMENTAR MAANA CUANDO TENGAMOS EL CONTRATO
// import { Contract } from 'src/contract/entities/contract.entity';

/**
 *  PROPERTY (Inmueble / Activo)
 * Representa la unidad f铆sica alquilable.
 * - Pertenece a una Empresa (Tenant).
 * - Tiene una Direcci贸n 煤nica.
 * - Puede tener N Contratos hist贸ricos, pero solo 1 ACTIVO simult谩neamente.
 */
@Entity('properties')
@Index(['companyId', 'internalCode'], { unique: true })
@Index(['companyId', 'cadastralReference'])
export class Property extends BaseEntity {

  /* 
   *  MULTI-TENANT (Owner)
   *  */
  @ApiProperty({ type: () => Company })
  @ManyToOne(() => Company, (company) => company.properties, { 
    nullable: false, 
    onDelete: 'CASCADE' 
  })
  @JoinColumn({ name: 'company_id' })
  company: Company;

  @ApiProperty({ format: 'uuid' })
  @Column({ name: 'company_id' })
  companyId: string;

  /* 
   *  DIRECCIN
   *  */
  @ApiProperty({ type: () => Address })
  @OneToOne(() => Address, { 
    cascade: true, 
    eager: true,   
    onDelete: 'CASCADE' 
  })
  @JoinColumn({ name: 'address_id' })
  address: Address;

  /* 
   *  CONTRATOS (Relaci贸n con el futuro m贸dulo)
   *  */
  
  //  DESCOMENTAR MAANA: Relaci贸n OneToMany para historial.
  // La validaci贸n "Solo 1 activo" se har谩 en el Service de Contract.
  /*
  @OneToMany(() => Contract, (contract) => contract.property)
  contracts: Contract[];
  */

  /* 
   *  IDENTIFICACIN
   *  */
  @ApiProperty({ description: 'C贸digo interno 煤nico', example: 'P-001' })
  @Column({ name: 'internal_code', length: 50 })
  internalCode: string;

  @ApiProperty({ description: 'Alias amigable', example: 'tico Centro' })
  @Column({ length: 100 })
  name: string;

  @ApiProperty({ enum: PropertyType, example: PropertyType.RESIDENTIAL })
  @Column({ type: 'enum', enum: PropertyType, default: PropertyType.RESIDENTIAL })
  type: PropertyType;

  @ApiProperty({ enum: PropertyStatus, example: PropertyStatus.AVAILABLE })
  @Column({ type: 'enum', enum: PropertyStatus, default: PropertyStatus.AVAILABLE })
  status: PropertyStatus;

  /* 
   * 锔 DATOS FACTURAE
   *  */
  @ApiPropertyOptional({ description: 'Referencia Catastral', maxLength: 20 })
  @Column({ name: 'cadastral_reference', length: 20, nullable: true })
  cadastralReference?: string;

  @ApiPropertyOptional({ description: 'Precio alquiler sugerido', type: 'number' })
  @Column({ name: 'rent_price', type: 'decimal', precision: 10, scale: 2, nullable: true })
  rentPrice?: number;

  /* 
   *  CARACTERSTICAS FSICAS
   *  */
  @ApiPropertyOptional({ description: 'Superficie m2', type: 'number' })
  @Column({ name: 'surface_m2', type: 'decimal', precision: 8, scale: 2, nullable: true })
  surfaceM2?: number;

  @ApiPropertyOptional({ example: 3 })
  @Column({ type: 'int', nullable: true })
  rooms?: number;

  @ApiPropertyOptional({ example: 2 })
  @Column({ type: 'int', nullable: true })
  bathrooms?: number;

  @ApiPropertyOptional({ example: '3潞 Izq' })
  @Column({ length: 20, nullable: true })
  floor?: string;

  @ApiPropertyOptional({ description: 'Descripci贸n detallada' })
  @Column({ type: 'text', nullable: true })
  description?: string;

  /* 
   * 猴 GEO
   *  */
  @ApiPropertyOptional({ type: 'number' })
  @Column({ type: 'decimal', precision: 9, scale: 6, nullable: true })
  latitude?: number;

  @ApiPropertyOptional({ type: 'number' })
  @Column({ type: 'decimal', precision: 9, scale: 6, nullable: true })
  longitude?: number;
}
</file>

<file path="src/property/enums/index.ts">
export * from './property-type.enum';
export * from './property-status.enum';
</file>

<file path="src/property/enums/property-status.enum.ts">
export enum PropertyStatus {
  /**
   * Listo para ser alquilado o publicado.
   */
  AVAILABLE = 'AVAILABLE',     // Antes: DISPONIBLE

  /**
   * Tiene un contrato activo y vigente.
   */
  RENTED = 'RENTED',           // Antes: ALQUILADO

  /**
   * IMPORTANTE: Se ha entregado una se帽al/fianza, pero a煤n no hay contrato activo.
   * Bloquea la propiedad para otros interesados.
   */
  RESERVED = 'RESERVED',

  /**
   * No disponible por obras, aver铆as o preparaci贸n.
   */
  MAINTENANCE = 'MAINTENANCE', // Reemplaza a BLOQUEADO (m谩s espec铆fico)

  /**
   * Retirado del mercado temporalmente (Baja administrativa).
   */
  UNAVAILABLE = 'UNAVAILABLE', // Antes: INACTIVO
}
</file>

<file path="src/property/enums/property-type.enum.ts">
export enum PropertyType {
  /**
   * Vivienda habitual o temporal.
   * FISCALIDAD: Generalmente EXENTO de IVA (salvo servicios hoteleros).
   */
  RESIDENTIAL = 'RESIDENTIAL', // Antes: VIVIENDA

  /**
   * Locales comerciales u Oficinas.
   * FISCALIDAD: Sujeto a IVA (21%) y Retenci贸n IRPF (19%).
   */
  COMMERCIAL = 'COMMERCIAL',   // Antes: LOCAL_COMERCIAL

  /**
   * Naves industriales o log铆sticas.
   * FISCALIDAD: Sujeto a IVA.
   */
  INDUSTRIAL = 'INDUSTRIAL',

  /**
   * Plazas de garaje.
   * FISCALIDAD: Si se alquila junto a vivienda (mismo contrato) es exento. Suelto lleva IVA.
   */
  PARKING = 'PARKING',         // Antes: GARAJE

  /**
   * Trasteros o almacenes peque帽os.
   */
  STORAGE = 'STORAGE',         // Antes: TRASTERO

  /**
   * Habitaciones (Coliving / Estudiantes).
   * TENDENCIA: Cada vez m谩s com煤n, requiere contratos distintos a la LAU est谩ndar.
   */
  ROOM = 'ROOM', 

  /**
   * Terrenos, fincas r煤sticas o solares.
   */
  LAND = 'LAND',               // Antes: TERRENO

  OTRO = 'OTHER',              // Antes: OTRO
}
</file>

<file path="src/property/property.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';

import { PropertyService } from './property.service';
import { PropertyController } from './property.controller';
import { Property } from './entities/property.entity';
import { Address } from 'src/address/entities/address.entity';
import { Company } from 'src/company/entities/company.entity';

@Module({
  imports: [TypeOrmModule.forFeature([Property, Address, Company])],
  controllers: [PropertyController],
  providers: [PropertyService],
  exports: [PropertyService],
})
export class PropertyModule {}
</file>

<file path="src/user-company-role/companyRole.controller.ts">
import {
  Controller,
  Get,
  Post,
  Body,
  Patch,
  Param,
  Delete,
  UseGuards,
  HttpCode,
} from '@nestjs/common';
import {
  ApiTags,
  ApiOperation,
  ApiParam,
  ApiBody,
  ApiBearerAuth,
  ApiOkResponse,
  ApiCreatedResponse,
  ApiNoContentResponse,
} from '@nestjs/swagger';

import { UserCompanyRoleService } from './companyRole.service';
import { CreateUserCompanyRoleDto } from './dto/createUuserCompanyRole.dto';
import { UpdateUserCompanyRoleDto } from './dto/updateUserCompanyRole.dto';
import { CompanyRoleEntity } from './entities/userCompanyRole.entity';

import { Roles } from 'src/auth/decorators/roles.decorator';
import { JwtAuthGuard } from 'src/auth/guards/jwt-auth.guard';
import { RolesGuard } from 'src/auth/guards/roles.guard';
import { AppRole } from 'src/auth/enums/user-global-role.enum';


@ApiTags('CompanyRole')
@ApiBearerAuth()
@UseGuards(JwtAuthGuard, RolesGuard)
@Roles(AppRole.SUPERADMIN, AppRole.ADMIN)
@Controller('user-company-role')
export class UserCompanyRoleController {
  constructor(
    private readonly userCompanyRoleService: UserCompanyRoleService,
  ) {}

  @Post()
  @ApiOperation({ summary: 'Crear v铆nculo de usuario-empresa con rol' })
  @ApiBody({ type: CreateUserCompanyRoleDto })
  @ApiCreatedResponse({
    description: 'V铆nculo creado',
    type: CompanyRoleEntity,
  })
  create(
    @Body() dto: CreateUserCompanyRoleDto,
  ): Promise<CompanyRoleEntity> {
    return this.userCompanyRoleService.create(dto);
  }

  @Get()
  @ApiOperation({ summary: 'Listar todos los v铆nculos usuario-empresa' })
  @ApiOkResponse({
    description: 'Lista de v铆nculos',
    type: CompanyRoleEntity,
    isArray: true,
  })
  findAll(): Promise<CompanyRoleEntity[]> {
    return this.userCompanyRoleService.findAll();
  }

  @Get(':id')
  @ApiOperation({ summary: 'Obtener v铆nculo usuario-empresa por ID' })
  @ApiParam({
    name: 'id',
    description: 'UUID del v铆nculo',
  })
  @ApiOkResponse({
    description: 'V铆nculo encontrado',
    type: CompanyRoleEntity,
  })
  findOne(@Param('id') id: string): Promise<CompanyRoleEntity> {
    return this.userCompanyRoleService.findOne(id);
  }

  @Patch(':id')
  @ApiOperation({ summary: 'Actualizar v铆nculo usuario-empresa por ID' })
  @ApiParam({
    name: 'id',
    description: 'UUID del v铆nculo',
  })
  @ApiBody({ type: UpdateUserCompanyRoleDto })
  @ApiOkResponse({
    description: 'V铆nculo actualizado',
    type: CompanyRoleEntity,
  })
  update(
    @Param('id') id: string,
    @Body() dto: UpdateUserCompanyRoleDto,
  ): Promise<CompanyRoleEntity> {
    return this.userCompanyRoleService.update(id, dto);
  }

  @Delete(':id')
  @HttpCode(204)
  @ApiOperation({ summary: 'Eliminar v铆nculo usuario-empresa por ID' })
  @ApiParam({
    name: 'id',
    description: 'UUID del v铆nculo',
  })
  @ApiNoContentResponse({
    description: 'V铆nculo eliminado correctamente',
  })
  async remove(@Param('id') id: string): Promise<void> {
    await this.userCompanyRoleService.remove(id);
  }
}
</file>

<file path="src/user-company-role/companyRole.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';

import { CompanyRoleEntity } from './entities/userCompanyRole.entity';
import { UserCompanyRoleService } from './companyRole.service';
import { UserCompanyRoleController } from './companyRole.controller';
import { User } from 'src/user/entities/user.entity';
import { Company } from 'src/company/entities/company.entity';

@Module({
  imports: [
    TypeOrmModule.forFeature([
      CompanyRoleEntity,
      User,
      Company,
    ]),
  ],
  controllers: [UserCompanyRoleController],
  providers: [UserCompanyRoleService],
})
export class UserCompanyRoleModule {}
</file>

<file path="src/user-company-role/companyRole.service.ts">
import { Injectable, NotFoundException } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';

import { CompanyRoleEntity } from './entities/userCompanyRole.entity';
import { CreateUserCompanyRoleDto, UpdateUserCompanyRoleDto } from './dto';
import { User } from 'src/user/entities/user.entity';
import { Company } from 'src/company/entities/company.entity';

@Injectable()
export class UserCompanyRoleService {
  constructor(
    @InjectRepository(CompanyRoleEntity)
    private readonly repo: Repository<CompanyRoleEntity>,

    @InjectRepository(User)
    private readonly userRepo: Repository<User>,

    @InjectRepository(Company)
    private readonly companyRepo: Repository<Company>,
  ) {}

  /**
   * Crear v铆nculo usuario  empresa con rol
   *
   * Devuelve la entidad completa con relaciones
   * para coherencia con Swagger / OpenAPI
   */
  async create(
    dto: CreateUserCompanyRoleDto,
  ): Promise<CompanyRoleEntity> {
    const user = await this.userRepo.findOne({
      where: { id: dto.userId },
    });

    if (!user) {
      throw new NotFoundException(
        `Usuario con id ${dto.userId} no encontrado`,
      );
    }

    const company = await this.companyRepo.findOne({
      where: { id: dto.companyId },
    });

    if (!company) {
      throw new NotFoundException(
        `Empresa con id ${dto.companyId} no encontrada`,
      );
    }

    const entity = this.repo.create({
      role: dto.role,
      user,
      company,
    });

    return this.repo.save(entity);
  }

  /**
   * Listar todos los v铆nculos usuario-empresa
   */
  async findAll(): Promise<CompanyRoleEntity[]> {
    return this.repo.find({
      relations: ['user', 'company'],
    });
  }

  /**
   * Obtener v铆nculo usuario-empresa por ID
   */
  async findOne(id: string): Promise<CompanyRoleEntity> {
    const entity = await this.repo.findOne({
      where: { id },
      relations: ['user', 'company'],
    });

    if (!entity) {
      throw new NotFoundException(
        `V铆nculo usuario-empresa con id ${id} no encontrado`,
      );
    }

    return entity;
  }

  /**
   * Actualizar v铆nculo usuario-empresa
   *
   * Solo permite modificar el rol
   */
  async update(
    id: string,
    dto: UpdateUserCompanyRoleDto,
  ): Promise<CompanyRoleEntity> {
    const entity = await this.findOne(id);

    if (dto.role) {
      entity.role = dto.role;
    }

    return this.repo.save(entity);
  }

  /**
   * Eliminar v铆nculo usuario-empresa
   *
   * 锔 Devuelve objeto expl铆cito para:
   * - Swagger
   * - OpenAPI
   * - api-types.ts en frontend
   */
  async remove(id: string): Promise<{ message: string }> {
    const entity = await this.findOne(id);
    await this.repo.remove(entity);

    return { message: 'V铆nculo eliminado correctamente' };
  }
}
</file>

<file path="src/user-company-role/dto/index.ts">
export * from './createUuserCompanyRole.dto';
export * from './updateUserCompanyRole.dto';
</file>

<file path="src/user-company-role/enums/companyRole.enum.ts">
export enum CompanyRole {
  OWNER = 'OWNER',
  ADMIN = 'ADMIN',
  MANAGER = 'MANAGER',
  VIEWER = 'VIEWER',
}
</file>

<file path="src/user/dto/update-user.dto.ts">
import { PartialType } from '@nestjs/swagger';
import { CreateUserDto } from './create-user.dto';

export class UpdateUserDto extends PartialType(CreateUserDto) {}
</file>

<file path="src/user/user.module.ts">
import { Module } from '@nestjs/common';
import { UserService } from './user.service';
import { UserController } from './user.controller';
import { TypeOrmModule } from '@nestjs/typeorm';
import { User } from './entities/user.entity';

@Module({
  imports: [TypeOrmModule.forFeature([User])],  //  necesario
  controllers: [UserController],
  providers: [UserService],
  exports: [UserService],  //  para que AuthModule lo pueda usar
})
export class UserModule {}
</file>

<file path="tsconfig.build.json">
{
  "extends": "./tsconfig.json",
  "exclude": ["node_modules", "test", "dist", "**/*spec.ts"]
}
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "module": "nodenext",
    "moduleResolution": "nodenext",
    "resolvePackageJsonExports": true,
    "esModuleInterop": true,
    "isolatedModules": true,
    "declaration": true,
    "removeComments": true,
    "emitDecoratorMetadata": true,
    "experimentalDecorators": true,
    "allowSyntheticDefaultImports": true,
    "target": "ES2023",
    "sourceMap": true,
    "outDir": "./dist",
    "baseUrl": "./",
    "incremental": true,
    "skipLibCheck": true,
    "strictNullChecks": true,
    "forceConsistentCasingInFileNames": true,
    "noImplicitAny": false,
    "strictBindCallApply": false,
    "noFallthroughCasesInSwitch": false
  }
}
</file>

<file path="package.json">
{
  "name": "api",
  "version": "0.0.1",
  "description": "",
  "author": "",
  "private": true,
  "license": "UNLICENSED",
  "scripts": {
    "build": "nest build",
    "format": "prettier --write \"src/**/*.ts\" \"test/**/*.ts\"",
    "start": "nest start",
    "start:dev": "rimraf dist && nest start --watch",
    "start:debug": "nest start --debug --watch",
    "start:prod": "node dist/main",
    "lint": "eslint \"{src,apps,libs,test}/**/*.ts\" --fix",
    "test": "jest",
    "test:watch": "jest --watch",
    "test:cov": "jest --coverage",
    "test:debug": "node --inspect-brk -r tsconfig-paths/register -r ts-node/register node_modules/.bin/jest --runInBand",
    "test:e2e": "jest --config ./test/jest-e2e.json",
    "api:types": "openapi-typescript http://localhost:3000/api-json -o src/app/core/api/api.types.ts"
  },
  "dependencies": {
    "@nestjs/common": "^11.0.1",
    "@nestjs/config": "^4.0.2",
    "@nestjs/core": "^11.0.1",
    "@nestjs/jwt": "^11.0.0",
    "@nestjs/passport": "^11.0.5",
    "@nestjs/platform-express": "^11.0.1",
    "@nestjs/swagger": "^11.2.0",
    "@nestjs/typeorm": "^11.0.0",
    "bcrypt": "^6.0.0",
    "class-transformer": "^0.5.1",
    "class-validator": "^0.14.2",
    "nestjs-i18n": "^10.5.1",
    "passport": "^0.7.0",
    "passport-jwt": "^4.0.1",
    "passport-local": "^1.0.0",
    "pg": "^8.16.3",
    "reflect-metadata": "^0.2.2",
    "rxjs": "^7.8.1",
    "swagger-ui-express": "^5.0.1",
    "typeorm": "^0.3.26",
    "typeorm-naming-strategies": "^4.1.0"
  },
  "devDependencies": {
    "@eslint/eslintrc": "^3.2.0",
    "@eslint/js": "^9.18.0",
    "@nestjs/cli": "^11.0.10",
    "@nestjs/schematics": "^11.0.0",
    "@nestjs/testing": "^11.0.1",
    "@types/bcrypt": "^6.0.0",
    "@types/express": "^5.0.0",
    "@types/jest": "^30.0.0",
    "@types/node": "^24.3.1",
    "@types/passport-jwt": "^4.0.1",
    "@types/passport-local": "^1.0.38",
    "@types/supertest": "^6.0.2",
    "eslint": "^9.18.0",
    "eslint-config-prettier": "^10.0.1",
    "eslint-plugin-prettier": "^5.2.2",
    "globals": "^16.4.0",
    "jest": "^30.0.0",
    "openapi-typescript": "^7.10.1",
    "openapi-typescript-codegen": "^0.30.0",
    "prettier": "^3.4.2",
    "rimraf": "^6.0.1",
    "source-map-support": "^0.5.21",
    "supertest": "^7.0.0",
    "ts-jest": "^29.2.5",
    "ts-loader": "^9.5.2",
    "ts-node": "^10.9.2",
    "tsconfig-paths": "^4.2.0",
    "typescript": "^5.7.3",
    "typescript-eslint": "^8.43.0"
  },
  "jest": {
    "moduleFileExtensions": [
      "js",
      "json",
      "ts"
    ],
    "rootDir": "src",
    "testRegex": ".*\\.spec\\.ts$",
    "transform": {
      "^.+\\.(t|j)s$": "ts-jest"
    },
    "collectCoverageFrom": [
      "**/*.(t|j)s"
    ],
    "coverageDirectory": "../coverage",
    "testEnvironment": "node"
  }
}
</file>

<file path="src/address/address-draft.controller.ts">
import {
  Controller,
  Post,
  Get,
  Patch,
  Param,
  Body,
  UseGuards,
} from '@nestjs/common';
import {
  ApiTags,
  ApiOperation,
  ApiBearerAuth,
  ApiCreatedResponse,
  ApiOkResponse,
  ApiParam,
  ApiBody,
} from '@nestjs/swagger';

import { AddressDraftService } from './address-draft.service';
import { CreateAddressDto } from './dto/create-address.dto';
import { UpdateAddressDto } from './dto/update-address.dto';
import { Address } from './entities/address.entity';

import { JwtAuthGuard } from 'src/auth/guards/jwt-auth.guard';
import { RolesGuard } from 'src/auth/guards/roles.guard';
import { Roles } from 'src/auth/decorators/roles.decorator';
import { AppRole } from 'src/auth/enums/user-global-role.enum';

/**
 * Controller para direcciones en borrador (DRAFT)
 *
 * 锔 NO pertenecen a una empresa todav铆a
 * 锔 Usado en flujos tipo wizard
 */
@ApiTags('addresses-draft')
@ApiBearerAuth()
@UseGuards(JwtAuthGuard, RolesGuard)
@Roles(
  AppRole.SUPERADMIN,
  AppRole.ADMIN,
  AppRole.USER,
)
@Controller('addresses/drafts')
export class AddressDraftController {
  constructor(
    private readonly addressDraftService: AddressDraftService,
  ) {}

  // 
  // Crear direcci贸n en borrador
  // 
  @Post()
  @ApiOperation({
    summary: 'Crear direcci贸n en borrador',
    description:
      'Crea una direcci贸n sin asociar a empresa (estado DRAFT).',
  })
  @ApiBody({ type: CreateAddressDto })
  @ApiCreatedResponse({
    description: 'Direcci贸n creada en borrador',
    type: Address,
  })
  createDraft(
    @Body() dto: CreateAddressDto,
  ): Promise<Address> {
    return this.addressDraftService.createDraft(dto);
  }

  // 
  // Obtener direcci贸n draft
  // 
  @Get(':addressId')
  @ApiOperation({
    summary: 'Obtener una direcci贸n en borrador',
  })
  @ApiParam({
    name: 'addressId',
    description: 'UUID de la direcci贸n',
  })
  @ApiOkResponse({
    description: 'Direcci贸n en borrador',
    type: Address,
  })
  findDraft(
    @Param('addressId') addressId: string,
  ): Promise<Address> {
    return this.addressDraftService.findDraftById(addressId);
  }

  // 
  // Actualizar direcci贸n draft
  // 
  @Patch(':addressId')
  @ApiOperation({
    summary: 'Actualizar direcci贸n en borrador',
  })
  @ApiParam({
    name: 'addressId',
    description: 'UUID de la direcci贸n',
  })
  @ApiBody({ type: UpdateAddressDto })
  @ApiOkResponse({
    description: 'Direcci贸n actualizada',
    type: Address,
  })
  updateDraft(
    @Param('addressId') addressId: string,
    @Body() dto: UpdateAddressDto,
  ): Promise<Address> {
    return this.addressDraftService.updateDraft(addressId, dto);
  }

  // 
  // Asociar direcci贸n draft a empresa
  // 
  @Post(':addressId/attach/company/:companyId')
  @ApiOperation({
    summary: 'Asociar direcci贸n en borrador a una empresa',
    description:
      'Convierte la direcci贸n DRAFT en ACTIVE y la asocia a la empresa indicada.',
  })
  @ApiParam({
    name: 'addressId',
    description: 'UUID de la direcci贸n',
  })
  @ApiParam({
    name: 'companyId',
    description: 'UUID de la empresa',
  })
  @ApiOkResponse({
    description: 'Direcci贸n asociada a empresa',
    type: Address,
  })
  attachToCompany(
    @Param('addressId') addressId: string,
    @Param('companyId') companyId: string,
  ): Promise<Address> {
    return this.addressDraftService.attachToCompany(
      addressId,
      companyId,
    );
  }
}
</file>

<file path="src/address/address-draft.service.ts">
import {
  Injectable,
  NotFoundException,
} from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';

import { Address } from './entities/address.entity';
import { CreateAddressDto } from './dto/create-address.dto';
import { UpdateAddressDto } from './dto/update-address.dto';
import { AddressStatus } from './enums/addressStatus.enum';

/**
 * AddressDraftService
 *
 * Responsabilidad NICA:
 * - Gestionar direcciones en estado DRAFT
 * - Direcciones NO asociadas todav铆a a una empresa
 *
 * 锔 Este servicio NO aplica reglas de negocio de empresa
 * (eso vive en AddressService)
 */
@Injectable()
export class AddressDraftService {
  constructor(
    @InjectRepository(Address)
    private readonly addressRepo: Repository<Address>,
  ) { }

  // 
  // Crear direcci贸n en borrador
  // 
  async createDraft(dto: CreateAddressDto): Promise<Address> {
    
    const address = this.addressRepo.create(dto);
    return this.addressRepo.save(address);
  }

  // 
  // Obtener una direcci贸n draft concreta
  // 
  async findDraftById(addressId: string): Promise<Address> {
    const address = await this.addressRepo.findOne({
      where: {
        id: addressId,
        status: AddressStatus.DRAFT,
        isActive: true,
      },
    });

    if (!address) {
      throw new NotFoundException('Direcci贸n en borrador no encontrada');
    }

    return address;
  }

  // 
  // Actualizar direcci贸n draft
  // 
  async updateDraft(
    addressId: string,
    dto: UpdateAddressDto,
  ): Promise<Address> {
    const address = await this.findDraftById(addressId);

    Object.assign(address, dto);

    return this.addressRepo.save(address);
  }

  // 
  // Asociar draft a una empresa
  // 
  async attachToCompany(
    addressId: string,
    companyId: string,
  ): Promise<Address> {
    const address = await this.findDraftById(addressId);

    address.companyId = companyId;
    address.status = AddressStatus.ACTIVE;

    return this.addressRepo.save(address);
  }
}
</file>

<file path="src/auth/dto/index.ts">
export * from './login.dto';
export * from './tokens.dto';
export * from './refresh-token.dto';
</file>

<file path="src/auth/dto/tokens.dto.ts">
import { ApiProperty } from '@nestjs/swagger';

/**
 * DTO que representa el par de tokens JWT
 * devueltos tras autenticaci贸n o refresh.
 */
export class TokensDto {

  @ApiProperty({
    description: 'Access token JWT utilizado para autenticar las peticiones',
    example: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...',
    type: 'string',
  })
  accessToken: string;

  @ApiProperty({
    description: 'Refresh token JWT utilizado para renovar el access token',
    example: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...',
    type: 'string',
  })
  refreshToken: string;
}
</file>

<file path="src/auth/guards/jwt-auth.guard.ts">
import { Injectable } from "@nestjs/common";
import { AuthGuard } from "@nestjs/passport";

@Injectable()
export class JwtAuthGuard extends AuthGuard('jwt'){}
</file>

<file path="src/client-profile/client-profile.module.ts">
import { Module } from '@nestjs/common';
import { ClientProfileService } from './client-profile.service';
import { ClientProfileController } from './client-profile.controller';
import { TypeOrmModule } from '@nestjs/typeorm';
import { ClientProfile } from './entities/client-profile.entity';
import { Company } from 'src/company/entities/company.entity';

@Module({
  imports: [TypeOrmModule.forFeature([ClientProfile, Company,])],
  controllers: [ClientProfileController],
  providers: [ClientProfileService],
})
export class ClientProfileModule { }
</file>

<file path="src/common/base/base.entity.ts">
import {
  PrimaryGeneratedColumn,
  CreateDateColumn,
  UpdateDateColumn,
  DeleteDateColumn,
  Column,
} from 'typeorm';
import { ApiProperty, ApiPropertyOptional } from '@nestjs/swagger';

/**
 * BaseEntity
 *
 * Entidad base abstracta para todas las entidades del sistema.
 * Define campos comunes de auditor铆a y estado.
 *
 * 锔 IMPORTANTE:
 * - Esta clase NO debe usarse directamente como DTO.
 * - Los DTOs deben declarar expl铆citamente los campos que exponen.
 */
export abstract class BaseEntity {

  /* ------------------------------------------------------------------
   * IDENTIFICADOR
   * ------------------------------------------------------------------ */

  @ApiProperty({
    description: 'Identificador 煤nico de la entidad',
    format: 'uuid',
    example: 'c3f6c9c1-9e9a-4a4b-8f88-3b8b9e7b6c21',
  })
  @PrimaryGeneratedColumn('uuid')
  id: string;

  /* ------------------------------------------------------------------
   * AUDITORA
   * ------------------------------------------------------------------ */

  @ApiProperty({
    description: 'Fecha de creaci贸n del registro',
    type: 'string',
    format: 'date-time',
  })
  @CreateDateColumn({ name: 'created_at' })
  createdAt: Date;

  @ApiProperty({
    description: 'Fecha de 煤ltima actualizaci贸n del registro',
    type: 'string',
    format: 'date-time',
  })
  @UpdateDateColumn({ name: 'updated_at' })
  updatedAt: Date;

  @ApiPropertyOptional({
    description: 'Fecha de eliminaci贸n l贸gica (soft delete)',
    type: 'string',
    format: 'date-time',
    nullable: true,
  })
  @DeleteDateColumn({ name: 'deleted_at', nullable: true })
  deletedAt?: Date | null;

  /* ------------------------------------------------------------------
   * ESTADO
   * ------------------------------------------------------------------ */

  @ApiProperty({
    description: 'Indica si el registro est谩 activo',
    example: true,
    default: true,
  })
  @Column({ name: 'is_active', type: 'boolean', default: true })
  isActive: boolean;
}
</file>

<file path="src/common/catalogs/taxes/vat-rate/vat-rate.controller.ts">
import {
  Controller,
  Get,
  Post,
  Patch,
  Delete,
  Param,
  Body,
  Query,
  NotFoundException,
  UseGuards,
} from '@nestjs/common';
import {
  ApiTags,
  ApiBearerAuth,
  ApiOperation,
  ApiResponse,
  ApiQuery,
  ApiParam,
} from '@nestjs/swagger';

import { VatRateService } from './vat-rate.service';
import { CreateVatRateDto } from './dto/create-vat-rate.dto';
import { UpdateVatRateDto } from './dto/update-vat-rate.dto';
import { VatRate } from './vat-rate.entity';

import { JwtAuthGuard } from 'src/auth/guards/jwt-auth.guard';
import { RolesGuard } from 'src/auth/guards/roles.guard';
import { Roles } from 'src/auth/decorators/roles.decorator';
import { AppRole } from 'src/auth/enums/user-global-role.enum';

@ApiTags('VAT Rates')
@ApiBearerAuth()
@UseGuards(JwtAuthGuard, RolesGuard)
@Roles(AppRole.SUPERADMIN, AppRole.ADMIN)
@Controller('vat-rates')
export class VatRateController {
  constructor(private readonly vatRateService: VatRateService) {}

  /* 
   * Crear IVA
   *  */
  @Post()
  @ApiOperation({ summary: 'Crear tipo de IVA' })
  @ApiResponse({
    status: 201,
    description: 'IVA creado correctamente',
    type: VatRate,
  })
  create(@Body() dto: CreateVatRateDto) {
    return this.vatRateService.create(dto);
  }

  /* 
   * Listar IVAs por pa铆s
   *  */
  @Get()
  @ApiOperation({
    summary: 'Listar tipos de IVA por pa铆s',
    description:
      'Devuelve los IVAs activos por defecto. Usa showInactive=true para incluir inactivos.',
  })
  @ApiQuery({
    name: 'countryCode',
    required: true,
    description: 'C贸digo de pa铆s ISO-3166-1 alpha-2',
    example: 'ES',
  })
  @ApiQuery({
    name: 'showInactive',
    required: false,
    type: Boolean,
    description: 'Incluye IVAs inactivos',
  })
  @ApiResponse({
    status: 200,
    description: 'Listado de IVAs',
    type: [VatRate],
  })
  findAll(
    @Query('countryCode') countryCode: string,
    @Query('showInactive') showInactive?: string,
  ) {
    return this.vatRateService.findAll(countryCode, {
      includeInactive: showInactive === 'true',
    });
  }

  /* 
   * Obtener IVA concreto
   *  */
  @Get(':id')
  @ApiOperation({ summary: 'Obtener un IVA concreto' })
  @ApiParam({ name: 'id', description: 'UUID del IVA' })
  @ApiResponse({
    status: 200,
    description: 'IVA encontrado',
    type: VatRate,
  })
  async findOne(@Param('id') id: string) {
    const vatRate = await this.vatRateService.findOne(id);
    if (!vatRate) {
      throw new NotFoundException('IVA no encontrado');
    }
    return vatRate;
  }

  /* 
   * Actualizar IVA
   *  */
  @Patch(':id')
  @ApiOperation({ summary: 'Actualizar tipo de IVA' })
  @ApiParam({ name: 'id', description: 'UUID del IVA' })
  @ApiResponse({
    status: 200,
    description: 'IVA actualizado',
    type: VatRate,
  })
  async update(
    @Param('id') id: string,
    @Body() dto: UpdateVatRateDto,
  ) {
    const vatRate = await this.vatRateService.update(id, dto);
    if (!vatRate) {
      throw new NotFoundException('IVA no encontrado');
    }
    return vatRate;
  }

  /* 
   * Desactivar IVA
   *  */
  @Delete(':id')
  @ApiOperation({
    summary: 'Desactivar tipo de IVA',
    description: 'Soft delete: marca el IVA como inactivo',
  })
  @ApiParam({ name: 'id', description: 'UUID del IVA' })
  async deactivate(@Param('id') id: string) {
    const ok = await this.vatRateService.deactivate(id);
    if (!ok) {
      throw new NotFoundException('IVA no encontrado o ya inactivo');
    }
    return { message: 'IVA desactivado correctamente' };
  }
}
</file>

<file path="src/common/catalogs/taxes/withholding-rate/withholding-rate.controller.ts">
import {
  Controller,
  Get,
  Post,
  Patch,
  Delete,
  Param,
  Body,
  Query,
  NotFoundException,
  UseGuards,
} from '@nestjs/common';
import {
  ApiTags,
  ApiBearerAuth,
  ApiOperation,
  ApiResponse,
  ApiQuery,
  ApiParam,
} from '@nestjs/swagger';

import { WithholdingRateService } from './withholding-rate.service';
import { CreateWithholdingRateDto, UpdateWithholdingRateDto } from './dto/';
import { WithholdingRate } from './withholding-rate.entity';

import { JwtAuthGuard } from 'src/auth/guards/jwt-auth.guard';
import { RolesGuard } from 'src/auth/guards/roles.guard';
import { Roles } from 'src/auth/decorators/roles.decorator';
import { AppRole } from 'src/auth/enums/user-global-role.enum';

@ApiTags('Withholding Rates')
@ApiBearerAuth()
@UseGuards(JwtAuthGuard, RolesGuard)
@Roles(AppRole.SUPERADMIN, AppRole.ADMIN)
@Controller('withholding-rates')
export class WithholdingRateController {
  constructor(
    private readonly withholdingRateService: WithholdingRateService,
  ) {}

  /* 
   * Crear retenci贸n
   *  */
  @Post()
  @ApiOperation({ summary: 'Crear tipo de retenci贸n' })
  @ApiResponse({
    status: 201,
    description: 'Retenci贸n creada correctamente',
    type: WithholdingRate,
  })
  create(@Body() dto: CreateWithholdingRateDto) {
    return this.withholdingRateService.create(dto);
  }

  /* 
   * Listar retenciones por pa铆s
   *  */
  @Get()
  @ApiOperation({
    summary: 'Listar tipos de retenci贸n por pa铆s',
  })
  @ApiQuery({
    name: 'countryCode',
    required: true,
    example: 'ES',
  })
  @ApiQuery({
    name: 'showInactive',
    required: false,
    type: Boolean,
  })
  @ApiResponse({
    status: 200,
    description: 'Listado de retenciones',
    type: [WithholdingRate],
  })
  findAll(
    @Query('countryCode') countryCode: string,
    @Query('showInactive') showInactive?: string,
  ) {
    return this.withholdingRateService.findAll(countryCode, {
      includeInactive: showInactive === 'true',
    });
  }

  /* 
   * Obtener retenci贸n concreta
   *  */
  @Get(':id')
  @ApiOperation({ summary: 'Obtener una retenci贸n concreta' })
  @ApiParam({ name: 'id', description: 'UUID de la retenci贸n' })
  async findOne(@Param('id') id: string) {
    const rate = await this.withholdingRateService.findOne(id);
    if (!rate) {
      throw new NotFoundException('Retenci贸n no encontrada');
    }
    return rate;
  }

  /* 
   * Actualizar retenci贸n
   *  */
  @Patch(':id')
  @ApiOperation({ summary: 'Actualizar tipo de retenci贸n' })
  async update(
    @Param('id') id: string,
    @Body() dto: UpdateWithholdingRateDto,
  ) {
    const rate = await this.withholdingRateService.update(id, dto);
    if (!rate) {
      throw new NotFoundException('Retenci贸n no encontrada');
    }
    return rate;
  }

  /* 
   * Desactivar retenci贸n
   *  */
  @Delete(':id')
  @ApiOperation({
    summary: 'Desactivar tipo de retenci贸n',
  })
  async deactivate(@Param('id') id: string) {
    const ok = await this.withholdingRateService.deactivate(id);
    if (!ok) {
      throw new NotFoundException(
        'Retenci贸n no encontrada o ya inactiva',
      );
    }
    return { message: 'Retenci贸n desactivada correctamente' };
  }
}
</file>

<file path="src/company-context/dto/select-company.dto.ts">
import { ApiProperty } from '@nestjs/swagger';
import { IsUUID } from 'class-validator';

export class SelectCompanyDto {
  @ApiProperty({
    description: 'UUID de la empresa que el usuario quiere activar como compa帽铆a actual en sesi贸n',
    example: '8e2c4cae-5a4f-4264-befe-2a406fa4adcb',
  })
  @IsUUID()
  companyId: string;
}
</file>

<file path="src/company/dto/createCompanyLegal.dto.ts">
import { ApiProperty } from '@nestjs/swagger';
import { IsOptional, IsString, IsUUID, ValidateNested } from 'class-validator';
import { Type } from 'class-transformer';

import { CreateFiscalIdentityDto } from 'src/facturae/dto/create-fiscalIdentity.dto';
import { CreateAddressDto } from 'src/address/dto/create-address.dto';

export class CreateCompanyLegalDto {

  @ApiProperty({
    description: 'Usuario que ser谩 OWNER de la empresa',
    example: 'uuid',
  })
  @IsUUID()
  ownerUserId: string;

  @ApiProperty({
    description: 'Identidad fiscal (Facturae)',
    type: CreateFiscalIdentityDto,
  })
  @ValidateNested()
  @Type(() => CreateFiscalIdentityDto)
  facturaeParty: CreateFiscalIdentityDto;

  @ApiProperty({
    description: 'Direcci贸n fiscal',
    type: CreateAddressDto,
  })
  @ValidateNested()
  @Type(() => CreateAddressDto)
  fiscalAddress: CreateAddressDto;

  @ApiProperty({
    description: 'Email de contacto',
    required: false,
  })
  @IsOptional()
  @IsString()
  email?: string;

  @ApiProperty({
    description: 'Tel茅fono de contacto',
    required: false,
  })
  @IsOptional()
  @IsString()
  phone?: string;
}
</file>

<file path="src/company/dto/index.ts">
export * from './createCompany.dto';
export * from './createCompanyLegal.dto';
export * from './updateCompany.dto';
export * from './company-me.dto';
</file>

<file path="src/contact/contact.service.ts">
import { Injectable, NotFoundException } from '@nestjs/common';
import { CreateContactDto } from './dto/create-contact.dto';
import { UpdateContactDto } from './dto/update-contact.dto';
import { Contact } from './entities/contact.entity';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';

@Injectable()
export class ContactService {
  constructor(
    @InjectRepository(Contact)
    private readonly contactRepository: Repository<Contact>
  ) { }

  // CREATE
  async create(createContactDto: CreateContactDto): Promise<Contact> {
    const contact = this.contactRepository.create(createContactDto);
    return this.contactRepository.save(contact);
  }

  // READ All (Solo activos)
  findAll(): Promise<Contact[]> {
    return this.contactRepository.find({ where: { isActive: true } });
  }

  // READ by id (Solo activo)
  async findOne(id: string): Promise<Contact | null> {
    return this.contactRepository.findOne({ where: { id, isActive: true } });
  }

  // FIND INACTIVE
  async findInactive(): Promise<Contact[]> {
    const res = this.contactRepository.find({ where: { isActive: false } });
    return res;
  }

  // UPDATE
  async update(id: string, updateContactDto: UpdateContactDto): Promise<Contact> {
    const contact = await this.contactRepository.findOne({ where: { id } });
    if (!contact) throw new NotFoundException('Contacto no encontrado');

    if (updateContactDto.isActive === true) {
      contact.isActive = true;
      contact.deletedAt = null;
    }
    Object.assign(contact, updateContactDto);
    return this.contactRepository.save(contact);
  }

  // SOFT DELETE
  async remove(id: string): Promise<Contact> {
    const contact = await this.findOne(id);
    if (!contact) throw new NotFoundException('Contacto no encontrado');
    contact.isActive = false;
    contact.deletedAt = new Date();
    return this.contactRepository.save(contact);
  }
}
</file>

<file path="src/contact/dto/create-contact.dto.ts">
import { ApiProperty, ApiPropertyOptional } from '@nestjs/swagger';
import { IsString, IsOptional, IsEnum, IsBoolean } from 'class-validator';
import { TipoContactoInterno } from '../entities/contact.entity';

export class CreateContactDto {
  @ApiProperty({
    example: 'Ana L贸pez',
    description: 'Nombre completo del contacto interno'
  })
  @IsString()
  nombre: string;

  @ApiProperty({
    enum: TipoContactoInterno,
    example: TipoContactoInterno.DIRECCION,
    description: 'Tipo de contacto interno'
  })
  @IsEnum(TipoContactoInterno)
  tipoContacto: TipoContactoInterno;

  @ApiPropertyOptional({
    example: 'ana.lopez@ejemplo.com',
    description: 'Correo electr贸nico del contacto (opcional)'
  })
  @IsString()
  @IsOptional()
  email?: string;

  @ApiPropertyOptional({
    example: '612345678',
    description: 'Tel茅fono del contacto (opcional)'
  })
  @IsString()
  @IsOptional()
  telefono?: string;

  @ApiPropertyOptional({
    example: 'Directora t茅cnica',
    description: 'Cargo en la empresa (opcional)'
  })
  @IsString()
  @IsOptional()
  cargo?: string;

  @ApiPropertyOptional({
    example: 'Calle Falsa 123',
    description: 'Direcci贸n postal del contacto (opcional)'
  })
  @IsString()
  @IsOptional()
  direccion?: string;

  @ApiPropertyOptional({
    example: true,
    description: 'Activo/inactivo (opcional, por defecto activo)'
  })
  @IsBoolean()
  @IsOptional()
  isActive?: boolean;
}
</file>

<file path="src/contact/entities/contact.entity.ts">
import { Entity, Column } from 'typeorm';
import { ApiProperty, ApiPropertyOptional } from '@nestjs/swagger';
import { BaseEntity } from '../../common/base/base.entity';

export enum TipoContactoInterno {
  DIRECCION = 'DIRECCION',
  EMERGENCIAS = 'EMERGENCIAS',
  GESTORIA = 'GESTORIA',
  ADMINISTRACION = 'ADMINISTRACION',
  PERSONAL = 'PERSONAL',
  OTRO = 'OTRO'
}

export enum TipoContactoInterno {
  General = 'General',
  Emergencias = 'Emergencias',
  Otro = 'Otro'
}


@Entity()
export class Contact extends BaseEntity {
  @ApiProperty({
    example: 'Ana L贸pez',
    description: 'Nombre completo del contacto interno'
  })
  @Column()
  nombre: string;

  @ApiProperty({
    enum: TipoContactoInterno,
    example: TipoContactoInterno.General,
    description: 'Tipo de contacto interno'
  })
  @Column({ type: 'enum', enum: TipoContactoInterno })
  tipoContacto: TipoContactoInterno;

  @ApiPropertyOptional({
    example: 'ana.lopez@ejemplo.com',
    description: 'Correo electr贸nico (opcional)'
  })
  @Column({ nullable: true })
  email: string;

  @ApiPropertyOptional({
    example: '612345678',
    description: 'Tel茅fono de contacto (opcional)'
  })
  @Column({ nullable: true })
  telefono: string;

  @ApiPropertyOptional({
    example: 'Directora t茅cnica',
    description: 'Cargo en la empresa (opcional)'
  })
  @Column({ nullable: true })
  cargo: string;

  @ApiPropertyOptional({
    example: 'Calle Falsa 123',
    description: 'Direcci贸n puntual del contacto (opcional)'
  })
  @Column({ nullable: true })
  direccion: string;

  // Cuando a帽adas relaciones, a帽ade @ApiProperty({ ... }) tambi茅n a esos campos.
}
</file>

<file path="src/contract/contract.controller.ts">
import { 
  Controller, 
  Get, 
  Post, 
  Body, 
  Patch, 
  Param, 
  Delete, 
  ParseUUIDPipe, 
  Query
} from '@nestjs/common';
import { ApiTags, ApiOperation, ApiResponse, ApiParam } from '@nestjs/swagger';
import { ContractService } from './contract.service';
import { CreateContractDto } from './dto/create-contract.dto';
import { Contract } from './entities/contract.entity';

@ApiTags('Contracts') // Agrupa los endpoints en Swagger bajo "Contracts"
@Controller('contracts')
export class ContractController {
  constructor(private readonly contractService: ContractService) {}

  @Post()
  @ApiOperation({ summary: 'Crear un nuevo contrato de alquiler' })
  @ApiResponse({ status: 201, description: 'Contrato creado exitosamente.', type: Contract })
  @ApiResponse({ status: 400, description: 'Datos inv谩lidos o violaci贸n de propiedad (tri谩ngulo de seguridad).' })
  create(@Body() createContractDto: CreateContractDto) {
    return this.contractService.create(createContractDto);
  }

  @Get('by-company/:companyId')
  @ApiOperation({ summary: 'Listar todos los contratos de una empresa' })
  @ApiParam({ name: 'companyId', description: 'UUID de la empresa' })
  findAll(@Param('companyId', ParseUUIDPipe) companyId: string) {
    return this.contractService.findAll(companyId);
  }

  @Get(':id')
  @ApiOperation({ summary: 'Obtener el detalle de un contrato espec铆fico' })
  @ApiResponse({ status: 200, description: 'Detalle del contrato encontrado.', type: Contract })
  @ApiResponse({ status: 404, description: 'Contrato no encontrado.' })
  findOne(@Param('id', ParseUUIDPipe) id: string) {
    return this.contractService.findOne(id);
  }

  @Delete(':id')
  @ApiOperation({ summary: 'Eliminar (Soft Delete) un contrato' })
  @ApiResponse({ status: 200, description: 'Contrato marcado como eliminado.' })
  remove(@Param('id', ParseUUIDPipe) id: string) {
    return this.contractService.remove(id);
  }
}
</file>

<file path="src/facturae/enums/index.ts">
export * from './personType.enum';
export * from './taxRegimeType.enum';
export * from './taxIdTtype.enum';
export * from './residenceType.enum';
</file>

<file path="src/facturae/enums/personType.enum.ts">
/**
 * Tipos de Persona seg煤n esquema Facturae 3.2.x
 * Se corresponde con los nodos XML ra铆z de la entidad.
 */
export enum PersonType {
  // Se mapea al tag <Individual>
  INDIVIDUAL = 'Individual', 
  
  // Se mapea al tag <LegalEntity>
  LEGAL_ENTITY = 'LegalEntity', 
}
</file>

<file path="src/facturae/enums/residenceType.enum.ts">
/**
 * Residence Type Code according to Facturae (Order HAP/1650/2015).
 * Defines the tax residence status for the invoicing party.
 */
export enum ResidenceType {
  /** R: Residente en Espa帽a (Resident in Spain) */
  RESIDENT = 'R',

  /** U: Residente en la Uni贸n Europea (Intracommunity) */
  EU_RESIDENT = 'U',

  /** E: Residente fuera de la UE (Extracommunity) */
  NON_EU_RESIDENT = 'E',

  /** O: Otros (Usar con precauci贸n en Facturae) */
  OTHER = 'O',
}
</file>

<file path="src/facturae/enums/subjectType.enum.ts">
export enum SubjectType {
  SUBJECT = 'SUBJECT',
  EXEMPT = 'EXEMPT',
}
</file>

<file path="src/facturae/enums/taxIdTtype.enum.ts">
/**
 * Tipos de Documento Identificativo.
 *
 * NOTA: Facturae XML no pide este c贸digo expl铆citamente, pero esta clasificaci贸n
 * (Est谩ndar AEAT/SII) es necesaria para deducir el <ResidenceTypeCode> correcto.
 */
export enum TaxIdType {
  /**
   * NIF / DNI / NIE (Documento Nacional de Identidad Espa帽ol).
   * Valor AEAT: '01'
   * Implica ResidenceType = 'R' (normalmente).
   */
  NIF = '01',

  /**
   * NIF-IVA (Operador Intracomunitario - VIES).
   * Valor AEAT: '02'
   * Implica ResidenceType = 'U' (Uni贸n Europea).
   */
  EU_VAT = '02',

  /**
   * Pasaporte.
   * Valor AEAT: '03'
   * Implica ResidenceType = 'E' (Extranjero).
   */
  PASSPORT = '03',

  /**
   * Documento oficial de identificaci贸n expedido por el pa铆s de residencia.
   * Valor AEAT: '04'
   * Implica ResidenceType = 'E' (Extranjero).
   */
  FOREIGN_ID = '04',

  /**
   * Otro documento probatorio.
   * Valor AEAT: '06'
   */
  OTHER = '06',
}
</file>

<file path="src/health/health.controller.ts">
import { Controller, Get } from '@nestjs/common';
import { ApiOkResponse, ApiTags } from '@nestjs/swagger';
import { HealthService } from './health.service';

@ApiTags('health')
@Controller('health')
export class HealthController {
  constructor(private readonly health: HealthService) {}

  @Get()
  @ApiOkResponse({
    description: 'Simple liveness check',
    schema: {
      type: 'object',
      example: { status: 'ok' },
    },
  })
  async check() {
    return this.health.liveness();
  }

  @Get('db')
  @ApiOkResponse({
    description: 'Database connectivity check',
    schema: {
      type: 'object',
      example: { database: 'up' },
    },
  })
  async db() {
    return this.health.pingDb();
  }

  @Get('ready')
  @ApiOkResponse({
    description: 'Readiness check (aggregates required deps)',
    schema: {
      type: 'object',
      example: { status: 'ready' },
    },
  })
  async ready() {
    return this.health.readiness();
  }
}
</file>

<file path="src/property/property.controller.ts">
import {
  Controller,
  Get,
  Post,
  Body,
  Patch,
  Param,
  Delete,
  ParseUUIDPipe,
  BadRequestException,
} from '@nestjs/common';
import { ApiTags, ApiOperation, ApiBearerAuth, ApiResponse } from '@nestjs/swagger';
import { PropertyService } from './property.service';
import { CreatePropertyDto } from './dto/create-property.dto';
import { UpdatePropertyDto } from './dto/update-property.dto';
import { Auth } from 'src/auth/decorators/auth.decorator';
import { GetUser } from 'src/auth/decorators/get-user.decorator';
import { AppRole } from 'src/auth/enums/user-global-role.enum';

@ApiTags('Properties (Inmuebles)')
@ApiBearerAuth() // Requiere token Bearer
@Controller('properties')
export class PropertyController {
  constructor(private readonly propertyService: PropertyService) {}

  @Post()
  @Auth(AppRole.SUPERADMIN, AppRole.ADMIN, AppRole.USER)
  @ApiOperation({ 
    summary: 'Crear Propiedad', 
    description: 'Crea un inmueble y su direcci贸n f铆sica asociada al Tenant actual.' 
  })
  @ApiResponse({ status: 201, description: 'Propiedad creada correctamente.' })
  @ApiResponse({ status: 409, description: 'C贸digo interno o Ref. Catastral duplicados.' })
  create(
    @Body() createDto: CreatePropertyDto, 
    @GetUser() user: any
  ) {
    const companyId = user.companyId;
    if (!companyId) throw new BadRequestException('Contexto de empresa requerido (Usa /company-context/select)');
    
    return this.propertyService.create(companyId, createDto);
  }

  @Get()
  @Auth(AppRole.SUPERADMIN, AppRole.ADMIN, AppRole.USER)
  @ApiOperation({ summary: 'Listar Propiedades', description: 'Devuelve todo el inventario de la empresa seleccionada.' })
  findAll(@GetUser() user: any) {
    const companyId = user.companyId;
    if (!companyId) throw new BadRequestException('Contexto de empresa requerido');
    
    return this.propertyService.findAll(companyId);
  }

  @Get(':id')
  @Auth(AppRole.SUPERADMIN, AppRole.ADMIN, AppRole.USER)
  @ApiOperation({ summary: 'Obtener detalle de Propiedad' })
  findOne(
    @Param('id', ParseUUIDPipe) id: string, 
    @GetUser() user: any
  ) {
    return this.propertyService.findOne(id, user.companyId);
  }

  @Patch(':id')
  @Auth(AppRole.SUPERADMIN, AppRole.ADMIN, AppRole.USER)
  @ApiOperation({ summary: 'Actualizar Propiedad' })
  update(
    @Param('id', ParseUUIDPipe) id: string,
    @Body() updateDto: UpdatePropertyDto,
    @GetUser() user: any,
  ) {
    return this.propertyService.update(id, user.companyId, updateDto);
  }

  @Delete(':id')
  @Auth(AppRole.SUPERADMIN, AppRole.ADMIN) // 驴Permitimos borrar a USER normal? Quiz谩s solo ADMIN.
  @ApiOperation({ 
    summary: 'Eliminar Propiedad', 
    description: 'Elimina el inmueble y su direcci贸n. CUIDADO: Si hay contratos vinculados podr铆a fallar (depende de FK).' 
  })
  remove(
    @Param('id', ParseUUIDPipe) id: string, 
    @GetUser() user: any
  ) {
    return this.propertyService.remove(id, user.companyId);
  }
}
</file>

<file path="src/property/property.service.ts">
import {
  Injectable,
  ConflictException,
  InternalServerErrorException,
  NotFoundException,
  BadRequestException,
} from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { Property } from './entities/property.entity';
import { CreatePropertyDto } from './dto/create-property.dto';
import { UpdatePropertyDto } from './dto/update-property.dto';
import { AddressStatus } from 'src/address/enums/addressStatus.enum';
import { AddressType } from 'src/address/enums/addressType.enum';

@Injectable()
export class PropertyService {
  constructor(
    @InjectRepository(Property)
    private readonly propertyRepo: Repository<Property>,
  ) {}

  /**
   * Crear Propiedad vinculada a la Empresa (Tenant)
   */
  async create(companyId: string, createDto: CreatePropertyDto) {
    const { address, ...propertyData } = createDto;

    // 1. Preparar la entidad con sus relaciones
    const property = this.propertyRepo.create({
      ...propertyData,
      companyId, // Vincular obligatoriamente al Tenant
      address: {
        ...address,
        companyId, // La direcci贸n tambi茅n pertenece al Tenant
        status: AddressStatus.ACTIVE,
        isDefault: true, 
        type: AddressType.PROPERTY, // Forzamos el tipo correcto
      },
    });

    try {
      // 2. Guardar (Cascade guardar谩 la direcci贸n tambi茅n)
      return await this.propertyRepo.save(property);
    } catch (error) {
      this.handleDBExceptions(error);
    }
  }

  /**
   * Listar todas las propiedades de UNA empresa
   */
  async findAll(companyId: string) {
    return this.propertyRepo.find({
      where: { companyId },
      order: { createdAt: 'DESC' },
      // 'address' se carga sola por eager: true en la entidad
    });
  }

  /**
   * Buscar una propiedad espec铆fica (Validando que pertenezca a la empresa)
   */
  async findOne(id: string, companyId: string) {
    const property = await this.propertyRepo.findOne({
      where: { id, companyId },
    });

    if (!property) {
      throw new NotFoundException(`Propiedad con ID ${id} no encontrada o no tienes acceso.`);
    }
    return property;
  }

  /**
   * Actualizar Propiedad
   */
  async update(id: string, companyId: string, updateDto: UpdatePropertyDto) {
    // 1. Verificar existencia y propiedad
    const property = await this.findOne(id, companyId);
    
    const { address, ...data } = updateDto;

    // 2. Actualizar datos planos de la propiedad
    Object.assign(property, data);

    // 3. Actualizar direcci贸n si viene en el DTO
    // Al ser OneToOne con cascade, TypeORM intentar谩 actualizarla si modificamos el objeto anidado
    if (address) {
      Object.assign(property.address, address);
    }

    try {
      return await this.propertyRepo.save(property);
    } catch (error) {
      this.handleDBExceptions(error);
    }
  }

  /**
   * Eliminar Propiedad (Cascade borrar谩 la direcci贸n)
   */
  async remove(id: string, companyId: string) {
    const property = await this.findOne(id, companyId);
    return this.propertyRepo.remove(property);
  }

  // --- HELPERS ---

  private handleDBExceptions(error: any) {
    if (error.code === '23505') { // Postgres Unique Violation
      // Detectamos si es por c贸digo interno o referencia catastral
      if (error.detail?.includes('internal_code')) {
        throw new ConflictException('Ya existe una propiedad con ese C贸digo Interno en tu empresa.');
      }
      if (error.detail?.includes('cadastral_reference')) {
        throw new ConflictException('Esa Referencia Catastral ya est谩 registrada en tu empresa.');
      }
    }
    // Log para el desarrollador
    console.error(error); 
    throw new InternalServerErrorException('Error inesperado al gestionar la propiedad.');
  }
}
</file>

<file path="src/auth/dto/login.dto.ts">
import { ApiProperty } from '@nestjs/swagger';
import { IsEmail, IsString, MinLength } from 'class-validator';

/**
 * DTO para el login de usuario.
 * Define el contrato OpenAPI del endpoint de autenticaci贸n.
 */
export class LoginDto {

  @ApiProperty({
    description: 'Correo electr贸nico del usuario',
    example: 'user@example.com',
    format: 'email',
  })
  @IsEmail()
  email: string;

  @ApiProperty({
    description: 'Contrase帽a del usuario (m铆nimo 6 caracteres)',
    example: 'StrongPassword123!',
    minLength: 6,
  })
  @IsString()
  @MinLength(6)
  password: string;
}
</file>

<file path="src/auth/enums/user-global-role.enum.ts">
/**
 * Roles globales del usuario dentro del sistema Rentix.
 *
 * Determinan el nivel de acceso general a la aplicaci贸n,
 * independientemente de los roles por empresa.
 */
export enum AppRole {
  SUPERADMIN = 'SUPERADMIN',
  ADMIN = 'ADMIN',
  USER = 'USER',
}
</file>

<file path="src/client-profile/dto/create-client-profile.dto.ts">
import { ApiProperty, ApiPropertyOptional } from '@nestjs/swagger';
import { Type } from 'class-transformer';
import {
  IsEmail,
  IsInt,
  IsOptional,
  IsString,
  Min,
  ValidateNested,
} from 'class-validator';

// Importamos los DTOs de los otros m贸dulos
import { CreateFiscalIdentityDto } from '../../facturae/dto/create-fiscalIdentity.dto';
import { CreateAddressDto } from '../../address/dto/create-address.dto';

export class CreateClientProfileDto {
  /* ------------------------------------------------------------------
   * 锔 DATOS CRM (Gesti贸n)
   * ------------------------------------------------------------------ */

  @ApiPropertyOptional({
    description: 'C贸digo interno (ej: CLI-2024-001). Si se omite, se autogenera.',
    example: 'CLI-001',
  })
  @IsOptional()
  @IsString()
  internalCode?: string;

  @ApiPropertyOptional({
    description: 'Email espec铆fico para facturas (si es distinto al de contacto)',
    example: 'facturacion@cliente.com',
  })
  @IsOptional()
  @IsEmail()
  billingEmail?: string;

  @ApiPropertyOptional({
    description: 'Tel茅fono de contacto administrativo',
    example: '+34 600 000 000',
  })
  @IsOptional()
  @IsString()
  phone?: string;

  @ApiPropertyOptional({
    description: 'Notas internas o observaciones sobre el cliente',
    example: 'Llamar solo por las tardes. Cliente VIP.',
  })
  @IsOptional()
  @IsString()
  notes?: string;

  /* ------------------------------------------------------------------
   *  CONDICIONES DE PAGO
   * ------------------------------------------------------------------ */

  @ApiPropertyOptional({
    description: 'M茅todo de pago habitual',
    example: 'TRANSFERENCIA',
  })
  @IsOptional()
  @IsString()
  paymentMethod?: string;

  @ApiPropertyOptional({
    description: 'D铆as de vencimiento de facturas (0 = Contado)',
    default: 0,
    example: 30,
  })
  @IsOptional()
  @IsInt()
  @Min(0)
  paymentDays?: number;

  /* ------------------------------------------------------------------
   * 锔 ESTRUCTURAS ANIDADAS (Relaciones)
   * ------------------------------------------------------------------ */

  @ApiProperty({
    description: 'Datos Fiscales (NIF, Raz贸n Social) para Facturae',
    type: CreateFiscalIdentityDto,
  })
  @ValidateNested()
  @Type(() => CreateFiscalIdentityDto)
  fiscalIdentity: CreateFiscalIdentityDto;

  @ApiProperty({
    description: 'Direcci贸n Fiscal Principal',
    type: CreateAddressDto,
  })
  @ValidateNested()
  @Type(() => CreateAddressDto)
  address: CreateAddressDto;
}
</file>

<file path="src/client/entities/client.entity.ts">
import { Entity, Column, ManyToOne, OneToOne, JoinColumn } from 'typeorm';
import { BaseEntity } from 'src/common/base/base.entity';
import { Company } from 'src/company/entities/company.entity';
import { FiscalIdentity } from 'src/facturae/entities/fiscalIdentity.entity';
import { Address } from 'src/address/entities/address.entity';

@Entity('clients')
export class Client extends BaseEntity {

  @Column({ name: 'company_id', type: 'uuid' })
  companyId: string;

  @ManyToOne(() => Company)
  @JoinColumn({ name: 'company_id' })
  company: Company;

  @Column({ name: 'facturae_party_id', type: 'uuid' })
  facturaePartyId: string;

  @OneToOne(() => FiscalIdentity, { eager: true })
  @JoinColumn({ name: 'facturae_party_id' })
  facturaeParty: FiscalIdentity;

  @Column({ name: 'fiscal_address_id', type: 'uuid' })
  fiscalAddressId: string;

  @OneToOne(() => Address)
  @JoinColumn({ name: 'fiscal_address_id' })
  fiscalAddress: Address;
}
</file>

<file path="src/company/dto/createCompany.dto.ts">
import { ApiProperty } from '@nestjs/swagger';
import { IsUUID, IsNotEmpty } from 'class-validator';

/**
 * CreateCompanyDto
 *
 * DTO para la creaci贸n de una empresa.
 *
 * 锔 IMPORTANTE:
 * - Este DTO NO crea entidades hijas.
 * - Consume identificadores previamente creados
 *   durante el flujo wizard del frontend.
 *
 * Flujo esperado:
 * 1. Crear FacturaeParty  obtiene facturaePartyId
 * 2. Crear Address en estado DRAFT  obtiene fiscalAddressId
 * 3. Crear Company usando este DTO
 */
export class CreateCompanyDto {

  @ApiProperty({
    description: `
Identificador de la identidad fiscal de la empresa (FacturaeParty).

Debe existir previamente y haber sido creada
en un paso anterior del flujo.
`,
    format: 'uuid',
    example: 'a7c9b2e1-1234-4cde-9a88-ffeeddccbbaa',
    required: true,
  })
  @IsUUID()
  @IsNotEmpty()
  facturaePartyId: string;

  @ApiProperty({
    description: `
Identificador de la direcci贸n fiscal de la empresa.

La direcci贸n debe existir previamente y estar en estado DRAFT.
Durante la creaci贸n de la empresa se asociar谩
y pasar谩 a estado ACTIVE.
`,
    format: 'uuid',
    example: 'b8d1c9a2-5678-4fbc-8123-aabbccddeeff',
    required: true,
  })
  @IsUUID()
  @IsNotEmpty()
  fiscalAddressId: string;
}
</file>

<file path="src/facturae/enums/taxRegimeType.enum.ts">
/**
 * Claves de R茅gimen Especial o Trascendencia (Tabla oficial AEAT).
 * Obligatorio para Libros Registro y SII.
 */
export enum TaxRegimeType {
  /** 01: Operaci贸n de r茅gimen general (El 99% de las empresas S.L. y Aut贸nomos normales) */
  GENERAL = '01',

  /** 02: Exportaci贸n */
  EXPORT = '02',

  /** 03: R茅gimen especial de bienes usados, objetos de arte, antig眉edades y objetos de colecci贸n */
  USED_GOODS = '03',

  /** 05: R茅gimen especial de agencias de viajes */
  TRAVEL_AGENCIES = '05',

  /** 07: R茅gimen especial del criterio de caja (El IVA se devenga al cobrar) */
  CASH_BASIS = '07',

  /** 08: R茅gimen especial de la agricultura, ganader铆a y pesca (REAGP) */
  AGRICULTURE = '08',

  /** 52: R茅gimen simplificado (Solo aplica a IGIC - Canarias, o casos muy espec铆ficos de IVA no deducible) */
  SIMPLIFIED_IGIC = '52',
  
  // NOTA: 'EXEMPT' no es un r茅gimen. Est谩s en R茅gimen General (01) y emites una factura exenta.
}
</file>

<file path="src/user-company-role/dto/createUuserCompanyRole.dto.ts">
import { ApiProperty } from '@nestjs/swagger';
import { IsEnum, IsUUID } from 'class-validator';

import { CompanyRole } from 'src/user-company-role/enums/companyRole.enum';

/**
 * CreateUserCompanyRoleDto
 *
 * Contrato para crear un v铆nculo usuario  empresa con un rol.
 *
 * Usado en:
 * - POST /user-company-role
 *
 * 锔 Nota:
 * - userId y companyId son UUIDs, no objetos.
 * - Las relaciones se resuelven en el service.
 */
export class CreateUserCompanyRoleDto {

  /* ------------------------------------------------------------------
   * USUARIO
   * ------------------------------------------------------------------ */

  @ApiProperty({
    description: 'UUID del usuario al que se asigna el rol',
    format: 'uuid',
    example: 'aa04f32e-6dba-43af-9363-579e00a53c8b',
  })
  @IsUUID('4')
  userId: string;

  /* ------------------------------------------------------------------
   * EMPRESA
   * ------------------------------------------------------------------ */

  @ApiProperty({
    description: 'UUID de la empresa donde se asigna el rol',
    format: 'uuid',
    example: 'f54e632a-91be-4bcd-8f40-3ae5cdc3b9e2',
  })
  @IsUUID('4')
  companyId: string;

  /* ------------------------------------------------------------------
   * ROL
   * ------------------------------------------------------------------ */

  @ApiProperty({
    description: 'Rol del usuario dentro de la empresa',
    enum: CompanyRole,
    example: CompanyRole.OWNER,
  })
  @IsEnum(CompanyRole)
  role: CompanyRole;
}
</file>

<file path="src/user-company-role/dto/updateUserCompanyRole.dto.ts">
import { ApiPropertyOptional } from '@nestjs/swagger';
import { IsEnum } from 'class-validator';

import { CompanyRole } from 'src/user-company-role/enums/companyRole.enum';

/**
 * UpdateUserCompanyRoleDto
 *
 * Contrato para actualizar un v铆nculo usuario  empresa.
 *
 * 锔 Reglas:
 * - SOLO se puede modificar el rol
 * - userId y companyId son inmutables
 */
export class UpdateUserCompanyRoleDto {

  @ApiPropertyOptional({
    description: 'Nuevo rol del usuario dentro de la empresa',
    enum: CompanyRole,
    example: CompanyRole.MANAGER,
  })
  @IsEnum(CompanyRole)
  role?: CompanyRole;
}
</file>

<file path="src/user-company-role/entities/userCompanyRole.entity.ts">
import {
  Entity,
  Column,
  ManyToOne,
} from 'typeorm';
import {
  ApiProperty,
} from '@nestjs/swagger';

import { BaseEntity } from 'src/common/base/base.entity';
import { User } from 'src/user/entities/user.entity';
import { Company } from 'src/company/entities/company.entity';
import { CompanyRole } from '../enums/companyRole.enum';

/**
 * Entidad UserCompanyRole
 *
 * Representa el v铆nculo entre:
 * - un usuario
 * - una empresa
 * - y el rol que ejerce en ella
 *
 * Es una entidad de dominio clave para:
 * - permisos
 * - navegaci贸n del frontend
 * - facturaci贸n multiempresa
 */
@Entity('company_roles')
export class CompanyRoleEntity extends BaseEntity {

  /* ------------------------------------------------------------------
   * ROL
   * ------------------------------------------------------------------ */

  @ApiProperty({
    description: 'Rol del usuario dentro de la empresa',
    enum: CompanyRole,
    example: CompanyRole.OWNER,
  })
  @Column({
    type: 'enum',
    enum: CompanyRole,
  })
  role: CompanyRole;

  /* ------------------------------------------------------------------
   * RELACIN CON USUARIO
   * ------------------------------------------------------------------ */

  @ApiProperty({
    description: 'Usuario al que pertenece este rol',
    type: () => User,
  })
  @ManyToOne(
    () => User,
    (user) => user.companyRoles,
    {
      onDelete: 'CASCADE',
      nullable: false,
    },
  )
  user: User;

  /* ------------------------------------------------------------------
   * RELACIN CON EMPRESA
   * ------------------------------------------------------------------ */

  @ApiProperty({
    description: 'Empresa a la que pertenece este rol',
    type: () => Company,
  })
  @ManyToOne(
    () => Company,
    (company) => company.companyRoles,
    {
      onDelete: 'CASCADE',
      nullable: false,
    },
  )
  company: Company;
}
</file>

<file path="src/address/address.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';

import { AddressService } from './address.service';
import { AddressController } from './address.controller';
import { Address } from './entities/address.entity';
import { CompanyRoleEntity } from 'src/user-company-role/entities/userCompanyRole.entity';

/**
 * AddressModule
 *
 * M贸dulo encargado de la gesti贸n integral de direcciones postales.
 *
 * Funcionalidades:
 * - Creaci贸n de borradores (Drafts) durante el registro.
 * - Gesti贸n de direcciones activas vinculadas a empresas.
 * - Validaci贸n de permisos de acceso mediante roles.
 */
@Module({
  imports: [
    /**
     * TypeOrmModule.forFeature:
     * Registra los repositorios que se inyectar谩n en el AddressService.
     * * - Address: Entidad principal del m贸dulo.
     * - CompanyRoleEntity: Necesaria para verificar si el usuario tiene permisos
     * (Owner/Admin) sobre la empresa antes de modificar sus direcciones.
     */
    TypeOrmModule.forFeature([
      Address,
      CompanyRoleEntity,
    ]),
  ],
  controllers: [AddressController],
  providers: [AddressService],
  exports: [AddressService],
})
export class AddressModule { }
</file>

<file path="src/auth/auth.module.ts">
import { Module } from '@nestjs/common';
import { JwtModule, JwtService } from '@nestjs/jwt';
import { PassportModule } from '@nestjs/passport';
import { ConfigModule, ConfigService } from '@nestjs/config';

import { AuthService } from './auth.service';
import { AuthController } from './auth.controller';

import { LocalStrategy } from './strategies/local.strategy';
import { JwtStrategy } from './strategies/jwt.strategy';
import { JwtRefreshStrategy } from './strategies/jwt-refresh.strategy';

import { UserModule } from 'src/user/user.module';

@Module({
  imports: [
    UserModule,
    PassportModule, // sin defaultStrategy
    ConfigModule,

    JwtModule.registerAsync({
      imports: [ConfigModule],
      inject: [ConfigService],
      useFactory: (config: ConfigService) => ({
        secret: config.get<string>('JWT_ACCESS_SECRET'),
        signOptions: {
          expiresIn: '15m',
        },
      }),
    }),
  ],
  controllers: [AuthController],
  providers: [
    AuthService,
    LocalStrategy,
    JwtStrategy,
    JwtRefreshStrategy,
  ],
  exports: [
    AuthService,
    JwtModule, 
  ],
})
export class AuthModule {}
</file>

<file path="src/auth/decorators/roles.decorator.ts">
import { SetMetadata } from '@nestjs/common';
// Rutas exactas seg煤n tu 谩rbol:
import { AppRole } from '../enums/user-global-role.enum'; 
import { CompanyRole } from '../../user-company-role/enums/companyRole.enum';

export const ROLES_KEY = 'roles';

// Definimos la uni贸n de tipos para aceptar ambos sistemas de roles
export type AllowedRoles = AppRole | CompanyRole;

export const Roles = (...roles: AllowedRoles[]) => SetMetadata(ROLES_KEY, roles);
</file>

<file path="src/auth/guards/roles.guard.ts">
import {
  Injectable,
  CanActivate,
  ExecutionContext,
  ForbiddenException,
} from '@nestjs/common';
import { Reflector } from '@nestjs/core';
// Importamos la clave y el tipo de uni贸n desde el decorador (misma carpeta superior)
import { ROLES_KEY, AllowedRoles } from '../decorators/roles.decorator';

@Injectable()
export class RolesGuard implements CanActivate {
  constructor(private reflector: Reflector) {}

  canActivate(context: ExecutionContext): boolean {
    // 1. Obtenemos los roles permitidos (ahora tipado con AllowedRoles)
    const requiredRoles = this.reflector.getAllAndOverride<AllowedRoles[]>(ROLES_KEY, [
      context.getHandler(),
      context.getClass(),
    ]);

    if (!requiredRoles) {
      return true;
    }

    const rolesArray = Array.isArray(requiredRoles) ? requiredRoles : [requiredRoles];

    if (rolesArray.length === 0) {
      return true;
    }

    const request = context.switchToHttp().getRequest();
    const user = request.user;

    // Validaci贸n: El usuario debe estar autenticado (inyectado por JwtStrategy)
    if (!user) {
      throw new ForbiddenException('Usuario no autenticado');
    }

    /**
     * Comprobaci贸n Maestra:
     * El usuario accede si su appRole O su companyRole coincide con lo requerido
     */
    const hasRole = rolesArray.some((role) => 
      role === user.appRole || role === user.companyRole
    );

    if (!hasRole) {
      throw new ForbiddenException(
        `Acceso insuficiente. Perfil actual: [App: ${user.appRole}, Company: ${user.companyRole}]`
      );
    }

    return true;
  }
}
</file>

<file path="src/auth/strategies/jwt-refresh.strategy.ts">
import { Injectable } from '@nestjs/common';
import { PassportStrategy } from '@nestjs/passport';
import { ExtractJwt, Strategy } from 'passport-jwt';
import { AppRole } from '../enums/user-global-role.enum';

@Injectable()
export class JwtRefreshStrategy extends PassportStrategy(Strategy, 'jwt-refresh') {
  constructor() {
    super({
      jwtFromRequest: ExtractJwt.fromBodyField('refreshToken'),
      secretOrKey: process.env.JWT_REFRESH_SECRET as string, //  forzamos a string
    });
  }

  async validate(payload: any) {
    return { userId: payload.sub, email: payload.email, UserGlobalRole: payload.UserGlobalRole as AppRole };
  }
}
</file>

<file path="src/auth/strategies/jwt.strategy.ts">
import { Injectable } from '@nestjs/common';
import { PassportStrategy } from '@nestjs/passport';
import { ExtractJwt, Strategy } from 'passport-jwt';
import { ConfigService } from '@nestjs/config';

@Injectable()
export class JwtStrategy extends PassportStrategy(Strategy, 'jwt') {
  constructor(configService: ConfigService) {
    const secret = configService.get<string>('JWT_ACCESS_SECRET');
    if (!secret) {
      throw new Error('JWT_ACCESS_SECRET is not defined in environment variables');
    }
  
    super({
      jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),
      ignoreExpiration: false,
      secretOrKey: secret,
    });
  }

async validate(payload: any) {
  return {
    id: payload.sub,                 //  CLAVE
    email: payload.email,
    appRole: payload.appRole,
    companyId: payload.companyId ?? null,
    companyRole: payload.companyRole ?? null,
  };
}

}
</file>

<file path="src/client-profile/client-profile.service.ts">
import {
  Injectable,
  ConflictException,
  InternalServerErrorException,
  NotFoundException,
} from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository, DataSource } from 'typeorm';
import { ClientProfile } from './entities/client-profile.entity';
import { CreateClientProfileDto } from './dto/create-client-profile.dto';
import { UpdateClientProfileDto } from './dto/update-client-profile.dto';
// CORRECCIN: Importamos el Enum que faltaba
import { AddressStatus } from 'src/address/enums/addressStatus.enum';

@Injectable()
export class ClientProfileService {
  constructor(
    // CORRECCIN: Aseguramos 'private readonly' para que sea accesible en 'this'
    @InjectRepository(ClientProfile)
    private readonly clientProfileRepository: Repository<ClientProfile>,
    private readonly dataSource: DataSource,
  ) {}

  /* ------------------------------------------------------------------
   * CREATE
   * ------------------------------------------------------------------ */
  async create(companyId: string, createDto: CreateClientProfileDto) {
    const { address, fiscalIdentity, ...clientData } = createDto;

    if (!clientData.internalCode) {
      // CORRECCIN: Ahora el m茅todo existe
      clientData.internalCode = await this.generateInternalCode(companyId);
    }

    const clientProfile = this.clientProfileRepository.create({
      ...clientData,
      companyId, 
      fiscalIdentity: {
        ...fiscalIdentity,
        countryCode: fiscalIdentity.countryCode?.toUpperCase() || 'ESP',
        companyId: companyId, // Multi-tenant logic
      },
      addresses: [
        {
          ...address,
          status: AddressStatus.ACTIVE,
          isDefault: true,
          companyId,
        },
      ],
    });

    try {
      return await this.clientProfileRepository.save(clientProfile);
    } catch (error) {
      this.handleDBExceptions(error);
    }
  }

  /* ------------------------------------------------------------------
   * FIND ALL
   * ------------------------------------------------------------------ */
  // CORRECCIN: Implementamos el m茅todo faltante
  async findAll(companyId: string) {
    return this.clientProfileRepository.find({
      where: { companyId, isActive: true },
      relations: ['fiscalIdentity'],
      order: { createdAt: 'DESC' },
    });
  }

  /* ------------------------------------------------------------------
   * FIND ONE
   * ------------------------------------------------------------------ */
  // CORRECCIN: Implementamos el m茅todo faltante
  async findOne(id: string, companyId: string) {
    const client = await this.clientProfileRepository.findOne({
      where: { id, companyId, isActive: true },
      relations: ['fiscalIdentity', 'addresses'],
    });

    if (!client) {
      throw new NotFoundException('Cliente no encontrado o no tienes acceso a 茅l');
    }
    return client;
  }

  /* ------------------------------------------------------------------
   * UPDATE
   * ------------------------------------------------------------------ */
  async update(id: string, companyId: string, updateDto: UpdateClientProfileDto) {
    const client = await this.findOne(id, companyId);
    const { address, fiscalIdentity, ...crmData } = updateDto;
    Object.assign(client, crmData);
    return this.clientProfileRepository.save(client);
  }

  /* ------------------------------------------------------------------
   * REMOVE
   * ------------------------------------------------------------------ */
  async remove(id: string, companyId: string) {
    const client = await this.findOne(id, companyId);
    client.isActive = false;
    client.deletedAt = new Date();
    return this.clientProfileRepository.save(client);
  }

  /* ------------------------------------------------------------------
   * HELPERS
   * ------------------------------------------------------------------ */
  // CORRECCIN: Definimos el m茅todo privado
  private async generateInternalCode(companyId: string): Promise<string> {
    return `CLI-${Date.now().toString().slice(-6)}`;
  }

  private handleDBExceptions(error: any) {
    if (error.code === '23505') {
      if (error.constraint === 'IDX_FISCAL_IDENTITY_PER_TENANT') {
        throw new ConflictException('Este NIF/CIF ya est谩 registrado como cliente en tu empresa.');
      }
      if (error.detail?.includes('internal_code')) {
        throw new ConflictException('El c贸digo interno de cliente ya existe en esta empresa.');
      }
    }
    console.error(error);
    throw new InternalServerErrorException('Error al guardar el cliente');
  }
}
</file>

<file path="src/company-context/company-context.controller.ts">
// src/company-context/company-context.controller.ts
import { Body, Controller, Post, UseGuards } from '@nestjs/common';
import { ApiBearerAuth, ApiTags, ApiOkResponse } from '@nestjs/swagger';
import { JwtAuthGuard } from '../auth/guards/jwt-auth.guard';
import { GetUser } from '../auth/decorators/get-user.decorator';
import { CompanyContextService } from './company-context.service';
import { SelectCompanyDto } from './dto/select-company.dto';
import { RolesGuard } from 'src/auth/guards/roles.guard';
import { AppRole } from 'src/auth/enums/user-global-role.enum';
import { Roles } from 'src/auth/decorators/roles.decorator';

@ApiTags('context')
@UseGuards(JwtAuthGuard, RolesGuard)
@Roles(AppRole.SUPERADMIN, AppRole.ADMIN)
@Controller('context')
export class CompanyContextController {
  constructor(private readonly companyContextService: CompanyContextService) {}

  @UseGuards(JwtAuthGuard)
  @ApiBearerAuth()
  @ApiOkResponse({ description: 'Nuevo accessToken con empresa seleccionada' })
  @Post('select-company')
  async selectCompany(
    @GetUser('sub') userId: string,
    @Body() dto: SelectCompanyDto,
  ) {
    return this.companyContextService.selectCompany(userId, dto);
  }
}
</file>

<file path="src/company-context/company-context.module.ts">
// src/company-context/company-context.module.ts
import { Module } from '@nestjs/common';
import { CompanyContextService } from './company-context.service';
import { CompanyContextController } from './company-context.controller';
import { TypeOrmModule } from '@nestjs/typeorm';
import { CompanyRoleEntity } from '../user-company-role/entities/userCompanyRole.entity';
import { User } from '../user/entities/user.entity';
import { AuthModule } from 'src/auth/auth.module';

@Module({
  imports: [
    AuthModule, 
    TypeOrmModule.forFeature([CompanyRoleEntity, User]),
    
  ],
  controllers: [CompanyContextController],
  providers: [CompanyContextService],
})
export class CompanyContextModule {}
</file>

<file path="src/company/dto/company-me.dto.ts">
import { ApiProperty } from '@nestjs/swagger';
import { CompanyRole } from 'src/user-company-role/enums/companyRole.enum';

export class CompanyMeDto {
  @ApiProperty({
    format: 'uuid',
    description: 'ID de la empresa',
  })
  companyId: string;

  @ApiProperty({
    description: 'Nombre legal de la empresa',
    example: 'Empresa Demo SL',
  })
  legalName: string;

  @ApiProperty({
    description: 'Nombre comercial',
    required: false,
    nullable: true,
  })
  tradeName?: string;

  @ApiProperty({
    description: 'Identificaci贸n fiscal',
    example: 'B12345678',
  })
  taxId: string;

  @ApiProperty({
    description: 'Email del usuario OWNER',
    example: 'owner@empresa.com',
  })
  ownerEmail: string;

  @ApiProperty({
    description: 'Rol del usuario autenticado en la empresa',
    enum: CompanyRole,
  })
  role: CompanyRole;
}
</file>

<file path="src/main.ts">
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';
import { DocumentBuilder, SwaggerModule } from '@nestjs/swagger';
import { SeederService } from './config/seeder.service';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  app.enableCors({
  origin: 'http://localhost:4200',
  credentials: true,
});
  const config = new DocumentBuilder()
    .setTitle('Rentix API')
    .setDescription('Documentaci贸n de la API Rentix')
    .setVersion('1.0.0')
    .addBearerAuth(
      {
        type: 'http',
        scheme: 'bearer',
        bearerFormat: 'JWT',
      },
      'access-token', //  nombre del esquema
    )
    .build();

  const document = SwaggerModule.createDocument(app, config);
  SwaggerModule.setup('api', app, document);

  const seeder = app.get(SeederService);
  await seeder.seed();
  
  await app.listen(process.env.PORT ?? 3000);
}
bootstrap();
</file>

<file path="src/address/address.service.ts">
import { Injectable, NotFoundException, ForbiddenException } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';

import { Address } from './entities/address.entity';
import { CreateAddressDto } from './dto/create-address.dto';
import { UpdateAddressDto } from './dto/update-address.dto';
import { AddressStatus } from './enums/addressStatus.enum';

import { AppRole } from 'src/auth/enums/user-global-role.enum';
import { CompanyRoleEntity } from 'src/user-company-role/entities/userCompanyRole.entity';
import { CompanyRole } from 'src/user-company-role/enums/companyRole.enum';

@Injectable()
export class AddressService {
  constructor(
    @InjectRepository(Address)
    private readonly addressRepo: Repository<Address>,

    @InjectRepository(CompanyRoleEntity)
    private readonly userCompanyRoleRepo: Repository<CompanyRoleEntity>,
  ) {}

  // --- LOGICA DRAFT (WIZARD) ---

  async createDraft(dto: CreateAddressDto, userId: string): Promise<Address> {
    const address = this.addressRepo.create({
      ...dto,
      status: AddressStatus.DRAFT,
      isActive: true,
      createdByUserId: userId, // Vinculamos al creador para que no se pierda
    });
    return this.addressRepo.save(address);
  }

  async findDraft(id: string, userId: string): Promise<Address> {
    const address = await this.addressRepo.findOne({
      where: { id, status: AddressStatus.DRAFT, createdByUserId: userId },
    });
    if (!address) throw new NotFoundException('Borrador no encontrado o no te pertenece');
    return address;
  }

  async updateDraft(id: string, dto: UpdateAddressDto, userId: string): Promise<Address> {
    const address = await this.findDraft(id, userId); // Reutilizamos seguridad
    Object.assign(address, dto);
    return this.addressRepo.save(address);
  }

  // --- LOGICA EMPRESA (YA CREADA) ---

  async findAllForCompany(
    companyId: string, 
    userId: string, 
    appRole: AppRole, 
    options: { includeInactive: boolean }
  ): Promise<Address[]> {
    await this.validateCompanyAccess(companyId, userId, appRole);
    
    return this.addressRepo.find({
      where: {
        companyId,
        ...(options.includeInactive ? {} : { isActive: true }),
      },
      order: { isDefault: 'DESC', createdAt: 'ASC' },
    });
  }

  async softDeleteForCompany(
    companyId: string, 
    addressId: string, 
    userId: string, 
    appRole: AppRole
  ): Promise<boolean> {
    await this.validateCompanyAccess(companyId, userId, appRole, true); // true = requiresAdmin

    const address = await this.addressRepo.findOne({ where: { id: addressId, companyId } });
    if (!address) throw new NotFoundException('Direcci贸n no encontrada');

    address.isActive = false;
    address.deletedAt = new Date();
    await this.addressRepo.save(address);
    return true;
  }

  // --- HELPER SEGURIDAD ---

  private async validateCompanyAccess(
    companyId: string, 
    userId: string, 
    appRole: AppRole, 
    requiresAdmin = false
  ) {
    if (appRole === AppRole.SUPERADMIN) return;

    const userRole = await this.userCompanyRoleRepo.findOne({
      where: { user: { id: userId } as any, company: { id: companyId } as any, isActive: true },
    });

    if (!userRole) throw new ForbiddenException('No tienes acceso a esta empresa');
    if (requiresAdmin && userRole.role !== CompanyRole.OWNER) {
      throw new ForbiddenException('Se requieren permisos de Propietario');
    }
  }
}
</file>

<file path="src/auth/auth.controller.ts">
import {
  Controller,
  Post,
  UseGuards,
  Body,
  Req,
} from '@nestjs/common';
import {
  ApiTags,
  ApiBearerAuth,
  ApiOperation,
  ApiCreatedResponse,
  ApiOkResponse,
  ApiBody,
} from '@nestjs/swagger';
import type { Request } from 'express';

import { AuthService } from './auth.service';
import { LocalAuthGuard } from './guards/local-auth.guard';
import { JwtAuthGuard } from './guards/jwt-auth.guard';

import { LoginDto, TokensDto } from './dto';
import { User } from 'src/user/entities/user.entity';
import { User as UserDecorator } from './decorators/user.decorator';

@ApiTags('auth')
@Controller('auth')
export class AuthController {
  constructor(private readonly authService: AuthService) {}

  //  LOGIN
  @UseGuards(LocalAuthGuard)
  @Post('login')
  @ApiOperation({ summary: 'Login con email y password' })
  @ApiBody({ type: LoginDto })
  @ApiCreatedResponse({
    description: 'Login correcto',
    type: TokensDto,
  })
  async login(
    @Body() _loginDto: LoginDto,
    @Req() req: Request,
  ): Promise<TokensDto> {
    // LocalAuthGuard garantiza req.user
    return this.authService.login(req.user as User);
  }

  // 伙 REFRESH TOKEN
  @Post('refresh')
  @ApiOperation({
    summary: 'Generar un nuevo access token usando refresh token',
  })
  @ApiBody({
    type: Object,
    schema: {
      type: 'object',
      properties: {
        refreshToken: {
          type: 'string',
          example: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...',
        },
      },
      required: ['refreshToken'],
    },
  })
  @ApiCreatedResponse({
    description: 'Tokens renovados correctamente',
    type: TokensDto,
  })
  async refresh(
    @Body() body: { refreshToken: string },
  ): Promise<TokensDto> {
    return this.authService.refresh(body.refreshToken);
  }

  //  LOGOUT
  @UseGuards(JwtAuthGuard)
  @Post('logout')
  @ApiBearerAuth('access-token')
  @ApiOperation({
    summary: 'Cerrar sesi贸n e invalidar refresh token',
  })
  @ApiOkResponse({
    description: 'Logout correcto',
    schema: {
      type: 'object',
      properties: {
        message: {
          type: 'string',
          example: 'Logout correcto',
        },
      },
    },
  })
  async logout(
    @UserDecorator() user: { id: string },
  ): Promise<{ message: string }> {
    await this.authService.logout(user.id);
    return { message: 'Logout correcto' };
  }
}
</file>

<file path="src/client-profile/client-profile.controller.ts">
import {
  Controller,
  Get,
  Post,
  Body,
  Patch,
  Param,
  Delete,
  ParseUUIDPipe,
  BadRequestException,
} from '@nestjs/common';
import { ApiTags, ApiOperation, ApiBearerAuth, ApiResponse } from '@nestjs/swagger';
import { ClientProfileService } from './client-profile.service';
import { CreateClientProfileDto } from './dto/create-client-profile.dto';
import { UpdateClientProfileDto } from './dto/update-client-profile.dto';
import { Auth } from 'src/auth/decorators/auth.decorator';
import { GetUser } from 'src/auth/decorators/get-user.decorator';
import { AppRole } from 'src/auth/enums/user-global-role.enum';

@ApiTags('Client Profiles (CRM)')
@ApiBearerAuth()
@Controller('client-profiles')
export class ClientProfileController {
  constructor(private readonly clientProfileService: ClientProfileService) { }

  @Post()
  @Auth(AppRole.SUPERADMIN, AppRole.ADMIN, AppRole.USER)
  @ApiOperation({
    summary: 'Crear cliente',
    description: 'Crea un cliente CRM + Identidad Fiscal + Direcci贸n Fiscal en una sola operaci贸n.'
  })
  @ApiResponse({ status: 201, description: 'Cliente creado correctamente.' })
  create(
    @Body() createDto: CreateClientProfileDto,
    @GetUser() user: any,
  ) {
    // Ahora definimos la variable que usas abajo
    const companyId = user.companyId;
    if (!companyId) {
      throw new BadRequestException(
        'No has seleccionado ninguna empresa. Usa el endpoint /company-context/select para obtener un token de acceso a empresa.'
      );
    }
    return this.clientProfileService.create(companyId, createDto);
  }

  @Get()
  @Auth(AppRole.SUPERADMIN, AppRole.ADMIN, AppRole.USER)
  @ApiOperation({ summary: 'Listar clientes de mi empresa' })
  findAll(@GetUser('companyId') companyId: string) {
    return this.clientProfileService.findAll(companyId);
  }

  @Get(':id')
  @Auth(AppRole.SUPERADMIN, AppRole.ADMIN, AppRole.USER)
  @ApiOperation({ summary: 'Obtener detalle de un cliente' })
  findOne(
    @Param('id', ParseUUIDPipe) id: string,
    @GetUser('companyId') companyId: string,
  ) {
    return this.clientProfileService.findOne(id, companyId);
  }

  @Patch(':id')
  @Auth(AppRole.SUPERADMIN, AppRole.ADMIN, AppRole.USER)
  @ApiOperation({ summary: 'Actualizar datos CRM del cliente' })
  update(
    @Param('id', ParseUUIDPipe) id: string,
    @Body() updateDto: UpdateClientProfileDto,
    @GetUser('companyId') companyId: string,
  ) {
    return this.clientProfileService.update(id, companyId, updateDto);
  }

  @Delete(':id')
  @Auth(AppRole.SUPERADMIN, AppRole.ADMIN)
  @ApiOperation({ summary: 'Desactivar cliente (Soft delete)' })
  remove(
    @Param('id', ParseUUIDPipe) id: string,
    @GetUser('companyId') companyId: string,
  ) {
    return this.clientProfileService.remove(id, companyId);
  }
}
</file>

<file path="src/company-context/company-context.service.ts">
// src/company-context/company-context.service.ts
import { Injectable, UnauthorizedException } from '@nestjs/common';
import { JwtService } from '@nestjs/jwt';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { CompanyRoleEntity } from '../user-company-role/entities/userCompanyRole.entity';
import { User } from '../user/entities/user.entity';
import { SelectCompanyDto } from './dto/select-company.dto';

@Injectable()
export class CompanyContextService {
  constructor(
    private readonly jwtService: JwtService,
    @InjectRepository(CompanyRoleEntity)
    private readonly userCompanyRoleRepo: Repository<CompanyRoleEntity>,
    @InjectRepository(User)
    private readonly userRepo: Repository<User>,
  ) { }

  async selectCompany(userId: string, dto: SelectCompanyDto) {
    const { companyId } = dto;

    // 1. Comprobar que el usuario existe
    const user = await this.userRepo.findOne({ where: { id: userId, isActive: true } });
    if (!user) throw new UnauthorizedException('Usuario no encontrado o inactivo');

    // 2. Comprobar que el usuario pertenece a esa empresa
    const relation = await this.userCompanyRoleRepo
      .createQueryBuilder('ucr')
      .innerJoinAndSelect('ucr.company', 'company')
      .innerJoinAndSelect('company.facturaeParty', 'facturaeParty')
      .innerJoin('ucr.user', 'user')
      .where('user.id = :userId', { userId })
      .andWhere('company.id = :companyId', { companyId })
      .andWhere('ucr.isActive = true')
      .getOne();

    if (!relation) throw new UnauthorizedException('No tienes acceso a esa empresa');

    // 3. Crear un nuevo accessToken contextualizado
    const payload = {
      sub: user.id,
      appRole: user.appRole,
      companyId: relation.company.id,
      companyRole: relation.role,
    };

    const accessToken = await this.jwtService.signAsync(payload, {
      expiresIn: '15m',
    });

    return {
      accessToken,
      company: {
        id: relation.company.id,
        name: relation.company.facturaeParty.corporateName ||
          `${relation.company.facturaeParty.firstName} ${relation.company.facturaeParty.lastName}`.trim(),
        role: relation.role,
      },
    };
  }
}
</file>

<file path="src/company/company.module.ts">
import { Module } from '@nestjs/common';
import { CompanyService } from './company.service';
import { CompanyController } from './company.controller';
import { TypeOrmModule } from '@nestjs/typeorm';
import { FiscalIdentity } from 'src/facturae/entities/fiscalIdentity.entity';
import { CompanyRoleEntity } from 'src/user-company-role/entities/userCompanyRole.entity';
import { Company } from './entities/company.entity';
import { Address } from 'src/address/entities/address.entity';
import { Property } from 'src/property/entities/property.entity';

@Module({
  imports: [
    TypeOrmModule.forFeature([
      Company,
      FiscalIdentity,
      Address,  
      CompanyRoleEntity,
    ]),
  ],
  controllers: [CompanyController],
  providers: [CompanyService],
  exports: [CompanyService],
})
export class CompanyModule { }
</file>

<file path="src/config/seeder.module.ts">
// src/config/seeder.module.ts
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { SeederService } from './seeder.service';
import { User } from '../user/entities/user.entity';
import { Company } from '../company/entities/company.entity';
import { CompanyRoleEntity } from '../user-company-role/entities/userCompanyRole.entity';
import { FiscalIdentity } from '../facturae/entities/fiscalIdentity.entity';
import { Address } from 'src/address/entities/address.entity';
import { VatRate } from 'src/common/catalogs/taxes/vat-rate/vat-rate.entity';
import { WithholdingRate } from 'src/common/catalogs/taxes/withholding-rate/withholding-rate.entity';

@Module({
  imports: [TypeOrmModule.forFeature([
    User,
    Company,
    CompanyRoleEntity,
    FiscalIdentity,
    Address,
    VatRate,
    WithholdingRate,
  ])],
  providers: [SeederService],
  exports: [SeederService],
})
export class SeederModule { }
</file>

<file path="src/contact/contact.controller.ts">
import { Controller, Get, Post, Body, Patch, Param, Delete, NotFoundException, UseGuards } from '@nestjs/common';
import { ApiTags, ApiOperation, ApiResponse, ApiParam, ApiBody } from '@nestjs/swagger';
import { ContactService } from './contact.service';
import { CreateContactDto } from './dto/create-contact.dto';
import { UpdateContactDto } from './dto/update-contact.dto';
import { Contact } from './entities/contact.entity';
import { Roles } from 'src/auth/decorators/roles.decorator';
import { JwtAuthGuard } from 'src/auth/guards/jwt-auth.guard';
import { RolesGuard } from 'src/auth/guards/roles.guard';
import { AppRole } from 'src/auth/enums/user-global-role.enum';

@ApiTags('Contact')
@UseGuards(JwtAuthGuard, RolesGuard)
@Roles(AppRole.SUPERADMIN, AppRole.ADMIN, AppRole.USER)
@Controller('contact')
export class ContactController {
  constructor(private readonly contactService: ContactService) {}

  @ApiOperation({ summary: 'Crear nuevo contacto' })
  @ApiBody({ type: CreateContactDto })
  @ApiResponse({ status: 201, description: 'Contacto creado correctamente', type: Contact })
  @Post()
  async create(@Body() createContactDto: CreateContactDto) {
    return this.contactService.create(createContactDto);
  }

  @ApiOperation({ summary: 'Listar contactos activos' })
  @ApiResponse({ status: 200, description: 'Lista de contactos activos', type: [Contact] })
  @Get()
  async findAll() {
    return this.contactService.findAll();
  }

  @ApiOperation({ summary: 'Listar contactos inactivos' })
  @ApiResponse({ status: 200, description: 'Lista de contactos inactivos', type: [Contact] })
  @Get('inactive')
  async findInactive() {
    return this.contactService.findInactive();
  }

  @ApiOperation({ summary: 'Buscar contacto por id' })
  @ApiParam({ name: 'id', type: String, required: true })
  @ApiResponse({ status: 200, description: 'Contacto encontrado', type: Contact })
  @ApiResponse({ status: 404, description: 'No encontrado' })
  @Get(':id')
  async findOne(@Param('id') id: string) {
    const contact = await this.contactService.findOne(id);
    if (!contact) throw new NotFoundException('Contacto no encontrado');
    return contact;
  }

  @ApiOperation({ summary: 'Actualizar contacto por id' })
  @ApiParam({ name: 'id', type: String, required: true })
  @ApiBody({ type: UpdateContactDto })
  @ApiResponse({ status: 200, description: 'Contacto actualizado', type: Contact })
  @ApiResponse({ status: 404, description: 'No encontrado' })
  @Patch(':id')
  async update(@Param('id') id: string, @Body() updateContactDto: UpdateContactDto) {
    return this.contactService.update(id, updateContactDto);
  }

  @ApiOperation({ summary: 'Eliminar contacto (soft delete)' })
  @ApiParam({ name: 'id', type: String, required: true })
  @ApiResponse({ status: 200, description: 'Contacto eliminado', type: Contact })
  @ApiResponse({ status: 404, description: 'No encontrado' })
  @Delete(':id')
  async remove(@Param('id') id: string) {
    const deleted = await this.contactService.remove(id);
    if (!deleted) throw new NotFoundException('Contacto no encontrado');
    return deleted;
  }
}
</file>

<file path="src/user/dto/user.dto.ts">
import { ApiProperty, ApiPropertyOptional } from '@nestjs/swagger';
import { AppRole } from 'src/auth/enums/user-global-role.enum';

export class UserDto {
  @ApiProperty({ 
    description: 'Identificador 煤nico (UUID v4)',
    example: 'c3f6c9c1-9e9a-4a4b-8f88-3b8b9e7b6c21' 
  })
  id: string;

  @ApiProperty({ example: 'user@example.com' })
  email: string;

  @ApiPropertyOptional({ 
    description: 'Nombre de pila del usuario',
    example: 'Juan' 
  })
  firstName?: string;

  @ApiPropertyOptional({ 
    description: 'Apellidos del usuario',
    example: 'P茅rez' 
  })
  lastName?: string;

  @ApiProperty({ 
    enum: AppRole, 
    example: AppRole.USER, 
    description: 'Rol de acceso global a la plataforma' 
  })
  appRole: AppRole;

  @ApiProperty({ 
    description: 'Estado de la cuenta (activo/inactivo)',
    example: true 
  })
  isActive: boolean;

  @ApiProperty({ 
    description: 'Fecha de creaci贸n del registro',
    type: 'string', 
    format: 'date-time' 
  })
  createdAt: Date;

  @ApiProperty({ 
    description: 'Fecha de la 煤ltima actualizaci贸n',
    type: 'string', 
    format: 'date-time' 
  })
  updatedAt: Date;
}
</file>

<file path="src/auth/auth.service.ts">
import { Injectable, UnauthorizedException } from '@nestjs/common';
import { JwtService } from '@nestjs/jwt';
import { ConfigService } from '@nestjs/config';
import * as bcrypt from 'bcrypt';

import { UserService } from '../user/user.service';
import { TokensDto } from './dto/tokens.dto';
import { User } from 'src/user/entities/user.entity';

@Injectable()
export class AuthService {
  constructor(
    private readonly usersService: UserService,
    private readonly jwtService: JwtService,
    private readonly configService: ConfigService,
  ) {}

  /**
   * Validaci贸n usada por LocalStrategy
   */
  async validateUser(email: string, pass: string): Promise<User> {
    const user = await this.usersService.findByEmail(email);
    if (!user) {
      throw new UnauthorizedException('Invalid credentials');
    }

    const isMatch = await bcrypt.compare(pass, user.password);
    if (!isMatch) {
      throw new UnauthorizedException('Invalid credentials');
    }

    return user;
  }

  /**
   * Login  genera access + refresh token
   */
  async login(user: User): Promise<TokensDto> {
    const payload = {
      sub: user.id,
      email: user.email,
      appRole: user.appRole,
    };

    // Access token (configurado en JwtModule)
    const accessToken = await this.jwtService.signAsync(payload);

    // Refresh token (secret y expiraci贸n independientes)
    const refreshToken = await this.jwtService.signAsync(payload, {
      secret: this.configService.get<string>('JWT_REFRESH_SECRET'),
      expiresIn: '7d',
    });

    await this.usersService.updateRefreshToken(
      user.id,
      await bcrypt.hash(refreshToken, 10),
    );

    return { accessToken, refreshToken };
  }

  /**
   * Refresh token  emite nuevos tokens
   */
  async refresh(refreshToken: string): Promise<TokensDto> {
    try {
      const payload = await this.jwtService.verifyAsync(refreshToken, {
        secret: this.configService.get<string>('JWT_REFRESH_SECRET'),
      });

      const user = await this.usersService.findById(payload.sub);

      if (!user || !user.refreshTokenHash) {
        throw new UnauthorizedException('Invalid refresh token');
      }

      const isValid = await bcrypt.compare(
        refreshToken,
        user.refreshTokenHash,
      );

      if (!isValid) {
        throw new UnauthorizedException('Invalid refresh token');
      }

      return this.login(user);
    } catch {
      throw new UnauthorizedException('Invalid refresh token');
    }
  }

  /**
   * Logout  invalida refresh token
   * (el controller decide qu茅 respuesta enviar)
   */
  async logout(userId: string): Promise<void> {
    await this.usersService.updateRefreshToken(userId, null);
  }
}
</file>

<file path="src/config/seeder.service.ts">
// src/config/seeder.service.ts

import { Injectable, Logger, Res } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import * as bcrypt from 'bcrypt';

/* 
 * AUTH / USERS
 *  */
import { User } from '../user/entities/user.entity';
import { AppRole } from '../auth/enums/user-global-role.enum';

/* 
 * COMPANY / ROLES
 *  */
import { Company } from '../company/entities/company.entity';
import { CompanyRoleEntity } from '../user-company-role/entities/userCompanyRole.entity';
import { CompanyRole } from '../user-company-role/enums/companyRole.enum';

/* 
 * FACTURAE (IDENTIDAD LEGAL)
 *  */
import { FiscalIdentity } from '../facturae/entities/fiscalIdentity.entity';
import { PersonType, TaxIdType, ResidenceType, TaxRegimeType } from '../facturae/enums/';
/* 
 * ADDRESS
 *  */
import { Address } from '../address/entities/address.entity';
import { AddressType } from '../address/enums/addressType.enum';

/* 
 * TAXES (CATLOGOS)
 *  */
import { VatRate } from '../common/catalogs/taxes/vat-rate/vat-rate.entity';
import { WithholdingRate } from '../common/catalogs/taxes/withholding-rate/withholding-rate.entity';

@Injectable()
export class SeederService {
  private readonly logger = new Logger(SeederService.name);

  constructor(
    @InjectRepository(User)
    private readonly userRepo: Repository<User>,

    @InjectRepository(Company)
    private readonly companyRepo: Repository<Company>,

    @InjectRepository(FiscalIdentity)
    private readonly facturaePartyRepo: Repository<FiscalIdentity>,

    @InjectRepository(CompanyRoleEntity)
    private readonly userCompanyRoleRepo: Repository<CompanyRoleEntity>,

    @InjectRepository(Address)
    private readonly addressRepo: Repository<Address>,

    @InjectRepository(VatRate)
    private readonly vatRepo: Repository<VatRate>,

    @InjectRepository(WithholdingRate)
    private readonly withholdingRepo: Repository<WithholdingRate>,
  ) { }

  /* 
   * SEED PRINCIPAL
   *
   * Reglas:
   * - Idempotente (se puede ejecutar N veces)
   * - Seguro (no crea datos hu茅rfanos)
   * - Alineado con el dominio real
   *  */
  async seed(): Promise<void> {
    this.logger.log(' Inicio del seeding');

    // 1锔 Usuario superadmin (auditor铆a global)
    const superadmin = await this.seedSuperAdmin();

    // 2锔 Identidad legal demo (Facturae)
    const facturaeParty = await this.seedFacturaeParty();

    // 3锔 Empresa demo + direcci贸n fiscal
    // 锔 createdBy = superadmin (auditor铆a, NO propiedad)
    const company = await this.seedCompanyWithFiscalAddress(
      facturaeParty,
      superadmin,
    );

    // 4锔 Relaci贸n usuario  empresa (OWNER expl铆cito)
    await this.seedUserCompanyRole(superadmin, company);

    // 5锔 Cat谩logos fiscales
    await this.seedVatRatesES();
    await this.seedWithholdingRatesES();

    this.logger.log(' Seeding completado correctamente');
  }

  /* 
   * USUARIO SUPERADMIN
   *  */
  private async seedSuperAdmin(): Promise<User> {
    let user = await this.userRepo.findOne({
      where: { email: 'admin@rentix.com' },
    });

    if (!user) {
      user = this.userRepo.create({
        email: 'admin@rentix.com',
        password: await bcrypt.hash('Admin123!', 10),       
        appRole: AppRole.SUPERADMIN,
        firstName: 'System',
        lastName: 'Admin',
        isEmailVerified: true,
      });

      await this.userRepo.save(user);
      this.logger.log(' Usuario superadmin creado (appRole: SUPERADMIN)');
    }

    return user;
  }

  /* 
   * FACTURAE PARTY DEMO
   *
   * Representa la identidad legal/fiscal.
   * NO contiene permisos ni auditor铆a de la app.
   *  */
  private async seedFacturaeParty(): Promise<FiscalIdentity> {
    let party = await this.facturaePartyRepo.findOne({
      where: { taxId: 'B00000000' },
    });

    if (!party) {
      party = this.facturaePartyRepo.create({
        // 1. Definimos que es EMPRESA
        personType: PersonType.LEGAL_ENTITY,

        // 2. Usamos corporateName en vez de legalName
        corporateName: 'Empresa Test S.L.',

        // 3. Ajustamos los enums a los nuevos valores AEAT
        taxId: 'B12345678',
        taxIdType: TaxIdType.NIF, // O el valor '01' si no usas el enum aqu铆
        residenceType: ResidenceType.RESIDENT, // 'R'
        countryCode: 'ESP',
      });

      await this.facturaePartyRepo.save(party);
      this.logger.log(' FacturaeParty demo creada');
    }

    return party;
  }

  /* 
   * EMPRESA + DIRECCIN FISCAL (DEMO)
   *
   * Reglas importantes:
   * - createdBy es OBLIGATORIO (auditor铆a)
   * - createdBy  OWNER
   * - La direcci贸n fiscal NUNCA se crea sin empresa
   *  */
  private async seedCompanyWithFiscalAddress(
    facturaeParty: FiscalIdentity,
    createdBy: User,
  ): Promise<Company> {
    let company = await this.companyRepo.findOne({
      where: { facturaeParty: { id: facturaeParty.id } },
      relations: ['fiscalAddress'],
    });

    if (!company) {
      // 1锔 Crear empresa con auditor铆a
      company = this.companyRepo.create({
        facturaeParty,
        createdByUserId: createdBy.id, //  NOT NULL
      });

      await this.companyRepo.save(company);

      // 2锔 Crear direcci贸n fiscal
      const fiscalAddress = this.addressRepo.create({
        companyId: company.id,
        type: AddressType.FISCAL,
        addressLine1: 'Calle Demo 1',
        postalCode: '28001',
        city: 'Madrid',
        province: 'Madrid',
        countryCode: 'ES',
        isDefault: true,
      });

      await this.addressRepo.save(fiscalAddress);

      // 3锔 Enlazar direcci贸n fiscal a la empresa
      company.fiscalAddress = fiscalAddress;
      await this.companyRepo.save(company);

      this.logger.log(' Empresa demo con direcci贸n fiscal creada');
    }

    return company;
  }

  /* 
   * RELACIN USUARIO  EMPRESA
   *
   * Aqu铆 vive la propiedad real (OWNER).
   *  */
  private async seedUserCompanyRole(
    user: User,
    company: Company,
  ): Promise<void> {
    const exists = await this.userCompanyRoleRepo.findOne({
      where: {
        user: { id: user.id },
        company: { id: company.id },
      },
    });

    if (!exists) {
      await this.userCompanyRoleRepo.save(
        this.userCompanyRoleRepo.create({
          user,
          company,
          role: CompanyRole.OWNER,
        }),
      );

      this.logger.log(' Relaci贸n usuario-owner creada');
    }
  }

  /* 
   * IVA  ESPAA
   *  */
  private async seedVatRatesES(): Promise<void> {
    const countryCode = 'ES';

    const vatRates = [
      { tipo: 'IVA_GENERAL', descripcion: 'IVA general', porcentaje: 21, isDefault: true },
      { tipo: 'IVA_REDUCIDO', descripcion: 'IVA reducido', porcentaje: 10 },
      { tipo: 'IVA_SUPERREDUCIDO', descripcion: 'IVA superreducido', porcentaje: 4 },
      { tipo: 'IVA_EXENTO', descripcion: 'Sin IVA', porcentaje: 0 },
    ];

    for (const data of vatRates) {
      const exists = await this.vatRepo.findOne({
        where: { tipo: data.tipo, countryCode },
      });

      if (!exists) {
        await this.vatRepo.save(
          this.vatRepo.create({
            ...data,
            countryCode,
            isActive: true,
          }),
        );
      }
    }

    this.logger.log(' IVA ES seed completado');
  }

  /* 
   * RETENCIONES  ESPAA
   *  */
  private async seedWithholdingRatesES(): Promise<void> {
    const countryCode = 'ES';

    const rates = [
      { tipo: 'IRPF', descripcion: 'Retenci贸n IRPF general', porcentaje: 19, isDefault: true },
      { tipo: 'SIN_RETENCION', descripcion: 'Sin retenci贸n', porcentaje: 0 },
    ];

    for (const data of rates) {
      const exists = await this.withholdingRepo.findOne({
        where: { tipo: data.tipo, countryCode },
      });

      if (!exists) {
        await this.withholdingRepo.save(
          this.withholdingRepo.create({
            ...data,
            countryCode,
            isActive: true,
          }),
        );
      }
    }

    this.logger.log(' Retenciones ES seed completado');
  }
}
</file>

<file path="src/user/dto/create-user.dto.ts">
import { ApiProperty, ApiPropertyOptional } from '@nestjs/swagger';
import {
  IsEmail,
  IsOptional,
  IsEnum,
  IsString,
  MinLength,
} from 'class-validator';

import { AppRole } from 'src/auth/enums/user-global-role.enum';

/**
 * DTO para la creaci贸n de usuarios.
 * Define el contrato OpenAPI para el alta de usuarios.
 */
export class CreateUserDto {

  @ApiProperty({
    description: 'Correo electr贸nico 煤nico del usuario',
    example: 'user@example.com',
  })
  @IsEmail()
  email: string;

  @ApiProperty({
    description: 'Contrase帽a del usuario (m铆nimo 6 caracteres)',
    example: 'StrongPassword123!',
    minLength: 6,
  })
  @IsString()
  @MinLength(6)
  password: string;

  @ApiPropertyOptional({
    description: 'Rol global del usuario dentro del sistema',
    enum: AppRole,
    example: AppRole.USER,
    default: AppRole.USER,
  })
  @IsOptional()
  @IsEnum(AppRole)
  appRole?: AppRole;
}
</file>

<file path="src/user/dto/me.dto.ts">
import { ApiProperty, ApiPropertyOptional } from '@nestjs/swagger';
import { CompanyRole } from 'src/user-company-role/enums/companyRole.enum';
import { AppRole } from 'src/auth/enums/user-global-role.enum';

/**
 * DTO que representa el rol de un usuario dentro de una empresa.
 */
export class CompanyRoleDto {
  @ApiProperty({
    description: 'Identificador 煤nico de la empresa vinculada',
    example: 'f2383490-f2b0-4d09-b74b-717ef4dfbcf4',
    format: 'uuid',
  })
  companyId: string;

  @ApiProperty({
    description: 'Nombre comercial o legal de la empresa para mostrar en el selector del Front',
    example: 'Rentix SL',
  })
  companyName: string;

  @ApiProperty({
    description: 'Nivel de permisos del usuario dentro de esta empresa espec铆fica',
    enum: CompanyRole,
    example: CompanyRole.OWNER,
  })
  role: CompanyRole;
}

/**
 * DTO del endpoint /users/me
 * Proporciona el contexto completo del usuario para inicializar la App (Angular).
 */
export class MeDto {
  @ApiProperty({
    description: 'ID 煤nico del usuario (UUID)',
    format: 'uuid',
  })
  id: string;

  @ApiProperty({
    description: 'Correo electr贸nico principal utilizado para login y notificaciones',
    example: 'user@rentix.app',
  })
  email: string;

  @ApiPropertyOptional({ 
    description: 'Nombre de pila del usuario (procedente del perfil)',
    example: 'System' 
  })
  firstName?: string;

  @ApiPropertyOptional({ 
    description: 'Apellidos del usuario',
    example: 'Admin' 
  })
  lastName?: string;

  @ApiProperty({
    description: 'Rol administrativo global que determina el acceso a funciones maestras de la App',
    enum: AppRole,
    example: AppRole.SUPERADMIN,
  })
  appRole: AppRole;

  @ApiProperty({
    description: 'Listado de empresas en las que el usuario participa y su rol en cada una',
    type: [CompanyRoleDto],
  })
  companyRoles: CompanyRoleDto[];

  @ApiPropertyOptional({
    description: 'Perfiles adicionales de cliente si el usuario act煤a como tal',
    type: 'array',
    items: { type: 'object' },
  })
  clientProfiles?: Record<string, any>[];

  @ApiProperty({
    description: 'Estado de habilitaci贸n de la cuenta en el sistema',
    example: true,
  })
  isActive: boolean;

  @ApiProperty({
    description: 'Timestamp de creaci贸n del usuario',
    type: 'string',
    format: 'date-time',
  })
  createdAt: Date;

  @ApiProperty({
    description: 'Timestamp de la 煤ltima modificaci贸n de los datos del usuario',
    type: 'string',
    format: 'date-time',
  })
  updatedAt: Date;
}
</file>

<file path="src/address/dto/create-address.dto.ts">
import { ApiProperty, ApiPropertyOptional } from '@nestjs/swagger';
import {
  IsBoolean,
  IsEnum,
  IsISO31661Alpha2,
  IsOptional,
  IsString,
} from 'class-validator';

import { AddressType } from '../enums/addressType.enum';
import { AddressStatus } from '../enums/addressStatus.enum';

/**
 * DTO para la creaci贸n de una direcci贸n.
 *
 * Pensado para flujos multi-step:
 * - creaci贸n en estado DRAFT
 * - asociaci贸n posterior a Company o ClientProfile
 */
export class CreateAddressDto {

  /* ------------------------------------------------------------------
   * ESTADO
   * ------------------------------------------------------------------ */

  @ApiProperty({
    description: 'Estado inicial de la direcci贸n',
    enum: AddressStatus,
    example: AddressStatus.DRAFT,
    default: AddressStatus.DRAFT,
    required: false,
  })
  @IsOptional()
  @IsEnum(AddressStatus)
  status?: AddressStatus;

  /* ------------------------------------------------------------------
   * TIPO DE DIRECCIN
   * ------------------------------------------------------------------ */

  @ApiProperty({
    description: 'Tipo de direcci贸n dentro del sistema',
    enum: AddressType,
    example: AddressType.FISCAL,
  })
  @IsEnum(AddressType)
  type: AddressType;

  /* ------------------------------------------------------------------
   * DATOS POSTALES
   * ------------------------------------------------------------------ */

  @ApiProperty({
    description: 'Direcci贸n principal',
    example: 'Calle Mayor 12',
  })
  @IsString()
  addressLine1: string;

  @ApiProperty({
    description: 'Informaci贸n adicional de la direcci贸n',
    example: '2潞 B',
    required: false,
  })
  @IsOptional()
  @IsString()
  addressLine2?: string;

  @ApiProperty({
    description: 'C贸digo postal',
    example: '46060',
  })
  @IsString()
  postalCode: string;

  @ApiProperty({
    description: 'Ciudad / municipio',
    example: 'Valencia',
  })
  @IsString()
  city: string;

  @ApiPropertyOptional({
    description: 'Provincia (opcional fuera de Espa帽a)',
    example: 'Valencia',
    required: false,
  })
  @IsOptional()
  @IsString()
  province?: string;

  @ApiProperty({
    description: 'C贸digo de pa铆s ISO-3166-1 alpha-2',
    example: 'ES',
    default: 'ES',
  })
  @IsISO31661Alpha2()
  countryCode: string;

  /* ------------------------------------------------------------------
   * CONTROL
   * ------------------------------------------------------------------ */

  @ApiProperty({
    description: 'Indica si es la direcci贸n principal para su tipo',
    example: true,
    required: false,
    default: false,
  })
  @IsOptional()
  @IsBoolean()
  isDefault?: boolean;
}
</file>

<file path="src/client-profile/entities/client-profile.entity.ts">
import {
  Entity,
  Column,
  ManyToOne,
  OneToOne,
  OneToMany,
  JoinColumn,
  Index,
} from 'typeorm';
import { ApiProperty, ApiPropertyOptional } from '@nestjs/swagger';

import { BaseEntity } from 'src/common/base/base.entity';
import { Company } from 'src/company/entities/company.entity';
import { Address } from 'src/address/entities/address.entity';
import { FiscalIdentity } from 'src/facturae/entities/fiscalIdentity.entity';
import { User } from 'src/user/entities/user.entity';

/**
 *  ClientProfile
 *
 * Representa la ficha operativa de un cliente dentro de una empresa (Tenant).
 *
 * ARQUITECTURA:
 * - Datos Fiscales: Delegados en FiscalIdentity (Core Facturae).
 * - Datos CRM: Propios de esta entidad (Email, condiciones de pago, notas).
 * - Multi-tenant: Protegido por index 煤nico [companyId + internalCode].
 */
@Entity('client_profiles')
@Index(['companyId', 'internalCode'], { unique: true })
export class ClientProfile extends BaseEntity {

  /* ------------------------------------------------------------------
   *  TENANT (EMPRESA PROPIETARIA)
   * ------------------------------------------------------------------ */
  
  @ApiProperty({ type: () => Company })
  @ManyToOne(() => Company, { nullable: false, onDelete: 'CASCADE' })
  @JoinColumn({ name: 'company_id' })
  company: Company;

  @Column({ name: 'company_id' })
  companyId: string;

  /* ------------------------------------------------------------------
   * 锔 IDENTIDAD FISCAL (CORE FACTURAE)
   * ------------------------------------------------------------------ */

  @ApiProperty({ description: 'Datos fiscales validados (NIF, Raz贸n Social)' })
  @OneToOne(() => FiscalIdentity, { 
    cascade: true, 
    eager: true, // Carga autom谩tica para mostrar nombre en listados
    onDelete: 'CASCADE' 
  })
  @JoinColumn({ name: 'fiscal_identity_id' })
  fiscalIdentity: FiscalIdentity;

  /* ------------------------------------------------------------------
   * 锔 DATOS DE GESTIN (CRM)
   * ------------------------------------------------------------------ */

  @ApiProperty({ 
    description: 'C贸digo interno 煤nico por empresa (ej: CLI-2024-001)',
    example: 'CLI-001'
  })
  @Column({ name: 'internal_code', length: 50 })
  internalCode: string;

  @ApiPropertyOptional({ description: 'Email principal para facturaci贸n electr贸nica' })
  @Column({ name: 'billing_email', nullable: true })
  billingEmail?: string;

  @ApiPropertyOptional({ description: 'Tel茅fono de contacto administrativo' })
  @Column({ nullable: true })
  phone?: string;

  /* ------------------------------------------------------------------
   *  CONDICIONES DE PAGO (CRTICO FACTURAE)
   * ------------------------------------------------------------------ */

  @ApiPropertyOptional({ 
    description: 'M茅todo de pago habitual (ej: TRANSFERENCIA, RECIBO, EFECTIVO)',
    example: 'TRANSFERENCIA'
  })
  @Column({ name: 'payment_method', nullable: true, default: 'TRANSFERENCIA' })
  paymentMethod?: string;

  @ApiProperty({ 
    description: 'D铆as de vencimiento para c谩lculo autom谩tico (0 = Contado)', 
    default: 0 
  })
  @Column({ name: 'payment_days', default: 0 })
  paymentDays: number;

  @ApiPropertyOptional({ description: 'Notas internas sobre el cliente (CRM)' })
  @Column({ type: 'text', nullable: true })
  notes?: string;

  /* ------------------------------------------------------------------
   *  ACCESO / PORTAL
   * ------------------------------------------------------------------ */

  //  AQU EST LA CORRECCIN 
  @ApiPropertyOptional({ 
    description: 'Usuario vinculado para acceso al portal de clientes',
    type: () => User // <--- ESTO ROMPE EL CICLO INFINITO EN SWAGGER
  })
  @ManyToOne(() => User, { nullable: true, onDelete: 'SET NULL' })
  @JoinColumn({ name: 'user_id' })
  user?: User;

  /* ------------------------------------------------------------------
   *  DIRECCIONES
   * ------------------------------------------------------------------ */

  @OneToMany(() => Address, (address) => address.clientProfile, {
    cascade: ['insert', 'update'],
  })
  addresses: Address[];
}
</file>

<file path="src/address/address.controller.ts">
import {
  Controller,
  Get,
  Post,
  Patch,
  Delete,
  Param,
  Body,
  Query,
  NotFoundException,
  ParseUUIDPipe,
} from '@nestjs/common';
import {
  ApiTags,
  ApiOperation,
  ApiBearerAuth,
  ApiOkResponse,
  ApiCreatedResponse,
} from '@nestjs/swagger';

import { AddressService } from './address.service';
import { Address } from './entities/address.entity';
import { CreateAddressDto } from './dto/create-address.dto';
import { UpdateAddressDto } from './dto/update-address.dto';

import { Auth } from 'src/auth/decorators/auth.decorator';
import { GetUser } from 'src/auth/decorators/get-user.decorator';
import { AppRole } from 'src/auth/enums/user-global-role.enum';

@ApiTags('Addresses')
@ApiBearerAuth()
@Controller('addresses')
export class AddressController {
  constructor(private readonly addressService: AddressService) {}

  // =================================================================
  //  FLUJO WIZARD (DRAFTS)
  // =================================================================

  @Post('draft')
  @Auth() // Cualquier usuario logueado empieza un wizard
  @ApiOperation({ 
    summary: 'Crear direcci贸n temporal (Paso del Wizard)', 
    description: 'Crea una direcci贸n en estado DRAFT vinculada al usuario creador.'
  })
  @ApiCreatedResponse({ type: Address })
  async createDraft(
    @Body() dto: CreateAddressDto,
    @GetUser('id') userId: string
  ) {
    return this.addressService.createDraft(dto, userId);
  }

  @Get('draft/:id')
  @Auth()
  @ApiOperation({ summary: 'Recuperar un borrador por ID' })
  async findDraft(
    @Param('id', ParseUUIDPipe) id: string,
    @GetUser('id') userId: string //  Seguridad: Solo el due帽o la ve
  ) {
    return this.addressService.findDraft(id, userId);
  }

  @Patch('draft/:id')
  @Auth()
  @ApiOperation({ summary: 'Actualizar borrador durante el wizard' })
  async updateDraft(
    @Param('id', ParseUUIDPipe) id: string,
    @Body() dto: UpdateAddressDto,
    @GetUser('id') userId: string
  ) {
    return this.addressService.updateDraft(id, dto, userId);
  }

  // =================================================================
  //  FLUJO GESTIN (EMPRESA YA CREADA)
  // =================================================================

  @Get('/company/:companyId')
  @Auth()
  @ApiOperation({ summary: 'Listar direcciones activas de una empresa' })
  async findAllForCompany(
    @Param('companyId', ParseUUIDPipe) companyId: string,
    @GetUser('id') userId: string,
    @GetUser('appRole') appRole: AppRole,
    @Query('includeInactive') includeInactive?: string,
  ) {
    return this.addressService.findAllForCompany(companyId, userId, appRole, {
      includeInactive: includeInactive === 'true',
    });
  }

  @Delete('/company/:companyId/:addressId')
  @Auth()
  @ApiOperation({ summary: 'Desactivar direcci贸n de empresa' })
  async remove(
    @Param('companyId', ParseUUIDPipe) companyId: string,
    @Param('addressId', ParseUUIDPipe) addressId: string,
    @GetUser('id') userId: string,
    @GetUser('appRole') appRole: AppRole,
  ) {
    await this.addressService.softDeleteForCompany(companyId, addressId, userId, appRole);
    return { message: 'Direcci贸n desactivada correctamente' };
  }
}
</file>

<file path="src/address/entities/address.entity.ts">
import {
  Entity,
  Column,
  ManyToOne,
  JoinColumn,
  Index,
} from 'typeorm';
import { ApiProperty, ApiPropertyOptional } from '@nestjs/swagger';

import { BaseEntity } from 'src/common/base/base.entity';
import { AddressType } from '../enums/addressType.enum';
import { Company } from 'src/company/entities/company.entity';
import { ClientProfile } from 'src/client-profile/entities/client-profile.entity';
import { AddressStatus } from '../enums/addressStatus.enum';

/**
 * Entidad Address
 *
 * Soporta creaci贸n previa a Company mediante status = DRAFT.
 * Pensada para flujos multi-step (user  address  company).
 */
@Entity('addresses')
@Index(['companyId'])
@Index(['clientProfileId'])
@Index(['status'])
@Index(['companyId', 'isActive'])
@Index(['companyId', 'type'])
@Index(['createdByUserId']) //  NUEVO: Para buscar r谩pido los drafts de un usuario
export class Address extends BaseEntity {

  /* ------------------------------------------------------------------
   * MULTIEMPRESA
   * Una direcci贸n puede existir SIN empresa (status = DRAFT)
   * ------------------------------------------------------------------ */

  @ApiPropertyOptional({
    description: 'ID de la empresa propietaria de la direcci贸n. Null si es un borrador (Draft).',
    format: 'uuid',
  })
  @Column({ name: 'company_id', type: 'uuid', nullable: true })
  companyId?: string;

  @ManyToOne(() => Company, { onDelete: 'CASCADE', nullable: true })
  @JoinColumn({ name: 'company_id' })
  company?: Company;

  /* ------------------------------------------------------------------
   * AUDITORA / PROPIEDAD DEL BORRADOR (NUEVO)
   * ------------------------------------------------------------------ */

  @ApiPropertyOptional({
    description: 'ID del usuario que cre贸 el registro. Vital para asegurar los DRAFTS hu茅rfanos.',
    format: 'uuid',
  })
  @Column({ name: 'created_by_user_id', type: 'uuid', nullable: true })
  createdByUserId?: string;

  /* ------------------------------------------------------------------
   * ESTADO DE LA DIRECCIN
   * ------------------------------------------------------------------ */

  @ApiProperty({
    description: 'Estado de la direcci贸n dentro del flujo de negocio',
    enum: AddressStatus,
    example: AddressStatus.DRAFT,
    default: AddressStatus.DRAFT,
  })
  @Column({
    type: 'enum',
    enum: AddressStatus,
    default: AddressStatus.DRAFT,
  })
  status: AddressStatus;

  /* ------------------------------------------------------------------
   * RELACIN CON CLIENTE
   * ------------------------------------------------------------------ */

  @ApiPropertyOptional({
    description: 'ID del cliente asociado a la direcci贸n (si aplica)',
    format: 'uuid',
  })
  @Column({ name: 'client_profile_id', type: 'uuid', nullable: true })
  clientProfileId?: string;

  @ManyToOne(() => ClientProfile, (cp) => cp.addresses, {
    nullable: true,
    onDelete: 'CASCADE',
  })
  @JoinColumn({ name: 'client_profile_id' })
  clientProfile?: ClientProfile;

  /* ------------------------------------------------------------------
   * TIPO DE DIRECCIN
   * ------------------------------------------------------------------ */

  @ApiProperty({
    enum: AddressType,
    description: 'Tipo de direcci贸n seg煤n su uso funcional',
    example: AddressType.FISCAL,
  })
  @Column({
    type: 'enum',
    enum: AddressType,
  })
  type: AddressType;

  /* ------------------------------------------------------------------
   * DATOS POSTALES
   * ------------------------------------------------------------------ */

  @ApiProperty({
    description: 'Direcci贸n principal (Calle, n煤mero, etc.)',
    example: 'Calle Mayor 12',
  })
  @Column({ name: 'address_line1' })
  addressLine1: string;

  @ApiPropertyOptional({
    description: 'Informaci贸n adicional de la direcci贸n (Piso, puerta, escalera)',
    example: '3潞 izquierda',
  })
  @Column({ name: 'address_line2', nullable: true })
  addressLine2?: string;

  @ApiProperty({
    description: 'C贸digo postal',
    example: '46250',
  })
  @Column({ name: 'postal_code' })
  postalCode: string;

  @ApiProperty({
    description: 'Ciudad / municipio',
    example: 'Valencia',
  })
  @Column()
  city: string;

  @ApiPropertyOptional({
    description: 'Provincia o Estado',
    example: 'Valencia',
  })
  @Column({ nullable: true })
  province?: string;

  @ApiProperty({
    description: 'C贸digo de pa铆s ISO-3166-1 alpha-2',
    example: 'ES',
    default: 'ES',
  })
  @Column({ name: 'country_code', length: 2, default: 'ES' })
  countryCode: string;

  /* ------------------------------------------------------------------
   * CONTROL DE DIRECCIN PRINCIPAL
   * ------------------------------------------------------------------ */

  @ApiProperty({
    description: 'Indica si es la direcci贸n principal para su tipo dentro de la empresa',
    example: false,
    default: false,
  })
  @Column({ name: 'is_default', default: false })
  isDefault: boolean;
}
</file>

<file path="src/app.module.ts">
import { Module } from '@nestjs/common';
import { ConfigModule } from '@nestjs/config';
import { ConfigService } from '@nestjs/config';
import { TypeOrmModule } from '@nestjs/typeorm';
import { AcceptLanguageResolver, HeaderResolver, I18nModule as NestI18nModule, QueryResolver } from 'nestjs-i18n';
import * as path from 'path';
import { SnakeNamingStrategy } from 'typeorm-naming-strategies';
import { HealthModule } from './health/health.module';
import { UserModule } from './user/user.module';
import { UserCompanyRoleModule } from './user-company-role/companyRole.module';
import { ClientProfileModule } from './client-profile/client-profile.module';
import { AuthModule } from './auth/auth.module';
import { CompanyContextModule } from './company-context/company-context.module';
import { SeederModule } from './config/seeder.module';
import { AddressModule } from './address/address.module';
import { ContactModule } from './contact/contact.module';
import { FacturaeModule } from './facturae/fiscalIdentity.module';
import { CompanyModule } from './company/company.module';
import { ClientModule } from './client/client.module';
import { PropertyModule } from './property/property.module';
import { ContractModule } from './contract/contract.module';
import { TaxModule } from './tax/tax.module';
import { BillingConceptModule } from './billing-concept/billing-concept.module';


@Module({
  imports: [
    // 1) Config primero (lee .env)
    ConfigModule.forRoot({
      isGlobal: true, //  importante para que process.env funcione en todo
    }),

    // TypeORM (PostgreSQL)
    TypeOrmModule.forRootAsync({
      inject: [ConfigService],
      useFactory: (config: ConfigService) => {
        const isProd = config.get('NODE_ENV') === 'production';
        return {
          type: 'postgres',
          host: config.get<string>('DB_HOST'),
          port: config.get<number>('DB_PORT'),
          username: config.get<string>('DB_USER'),
          password: config.get<string>('DB_PASS'),
          database: config.get<string>('DB_NAME'),
          schema: 'public',
          autoLoadEntities: true,
          synchronize: !isProd,
          logging: !isProd,
          namingStrategy: new SnakeNamingStrategy(),
          ssl: isProd ? { rejectUnauthorized: false } : false,
        };
      }
    }),

    // i18n (ES por defecto)
    NestI18nModule.forRoot({
      fallbackLanguage: 'es',
      loaderOptions: {
        path: path.join(__dirname, 'i18n'),
        watch: true,
      },
      resolvers: [
        // orden de resoluci贸n del idioma
        new QueryResolver(['lang']),
        new HeaderResolver(['x-lang', 'x-locale']),
        new AcceptLanguageResolver(),
      ],
      typesOutputPath: path.join(process.cwd(), 'src/i18n/generated-i18n-types.d.ts'),
    }),

    // Seeder
    SeederModule,

    // M贸dulos de dominio
    HealthModule,
    HealthModule,
    UserModule,
    UserCompanyRoleModule,
    CompanyModule,
    ClientProfileModule,
    AuthModule,
    CompanyContextModule,
    AddressModule,
    ContactModule,
    FacturaeModule,
    ClientModule,
    PropertyModule,
    ContractModule,
    FacturaeModule,
    TaxModule,
    BillingConceptModule,
  ],
  controllers: [],
  providers: [],
})
export class AppModule { }
</file>

<file path="src/company/company.controller.ts">
import {
  Controller,
  Get,
  Post,
  Body,
  Param,
  Patch,
  Delete,
  ParseUUIDPipe
} from '@nestjs/common';
import {
  ApiTags,
  ApiOperation,
  ApiResponse,
  ApiBearerAuth,
  ApiParam,
  ApiForbiddenResponse,
  ApiUnauthorizedResponse
} from '@nestjs/swagger';

import { CompanyService } from './company.service';
import { Company } from './entities/company.entity';
import { CreateCompanyDto, CompanyMeDto } from './dto';
import { AppRole } from 'src/auth/enums/user-global-role.enum';
import { GetUser } from 'src/auth/decorators/get-user.decorator';
import { Auth } from 'src/auth/decorators/auth.decorator';

@ApiTags('Companies')
@ApiBearerAuth()
@ApiUnauthorizedResponse({ description: 'No autorizado - Token inv谩lido o ausente' })
@ApiForbiddenResponse({ description: 'Prohibido - No tienes los permisos necesarios' })
@Controller('companies')
export class CompanyController {
  constructor(private readonly companyService: CompanyService) { }

  @Post()
  @Auth(AppRole.SUPERADMIN, AppRole.ADMIN) // Solo creadores de sistema
  @ApiOperation({
    summary: 'Crear empresa (Setup Wizard)',
    description: 'Crea la empresa vinculada a Facturae y asigna al creador como OWNER.'
  })
  @ApiResponse({ status: 201, type: Company, description: 'Empresa creada con 茅xito' })
  async create(
    @Body() createCompanyDto: CreateCompanyDto,
    @GetUser('id') userId: string,
  ) {
    return this.companyService.createCompany(createCompanyDto, userId);
  }

  @Get('me')
  @Auth() // Cualquier usuario autenticado
  @ApiOperation({
    summary: 'Mis empresas vinculadas',
    description: 'Filtra empresas por el ID del usuario extra铆do del token.'
  })
  @ApiResponse({ status: 200, type: [CompanyMeDto] })
  async getMyCompanies(@GetUser('id') userId: string) {
    return this.companyService.getCompaniesForUser(userId);
  }

  @Get()
  @Auth(AppRole.SUPERADMIN) // Listado total solo para SuperAdmin
  @ApiOperation({ summary: 'Listado global de empresas (Solo SuperAdmin)' })
  async findAll() {
    return this.companyService.findAll();
  }

  @Get(':id')
  @Auth()
  @ApiOperation({ summary: 'Obtener detalle de una empresa con validaci贸n de acceso' })
  @ApiParam({ name: 'id', description: 'UUID de la empresa' })
  @ApiResponse({ status: 200, type: Company })
  async findOne(
    @Param('id', ParseUUIDPipe) id: string,
    @GetUser('id') userId: string,
    @GetUser('appRole') appRole: AppRole, //  Corregido: antes pon铆a 'role'
  ) {
    // Si es SUPERADMIN, el service deber铆a saltarse la validaci贸n de propiedad
    return this.companyService.findOneWithAccess(id, userId, appRole);
  }

  @Patch(':id')
  @Auth() // La l贸gica de si es OWNER se valida en el Service
  @ApiOperation({ summary: 'Actualizar datos de la empresa (Requiere ser Owner o Admin Global)' })
  async update(
    @Param('id', ParseUUIDPipe) id: string,
    @Body() updateDto: any, 
    @GetUser('id') userId: string,
    @GetUser('appRole') appRole: AppRole,
  ) {
    return this.companyService.updateWithAccess(id, updateDto, userId, appRole);
  }

  @Delete(':id')
  @Auth(AppRole.SUPERADMIN, AppRole.ADMIN)
  @ApiOperation({ summary: 'Borrado l贸gico de la empresa' })
  async remove(
    @Param('id', ParseUUIDPipe) id: string,
    @GetUser('id') userId: string,
    @GetUser('appRole') appRole: AppRole,
  ) {
    return this.companyService.softDeleteWithAccess(id, userId, appRole);
  }
}
</file>

<file path="src/company/company.service.ts">
import {
  ConflictException,
  Injectable,
  NotFoundException,
  ForbiddenException,
} from '@nestjs/common';
import { DataSource, Repository } from 'typeorm';
import { InjectRepository } from '@nestjs/typeorm';

import { Company } from './entities/company.entity';
import { CreateCompanyDto, CompanyMeDto } from './dto';

import { FiscalIdentity } from 'src/facturae/entities/fiscalIdentity.entity';
import { Address } from 'src/address/entities/address.entity';
import { AddressStatus } from 'src/address/enums/addressStatus.enum';

import { CompanyRole } from 'src/user-company-role/enums/companyRole.enum';
import { AppRole } from 'src/auth/enums/user-global-role.enum';
import { CompanyRoleEntity } from 'src/user-company-role/entities/userCompanyRole.entity';

@Injectable()
export class CompanyService {
  constructor(
    @InjectRepository(Company)
    private readonly companyRepo: Repository<Company>,

    @InjectRepository(CompanyRoleEntity)
    private readonly userCompanyRoleRepo: Repository<CompanyRoleEntity>,

    private readonly dataSource: DataSource,
  ) { }

  /**
   * Crea una empresa en una transacci贸n:
   * 1. Vincula la identidad legal (FacturaeParty)
   * 2. Vincula la direcci贸n fiscal y la activa
   * 3. Crea la empresa con auditor铆a
   * 4. Asigna al creador el rol de OWNER
   */
  async createCompany(dto: CreateCompanyDto, ownerUserId: string): Promise<Company> {
    return this.dataSource.transaction(async (manager) => {
      const facturaeParty = await manager.findOne(FiscalIdentity, {
        where: { id: dto.facturaePartyId, isActive: true },
      });
      if (!facturaeParty) throw new NotFoundException('Identidad fiscal no encontrada');

      const fiscalAddress = await manager.findOne(Address, {
        where: { id: dto.fiscalAddressId, isActive: true },
      });
      if (!fiscalAddress) throw new NotFoundException('Direcci贸n fiscal no encontrada');

      if (fiscalAddress.companyId) {
        throw new ConflictException('La direcci贸n fiscal ya est谩 asociada a otra empresa');
      }

      const company = manager.create(Company, { 
        facturaeParty, 
        fiscalAddress,
        createdByUserId: ownerUserId 
      });
      await manager.save(company);

      fiscalAddress.companyId = company.id;
      fiscalAddress.status = AddressStatus.ACTIVE;
      await manager.save(fiscalAddress);

      const ownerRole = manager.create(CompanyRoleEntity, {
        user: { id: ownerUserId } as any, 
        company,
        role: CompanyRole.OWNER,
      });
      await manager.save(ownerRole);

      return company;
    });
  }

  /**
   * Retorna las empresas vinculadas al usuario para el dashboard 'Mis Empresas'
   */
  async getCompaniesForUser(userId: string): Promise<CompanyMeDto[]> {
    const relations = await this.userCompanyRoleRepo.find({
      where: { user: { id: userId } as any, isActive: true },
      relations: ['company', 'company.facturaeParty', 'company.companyRoles', 'company.companyRoles.user'],
    });

    return relations.map((r) => {
      const owner = r.company.companyRoles.find(
        (cr) => cr.role === CompanyRole.OWNER
      );

      return {
        companyId: r.company.id,
        legalName: r.company.facturaeParty?.corporateName || 
           (r.company.facturaeParty?.firstName ? `${r.company.facturaeParty.firstName} ${r.company.facturaeParty.lastName}` : 'N/A'),
        tradeName: r.company.facturaeParty?.tradeName || 'N/A',
        taxId: r.company.facturaeParty?.taxId || 'N/A',
        ownerEmail: owner?.user?.email ?? '',
        role: r.role as unknown as CompanyRole,
      };
    });
  }

  /**
   * Listado global (Solo accesible si el Guard permiti贸 el paso a SUPERADMIN)
   */
  async findAll(): Promise<Company[]> {
    return this.companyRepo.find({
      where: { isActive: true },
      relations: ['facturaeParty', 'fiscalAddress'],
      order: { createdAt: 'DESC' },
    });
  }

  /**
   * Obtiene una empresa validando si el usuario tiene permiso de verla
   */
  async findOneWithAccess(id: string, userId: string, appRole: AppRole): Promise<Company> {
    const company = await this.companyRepo.findOne({
      where: { id, isActive: true },
      relations: ['facturaeParty', 'fiscalAddress'],
    });

    if (!company) throw new NotFoundException('Empresa no encontrada');

    // SUPERADMIN ve todo por defecto
    if (appRole === AppRole.SUPERADMIN) return company;

    // Verificaci贸n de relaci贸n en la tabla de roles
    const hasAccess = await this.userCompanyRoleRepo.findOne({
      where: {
        user: { id: userId } as any,
        company: { id } as any,
        isActive: true
      }
    });

    if (!hasAccess) throw new ForbiddenException('No tienes permiso para ver esta empresa');

    return company;
  }

  /**
   * Actualiza datos validando que sea el Propietario o un Admin Global
   */
  async updateWithAccess(id: string, updateDto: any, userId: string, appRole: AppRole): Promise<Company> {
    const company = await this.findOneWithAccess(id, userId, appRole);

    if (appRole !== AppRole.SUPERADMIN) {
      const ownerRole = await this.userCompanyRoleRepo.findOne({
        where: { user: { id: userId } as any, company: { id } as any, role: CompanyRole.OWNER }
      });
      if (!ownerRole) throw new ForbiddenException('Solo el propietario (OWNER) puede editar esta empresa');
    }

    const updatedCompany = this.companyRepo.merge(company, updateDto);
    return this.companyRepo.save(updatedCompany);
  }

  /**
   * Borrado l贸gico de empresa
   */
  async softDeleteWithAccess(id: string, userId: string, appRole: AppRole): Promise<void> {
    // Validamos permisos (si puede editar, puede borrar)
    await this.updateWithAccess(id, {}, userId, appRole);

    await this.companyRepo.update(id, { 
      isActive: false, 
      deletedAt: new Date() 
    });
  }

  /**
   * Miembros de la empresa
   */
  async getCompanyMembers(companyId: string): Promise<any[]> {
    const members = await this.userCompanyRoleRepo.find({
      where: { company: { id: companyId } as any, isActive: true },
      relations: ['user'],
    });

    return members.map(m => ({
      userId: m.user.id,
      email: m.user.email,
      fullName: `${m.user.firstName || ''} ${m.user.lastName || ''}`.trim(),
      role: m.role,
      since: m.createdAt
    }));
  }
}
</file>

<file path="src/user/user.controller.ts">
import {
  Controller,
  Get,
  Post,
  Body,
  Patch,
  Param,
  Delete,
  HttpCode,
  HttpStatus,
  ParseUUIDPipe,
} from '@nestjs/common';
import {
  ApiTags,
  ApiOperation,
  ApiBearerAuth,
  ApiOkResponse,
  ApiCreatedResponse,
  ApiNoContentResponse,
  ApiUnauthorizedResponse,
  ApiForbiddenResponse,
  ApiNotFoundResponse,
} from '@nestjs/swagger';

import { UserService } from './user.service';
import { CreateUserDto } from './dto/create-user.dto';
import { UpdateUserDto } from './dto/update-user.dto';
import { UserDto } from './dto/user.dto';
import { MeDto } from './dto/me.dto';

import { GetUser } from 'src/auth/decorators/get-user.decorator';
import { AppRole } from 'src/auth/enums/user-global-role.enum';
import { Auth } from 'src/auth/decorators/auth.decorator';

@ApiTags('Users') // Est谩ndar plural
@ApiBearerAuth()
@ApiUnauthorizedResponse({ description: 'No autenticado' })
@ApiForbiddenResponse({ description: 'Sin permisos suficientes' })
@Controller('users') // Est谩ndar plural
export class UserController {
  constructor(private readonly userService: UserService) {}

  @Post()
  @Auth(AppRole.SUPERADMIN, AppRole.ADMIN)
  @ApiOperation({ summary: 'Crear un nuevo usuario (Solo Admin/SuperAdmin)' })
  @ApiCreatedResponse({ description: 'Usuario creado correctamente', type: UserDto })
  create(@Body() dto: CreateUserDto): Promise<UserDto> {
    return this.userService.create(dto);
  }

  @Get()
  @Auth(AppRole.SUPERADMIN) // Solo el due帽o del sistema lista a todos
  @ApiOperation({ summary: 'Listar todos los usuarios activos (Solo SuperAdmin)' })
  @ApiOkResponse({ description: 'Listado de usuarios', type: [UserDto] })
  findAll(): Promise<UserDto[]> {
    return this.userService.findAll();
  }

  @Get('me')
  @Auth() // Cualquier usuario autenticado puede ver sus datos
  @ApiOperation({ summary: 'Obtener datos del usuario logueado' })
  @ApiOkResponse({ description: 'Datos del usuario autenticado', type: MeDto })
  getMe(@GetUser('id') userId: string): Promise<MeDto> {
    // Usamos el ID del token para buscar en DB y devolver el DTO completo
    return this.userService.findMe(userId);
  }

  @Get(':id')
  @Auth(AppRole.SUPERADMIN, AppRole.ADMIN)
  @ApiOperation({ summary: 'Obtener un usuario por ID' })
  @ApiOkResponse({ description: 'Usuario encontrado', type: UserDto })
  @ApiNotFoundResponse({ description: 'Usuario no encontrado' })
  findOne(@Param('id', ParseUUIDPipe) id: string): Promise<UserDto> {
    return this.userService.findOne(id);
  }

  @Patch(':id')
  @Auth(AppRole.SUPERADMIN)
  @ApiOperation({ summary: 'Actualizar un usuario' })
  @ApiOkResponse({ description: 'Usuario actualizado', type: UserDto })
  update(
    @Param('id', ParseUUIDPipe) id: string,
    @Body() dto: UpdateUserDto,
  ): Promise<UserDto> {
    return this.userService.update(id, dto);
  }

  @Delete(':id')
  @Auth(AppRole.SUPERADMIN)
  @HttpCode(HttpStatus.NO_CONTENT)
  @ApiOperation({ summary: 'Desactivar un usuario (soft delete)' })
  @ApiNoContentResponse({ description: 'Usuario desactivado correctamente' })
  remove(@Param('id', ParseUUIDPipe) id: string): Promise<void> {
    return this.userService.remove(id);
  }
}
</file>

<file path="src/user/user.service.ts">
import { Injectable, NotFoundException } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import * as bcrypt from 'bcrypt';

import { User } from './entities/user.entity';
import { CreateUserDto } from './dto/create-user.dto';
import { UpdateUserDto } from './dto/update-user.dto';
import { UserDto } from './dto/user.dto';
import { MeDto } from './dto/me.dto';

@Injectable()
export class UserService {
  constructor(
    @InjectRepository(User)
    private readonly userRepository: Repository<User>,
  ) {}

  /* ------------------------------------------------------------------
   * MAPPERS (Privados)
   * ------------------------------------------------------------------ */

  private toDto(user: User): UserDto {
    return {
      id: user.id,
      email: user.email,
      firstName: user.firstName, // Incluimos campos de perfil
      lastName: user.lastName,
      appRole: user.appRole,     // Nombre unificado
      isActive: user.isActive,
      createdAt: user.createdAt,
      updatedAt: user.updatedAt,
    };
  }

  /* ------------------------------------------------------------------
   * CRUD
   * ------------------------------------------------------------------ */

  async create(dto: CreateUserDto): Promise<UserDto> {
    const hashedPassword = await bcrypt.hash(dto.password, 10);
    const user = this.userRepository.create({
      ...dto,
      password: hashedPassword,
    });
    const saved = await this.userRepository.save(user);
    return this.toDto(saved);
  }

  async findAll(): Promise<UserDto[]> {
    const users = await this.userRepository.find({
      where: { isActive: true },
    });
    return users.map((u) => this.toDto(u));
  }

  async findOne(id: string): Promise<UserDto> {
    const user = await this.userRepository.findOne({
      where: { id, isActive: true },
      relations: ['companyRoles', 'companyRoles.company'],
    });

    if (!user) throw new NotFoundException(`Usuario con id ${id} no encontrado`);
    return this.toDto(user);
  }

  async update(id: string, dto: UpdateUserDto): Promise<UserDto> {
    const user = await this.userRepository.findOne({ where: { id, isActive: true } });
    if (!user) throw new NotFoundException(`Usuario con id ${id} no encontrado`);

    if (dto.password) {
      dto.password = await bcrypt.hash(dto.password, 10);
    }

    Object.assign(user, dto);
    const updated = await this.userRepository.save(user);
    return this.toDto(updated);
  }

  async remove(id: string): Promise<void> {
    const user = await this.userRepository.findOne({ where: { id } });
    if (!user) throw new NotFoundException(`Usuario con id ${id} no encontrado`);
    
    user.isActive = false;
    await this.userRepository.save(user);
  }

  /* ------------------------------------------------------------------
   * AUTH HELPERS (Uso de QueryBuilder para campos ocultos)
   * ------------------------------------------------------------------ */

  async findByEmail(email: string): Promise<User | null> {
    return this.userRepository.createQueryBuilder('user')
      .addSelect('user.password')
      .where('user.email = :email', { email })
      .getOne();
  }

  async findById(id: string): Promise<User | null> {
    return this.userRepository.createQueryBuilder('user')
      .addSelect('user.refreshTokenHash') //  Vital para el refresh token
      .where('user.id = :id', { id })
      .getOne();
  }

  async updateRefreshToken(id: string, hash: string | null): Promise<void> {
    await this.userRepository.update(id, { refreshTokenHash: hash });
  }

  /* ------------------------------------------------------------------
   * GET ME (Perfil completo para el Front)
   * ------------------------------------------------------------------ */

  async findMe(userId: string): Promise<MeDto> {
    const user = await this.userRepository.findOne({
      where: { id: userId, isActive: true },
      relations: [
        'companyRoles',
        'companyRoles.company',
        'companyRoles.company.facturaeParty',
      ],
    });

    if (!user) throw new NotFoundException('Usuario no encontrado');

    return {
      id: user.id,
      email: user.email,
      firstName: user.firstName,
      lastName: user.lastName,
      appRole: user.appRole, // Usamos appRole consistentemente
      isActive: user.isActive,
      createdAt: user.createdAt,
      updatedAt: user.updatedAt,
      companyRoles: user.companyRoles?.map((cr) => ({
        companyId: cr.company.id,
        companyName: cr.company.facturaeParty?.corporateName || 
             (cr.company.facturaeParty?.firstName ? `${cr.company.facturaeParty.firstName} ${cr.company.facturaeParty.lastName}` : 'Empresa sin nombre'),
        role: cr.role,
      })) || [],
    };
  }
}
</file>

<file path="src/user/entities/user.entity.ts">
import { Entity, Column, OneToMany } from 'typeorm';
import { ApiProperty, ApiPropertyOptional } from '@nestjs/swagger';

import { BaseEntity } from 'src/common/base/base.entity';
import { AppRole } from 'src/auth/enums/user-global-role.enum';
import { CompanyRoleEntity } from 'src/user-company-role/entities/userCompanyRole.entity';
import { ClientProfile } from 'src/client-profile/entities/client-profile.entity';

@Entity('users')
export class User extends BaseEntity {

  @ApiProperty({
    description: 'Correo electr贸nico 煤nico del usuario',
    example: 'admin@rentix.com',
  })
  @Column({ unique: true })
  email: string;

  @ApiProperty({ description: 'Contrase帽a (Hashed)', writeOnly: true })
  @Column({ select: false }) // No se devuelve en los GET por seguridad
  password: string;

  /* ------------------------------------------------------------------
   * DATOS PERSONALES (Sincronizados con el Setup Wizard)
   * ------------------------------------------------------------------ */

  @ApiPropertyOptional({ description: 'Nombre', example: 'Carlos' })
  @Column({ name: 'first_name', nullable: true })
  firstName?: string;

  @ApiPropertyOptional({ description: 'Apellidos', example: 'Sanz' })
  @Column({ name: 'last_name', nullable: true })
  lastName?: string;

  @ApiPropertyOptional({ description: 'Tel茅fono', example: '+34600112233' })
  @Column({ nullable: true })
  phone?: string;

  @ApiPropertyOptional({ description: 'URL de la foto de perfil' })
  @Column({ name: 'avatar_url', nullable: true })
  avatarUrl?: string;

  /* ------------------------------------------------------------------
   * ROL GLOBAL (Aplicaci贸n)
   * ------------------------------------------------------------------ */

  @ApiProperty({
    description: 'Rol global del usuario (SUPERADMIN, ADMIN, USER)',
    enum: AppRole,
    default: AppRole.USER,
  })
  @Column({
    name: 'app_role',
    type: 'enum',
    enum: AppRole,
    default: AppRole.USER,
  })
  appRole: AppRole;

  @ApiProperty({ description: 'Estado de verificaci贸n del email' })
  @Column({ name: 'is_email_verified', default: false })
  isEmailVerified: boolean;

  @Column({
    name: 'refresh_token_hash',
    type: 'varchar',
    nullable: true,
    select: false, //  Seguridad: evita que el hash viaje en los JSON
  })
  refreshTokenHash?: string | null;

  /* ------------------------------------------------------------------
   * RELACIONES (Jerarqu铆a de Empresa)
   * ------------------------------------------------------------------ */

  @ApiPropertyOptional({
    description: 'Roles del usuario en diferentes empresas (OWNER, CLIENT, etc.)',
    //  FIX CRTICO: Funci贸n flecha + Array para evitar ciclo infinito
    type: () => [CompanyRoleEntity], 
  })
  @OneToMany(() => CompanyRoleEntity, (ucr) => ucr.user)
  companyRoles: CompanyRoleEntity[];

  @ApiPropertyOptional({ 
    description: 'Perfiles de cliente asociados a este usuario',
    //  FIX CRTICO: Funci贸n flecha + Array. Faltaba aqu铆.
    type: () => [ClientProfile] 
  })
  @OneToMany(() => ClientProfile, (cp) => cp.user)
  clientProfiles: ClientProfile[];
}
</file>

<file path="src/company/entities/company.entity.ts">
import {
  Entity,
  Column,
  OneToMany,
  OneToOne,
  ManyToOne,
  JoinColumn,
} from 'typeorm';
import { ApiProperty, ApiPropertyOptional } from '@nestjs/swagger';

import { BaseEntity } from 'src/common/base/base.entity';
import { FiscalIdentity } from 'src/facturae/entities/fiscalIdentity.entity';
import { Address } from 'src/address/entities/address.entity';
// import { CompanyRole } from 'src/user-company-role/enums/companyRole.enum'; // (Parece no usarse aqu铆 directamente)
import { User } from 'src/user/entities/user.entity';
import { CompanyRoleEntity } from 'src/user-company-role/entities/userCompanyRole.entity';
//  1. IMPORTAR CLIENT PROFILE
import { ClientProfile } from 'src/client-profile/entities/client-profile.entity';
import { Property } from 'src/property/entities/property.entity';

@Entity('companies')
export class Company extends BaseEntity {

  /* ------------------------------------------------------------------
   * IDENTIDAD FISCAL
   * ------------------------------------------------------------------ */

  @ApiProperty({
    description: 'UUID de la identidad fiscal (FacturaeParty)',
    format: 'uuid',
    example: '9f8b4d1e-1a2b-4d9e-b9a2-123456789abc',
  })
  @Column({ name: 'facturae_party_id', type: 'uuid' })
  facturaePartyId: string;

  @ApiProperty({
    description: 'Entidad fiscal asociada a la empresa',
    type: () => FiscalIdentity,
  })
  @OneToOne(() => FiscalIdentity, { eager: true })
  @JoinColumn({ name: 'facturae_party_id' })
  facturaeParty: FiscalIdentity;

  /* ------------------------------------------------------------------
   * DIRECCIN FISCAL
   * ------------------------------------------------------------------ */

  @ApiPropertyOptional({
    description: 'UUID de la direcci贸n fiscal asociada',
    format: 'uuid',
    example: '1a2b3c4d-aaaa-bbbb-cccc-123456789abc',
  })
  @Column({
    name: 'fiscal_address_id',
    type: 'uuid',
    nullable: true,
  })
  fiscalAddressId?: string;

  @ApiPropertyOptional({
    description: 'Direcci贸n fiscal de la empresa',
    type: () => Address,
  })
  @OneToOne(() => Address, { nullable: true })
  @JoinColumn({ name: 'fiscal_address_id' })
  fiscalAddress?: Address;

  /* ------------------------------------------------------------------
   * AUDITORA
   * ------------------------------------------------------------------ */

  @ApiPropertyOptional({
    description: 'Usuario que cre贸 la empresa (auditor铆a interna)',
    format: 'uuid',
    example: '7b5c9f0a-1111-2222-3333-abcdefabcdef',
  })
  @Column({
    name: 'created_by_user_id',
    type: 'uuid',
    nullable: true,
  })
  createdByUserId?: string;

  @ApiPropertyOptional({
    description: 'Usuario creador de la empresa (solo auditor铆a)',
    type: () => User,
  })
  @ManyToOne(() => User, { nullable: true })
  @JoinColumn({ name: 'created_by_user_id' })
  createdBy?: User;

  /* ------------------------------------------------------------------
   * ROLES POR EMPRESA
   * ------------------------------------------------------------------ */

  @ApiProperty({
    description: 'Roles de usuarios dentro de la empresa',
    type: () => [CompanyRoleEntity],
    isArray: true,
  })
  @OneToMany(
    () => CompanyRoleEntity,
    (ucr) => ucr.company,
  )
  companyRoles: CompanyRoleEntity[];

  /* 
   *  PROPIEDADES (RELACIN 1:N)
   * Una empresa (Tenant) posee m煤ltiples propiedades (Assets).
   *  */
  
  @ApiPropertyOptional({ 
    description: 'Inventario de propiedades pertenecientes a esta empresa.',
    type: () => [Property] //  Importante: Array de propiedades (lazy resolve)
  })
  @OneToMany(() => Property, (property) => property.company, {
    // cascade: true, // Descomentar si quieres crear Propiedades al crear la Empresa (poco com煤n en este flujo)
    eager: false,     //  PERFORMANCE: False para no cargar las 500 propiedades cada vez que consultes el perfil de la empresa.
  })
  properties: Property[];



  /* ------------------------------------------------------------------
   * CRM: CLIENTES
   * ------------------------------------------------------------------ */
  //  2. AADIR LA RELACIN CON LAZY LOAD PARA SWAGGER
  @ApiPropertyOptional({
    description: 'Cartera de clientes de la empresa',
    type: () => [ClientProfile], // Funci贸n flecha evita el error circular
  })
  @OneToMany(() => ClientProfile, (client) => client.company)
  clientProfiles: ClientProfile[];
}
</file>

</files>
